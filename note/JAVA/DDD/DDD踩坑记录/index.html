<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>DDD踩坑记录 | 张三的个人电脑</title><meta name="author" content="zs"><meta name="copyright" content="zs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="DDD踩坑记录关于gateway的定位这么一个场景：如果我们有多个领域，比如领域A和领域B，这两个领域都需要调用 同一个远程服务gateway 获取一些数据；那么这个gateway怎么处理？  是每一个领域下有一个单独的gateway？ 是把gateway抽离出来，由多个领域都可以进行调用（那么这个gateway所在的领域是个什么定位呢）？  个人理解： 正常来说，按照COLA的架构，是每一个do">
<meta property="og:type" content="article">
<meta property="og:title" content="DDD踩坑记录">
<meta property="og:url" content="https://zhuansunpengcheng.gitee.io/note/JAVA/DDD/DDD%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="张三的个人电脑">
<meta property="og:description" content="DDD踩坑记录关于gateway的定位这么一个场景：如果我们有多个领域，比如领域A和领域B，这两个领域都需要调用 同一个远程服务gateway 获取一些数据；那么这个gateway怎么处理？  是每一个领域下有一个单独的gateway？ 是把gateway抽离出来，由多个领域都可以进行调用（那么这个gateway所在的领域是个什么定位呢）？  个人理解： 正常来说，按照COLA的架构，是每一个do">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://smms.app/image/JCPQ9ogz7USpYlb">
<meta property="article:published_time" content="2022-10-31T10:57:46.432Z">
<meta property="article:modified_time" content="2022-10-31T10:57:46.432Z">
<meta property="article:author" content="zs">
<meta property="article:tag" content="DDD">
<meta property="article:tag" content="领域驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://smms.app/image/JCPQ9ogz7USpYlb"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansunpengcheng.gitee.io/note/JAVA/DDD/DDD%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'DDD踩坑记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-31 10:57:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="张三的个人电脑" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">37</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">53</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://smms.app/image/JCPQ9ogz7USpYlb')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">张三的个人电脑</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">DDD踩坑记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-31T10:57:46.432Z" title="发表于 2022-10-31 10:57:46">2022-10-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-31T10:57:46.432Z" title="更新于 2022-10-31 10:57:46">2022-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/">JAVA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/DDD/">DDD</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="DDD踩坑记录"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="DDD踩坑记录"><a href="#DDD踩坑记录" class="headerlink" title="DDD踩坑记录"></a>DDD踩坑记录</h1><h2 id="关于gateway的定位"><a href="#关于gateway的定位" class="headerlink" title="关于gateway的定位"></a>关于gateway的定位</h2><p>这么一个场景：如果我们有多个领域，比如领域A和领域B，这两个领域都需要调用 同一个远程服务gateway 获取一些数据；那么这个gateway怎么处理？</p>
<ul>
<li>是每一个领域下有一个单独的gateway？</li>
<li>是把gateway抽离出来，由多个领域都可以进行调用（那么这个gateway所在的领域是个什么定位呢）？</li>
</ul>
<p>个人理解：</p>
<p>正常来说，按照COLA的架构，是每一个domain（每一个领域）有自己单独的gateway；但是从实际的开发角度来看，每一个领域有自己的gateway比较难以维护，因为如果多个领域调用同一个gateway，相当于这个gateway我要复制一份。</p>
<p>所以，综上考虑：还是选择第二种方案；就是抽离一个公共的model层，所有的gateway放在这里，有点类似于通用子域的概念；所有的领域都可以自由的调用model中的gateway；</p>
<p>（但是，从DDD的角度来说，还是每一个领域都有一个单独的gateway更合理一些）</p>
<h2 id="查询条件太多，领域层入参怎么设计"><a href="#查询条件太多，领域层入参怎么设计" class="headerlink" title="查询条件太多，领域层入参怎么设计"></a>查询条件太多，领域层入参怎么设计</h2><p>这么一个场景：假设我们有申请单域，用户需求需要根据：申请时间起止+申请人+审批人+审批状态+···完成时间起止等很多的查询条件，查询出申请单列表；那么这个时候domainSerview的入参就得是好多好多。</p>
<p>纠结的点在于：如果我们这些查询条件封装成一个SO，传入domainSerview，但是这个SO和我的申请单域没有任何的关系；如果我把这些参数打平传进domainSerview，又太多了；怎么办呢？</p>
<p>结论先行：</p>
<ul>
<li>封装成SO传入领域层；</li>
</ul>
<p>为什么这么做？ 因为我们考虑到代码的可读性，不建议方法有大量的入参，那么至于SO和我的领域有没有关系，其实我觉得不重要，因为DDD的基本概念是领域建模，唯一的要求就是：领域内是干净的。不要和其他的领域耦合在一起。基于这个点考虑，领域内部创建一些无意义的值对象（SO可以看做是值对象），我认为是可以的，因为这些值对象方便了领域内的处理。同时领域对外暴露的命令：查询命令；</p>
<p>另外，如果有一些简单的查询，比如查询某个申请人的所有申请单，我们可以针对这个查询，在领域内单独抽出一个方法；</p>
<ul>
<li>searchBySO</li>
<li>searchByApplier</li>
</ul>
<h2 id="一个领域怎么引用另一个领域？"><a href="#一个领域怎么引用另一个领域？" class="headerlink" title="一个领域怎么引用另一个领域？"></a>一个领域怎么引用另一个领域？</h2><p>比如说：domainService的入参可以是其他领域的聚合吗？在domainService内部可以调用另一个领域的服务呢？ </p>
<ul>
<li>不可以；</li>
<li>不可以；</li>
</ul>
<p>如果一个领域A需要用到另一个领域B的对象的话，就把领域B的对象转成领域A中的对象；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//根据userid和权限id获取用户权限</span>
<span class="token class-name">User</span> user <span class="token operator">=</span> userDomainService<span class="token punctuation">.</span><span class="token function">getUserPointPrivilegeChildrens</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">getPermissionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将user权限转成指标维度</span>
<span class="token class-name">Dimension</span> dimension <span class="token operator">=</span> <span class="token class-name">MetricAppFactory</span><span class="token punctuation">.</span><span class="token function">userPrivilegeToDimension</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//调用指标域（因为User是用户域的，不能直接传给指标域，所以做一层转黄）</span>
<span class="token class-name">Metric</span> metrics <span class="token operator">=</span> metricDomainService<span class="token punctuation">.</span><span class="token function">inTimeOrder</span><span class="token punctuation">(</span>dimension<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个转换，需要是有意义的；比如上面的代码，将用户的权限转成了指标维度，这个转换并不是随便转的，因为每一个指标都会有一个维度的概念。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Metric</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 指标维度
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Dimension</span> dimension<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 首页指标:  订单量，入网量，签收量，，等等，所以是一个list
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">MetricIndex</span> metricIndex<span class="token punctuation">;</span>

    <span class="token comment">/**
     *  实时数据： 订单量，入网量，等指标vo
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">MetricInTime</span> inTime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 历史数据：
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">MetricHistory</span> history<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么在domainService内部，可以调用另一个domainService吗？（换言之，一个领域服务怎么调用另一个领域服务）</p>
<img src="DDD踩坑记录.assets/image-20220902161603846.png" alt="image-20220902161603846" style="zoom:80%;" />



<p>在cola架构中，domain层中是有防腐层的概念的，</p>
<ul>
<li>防腐层的包一般命名为acl</li>
<li>防腐层的类一般命名为XXXGateWay（通过依赖倒置原则，实现在基础设施层）</li>
</ul>
<p>通过上面的概念，就可以理解，在一个领域中，一个领域服务调用另一个领域服务必须通过防腐层GateWay来调用，那么随之而来的几个问题：</p>
<ul>
<li>1、如果需要调用的领域服务是本项目中其他领域的服务，也需要gateway吗？<ul>
<li>是的。也需要，把本项目中其他领域的服务当做远程服务一样来调用；</li>
</ul>
</li>
<li>2、如果本项目中有两个领域服务，需要调用远程同一个服务，gateway是在这两个领域服务下，每个领域服务中都创建一个gateway吗？即使这两个gateway代码完全一样？<ul>
<li>是的，每个领域服务都需要创建GateWay，即使两个代码完全一样。</li>
</ul>
</li>
</ul>
<h2 id="DO转PO的时候，是否需要填充所有的参数？"><a href="#DO转PO的时候，是否需要填充所有的参数？" class="headerlink" title="DO转PO的时候，是否需要填充所有的参数？"></a>DO转PO的时候，是否需要填充所有的参数？</h2><p>比如说，数据库中只存了站点id，但是实际的业务逻辑中，需要用到站点类型，在DO中存的是Site这个实体，那么在从PO到DO的过程中，也就是siteId到Site的过程中，是否需要通过SiteId获取Site的所有数据，然后放在DO中，还是说，只需要把siteId放在Site中，就可以了。<br>答案：需要获取所有的。1、获取PO对象；2、通过Factory一次性填充DO所有需要的属性。</p>
<h2 id="领域服务-Domain-Service-的定位"><a href="#领域服务-Domain-Service-的定位" class="headerlink" title="领域服务(Domain Service)的定位"></a>领域服务(Domain Service)的定位</h2><blockquote>
<p>  结论先行：领域服务的入参不必限制为必须是当前领域的聚合根；可以是多种多样的。</p>
</blockquote>
<p>之前讨论领域服务是领域层很重要的概念，主要用来写业务逻辑，入参只能使用聚合根；目前来看，这种方式是错误的。比如下面的场景：在进出港业务中：是根据各种各样的扫描（分拨发件，到件，派件，签收，退件，转寄等），采集进港属性（应派信息，签收信息，分拨信息等）；那么就有下面两种方式：</p>
<ul>
<li>目前的做法：将扫描放在进港域的聚合根(Inboard)中，进港的聚合根中包含了大量的扫描信息；</li>
</ul>
<p>这样做的目的是为了保证进港的领域服务(InboardDomainService)的入参只能是进港聚合根(Inboard)，但是为了满足这个目的，缺引入了很多的缺点：</p>
<ul>
<li>聚合根中引入了大量的无用扫描：为什么说是无用，因为进港聚合中只需要应派信息，签收信息，分拨信息，可是现在却不得不保存大量的扫描（退件，转寄，入库入柜等）；</li>
<li>各种各样的扫描进入到领域服务(inboardDomainServie)之后，还要再拆分，根据不同的扫描类型，进行不同的业务逻辑处理；代码庞大难以维护；</li>
<li>瞻仰一下目前的代码逻辑：这仅仅只是一部分而已</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 设置应派信息：
 * - 应派时间
 * - 应派站点
 *
 * @param inboard    : 前端传过来的
 * @param preInboard : 数据库中的
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillDispInfo</span><span class="token punctuation">(</span><span class="token class-name">Inboard</span> inboard<span class="token punctuation">,</span> <span class="token class-name">Inboard</span> preInboard<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">DispInfo</span> dispInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">SignInfo</span> signInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">SendInfo</span> sendInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"fillDispInfo inboard:&#123;&#125;, preInboard:&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>inboard<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//取签收站点作为应派站点</span>
            dispInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">DispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//省略...设置了应派站点，应派站点的扫描事件，应派站点的结算站点 应派日期后面计算</span>

        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>
            preInboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//取最早的签收， 最晚签收时间后面在计算, 签收时间是取最早的。</span>
            signInfo <span class="token operator">=</span> inboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">isHasCenterScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//之前过分拨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//当前扫描是发件扫描</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEndCenterSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//分拨发件，并且下一站是站点， 主要是排除分拨发分拨的情况</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>
                    inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//省略...设置应派信息：发件扫描，下一站是站点，就取下一站</span>
                  
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                    <span class="token operator">||</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">,</span>preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenterSendTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//分拨发件信息，取当前最新的</span>
                    sendInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                        <span class="token keyword">new</span> <span class="token class-name">SendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                        inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//分拨发站点：采集分拨</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenterSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">//发件站点是分拨</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">//发件站点是一级站点</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenterSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token comment">//处理一级发二级的情况，分拨还是原来的。</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//过了分拨，但不是发件扫描，可能是到件，派件，转寄,退件等等,取当前扫描站点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">hasArrInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inboard<span class="token punctuation">.</span><span class="token function">isHasCenterScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//如果当前是分拨到件扫描，取消应派站点的采集</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                   <span class="token comment">//....</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">hasReturnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>
                inboard<span class="token punctuation">.</span><span class="token function">getReturnInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isHasReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//退件也清空</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//....</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>
                <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getCurrentScanInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>
                    inboard<span class="token punctuation">.</span><span class="token function">getCurrentScanInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//过了分拨，但不是发件扫描，可能是到件，派件，转寄等等,取当前扫描站点</span>
                <span class="token comment">//....</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">isHasCenterScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//当前过分拨</span>
        preInboard<span class="token punctuation">.</span><span class="token function">setHasCenterScan</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">isEndCenterSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//当前扫描是分拨发件扫描</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>
                inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenterSendTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//分拨发件信息，取当前最新的</span>
                <span class="token comment">//....</span>
                <span class="token comment">//这里不会有丰网一级发二级的情况需要处理</span>
                <span class="token comment">//因为当前过分拨（不会是丰网一级，只有丰网分拨，和大网网点才是当前过分拨）</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>preInboard<span class="token punctuation">.</span><span class="token function">hasDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">dataAfter</span><span class="token punctuation">(</span>
                inboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//派件信息：取下一站</span>
                <span class="token comment">//....</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>dispInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//填充丰网应派</span>
        dispInfo<span class="token punctuation">.</span><span class="token function">setFwDisp</span><span class="token punctuation">(</span>dispInfo<span class="token punctuation">.</span><span class="token function">getScanSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFwSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        preInboard<span class="token punctuation">.</span><span class="token function">setDispInfo</span><span class="token punctuation">(</span>dispInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>sendInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        preInboard<span class="token punctuation">.</span><span class="token function">setSendInfo</span><span class="token punctuation">(</span>sendInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>signInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        preInboard<span class="token punctuation">.</span><span class="token function">setSignInfo</span><span class="token punctuation">(</span>signInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"计算应派日期前的inboard code &#123;&#125; inboard &#123;&#125;"</span><span class="token punctuation">,</span>inboard<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>inboard<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//计算应派日期+最晚签收时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">//这里的逻辑都是简化后的</span>
        <span class="token class-name">String</span> centerSiteCode <span class="token operator">=</span> preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenterSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSfCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> dispSiteCode <span class="token operator">=</span> preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> centerSendTime <span class="token operator">=</span> preInboard<span class="token punctuation">.</span><span class="token function">getSendInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCenterSendTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNoneBlank</span><span class="token punctuation">(</span>centerSiteCode<span class="token punctuation">,</span> dispSiteCode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>centerSendTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SiteShixiaoPO</span><span class="token punctuation">></span></span> shixiaoPOList <span class="token operator">=</span> <span class="token comment">//获取时效配置</span>

            <span class="token comment">//应派时间+最晚签收时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>shixiaoPOList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">fillOutDispAndLatestSignTime</span><span class="token punctuation">(</span>shixiaoPOList<span class="token punctuation">,</span> preInboard<span class="token punctuation">,</span>centerSendTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//没有时效配置，要清空硬派日期和最晚签收日期</span>
                preInboard<span class="token punctuation">.</span><span class="token function">getDispInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDispTime</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>preInboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    preInboard<span class="token punctuation">.</span><span class="token function">getSignInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLatestSignTime</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的代码复杂并且难以维护，在重构的过程中，分析出，这种思路（指的是domainService的入参必须是领域的聚合根(Inboard)）应该是错误的；</p>
<p>然后去找理论支撑，在《中台架构与实现》P177看到对领域服务的定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">如果一个业务行为由多个实体对象参与完成，我们就将这部分业务逻辑放在领域服务中实现；
领域服务与实体方法的主要区别是：实体方法完成单一实体自身的业务逻辑，是相对简单的原子业务逻辑；而领域服务则是由多个实体组合的相对复杂的业务逻辑。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>简单的说，我们之前理解的业务逻辑写在领域服务中，是比较片面的，因为业务逻辑的实现，是可以在实体中，和领域服务中；</p>
<ul>
<li>业务逻辑<ul>
<li>在实体中实现</li>
<li>在领域服务中实现</li>
</ul>
</li>
</ul>
<p>总结下来：领域服务的入参不必限制为必须是当前领域的聚合根；可以是多种多样的。有一个限制就是：在实体方法和领域服务中，避免直接调用其他聚合的领域服务或者直接应用其他聚合的实体和值对象（不要增加耦合）；但是并不是说不让引用，而是通过正确的方式引用（通过唯一标识，引用其他聚合）。</p>
<p>最后，我采用的比较靠谱的方案是：入参使用“唯一标识”，这里的唯一标识加了引号，意思是说：不一定是唯一标识，但是一定是简单类型。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//只有code和入网时间</span>
<span class="token class-name">Inboard</span> inboard <span class="token operator">=</span> <span class="token class-name">InboardAppFactory</span><span class="token punctuation">.</span><span class="token function">toInboard</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//当前扫描站点，分拨下一站，扫描时间，扫描类型（内部）</span>
<span class="token keyword">long</span> scanSiteId <span class="token operator">=</span> <span class="token class-name">InboardAppFactory</span><span class="token punctuation">.</span><span class="token function">toScanSiteId</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> nextSiteId <span class="token operator">=</span> <span class="token class-name">InboardAppFactory</span><span class="token punctuation">.</span><span class="token function">toNextSiteId</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> scanTime <span class="token operator">=</span> <span class="token class-name">InboardAppFactory</span><span class="token punctuation">.</span><span class="token function">toScanTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token class-name">InboardInnerScanTypeEnum</span> inboardInnerScanTypeEnum <span class="token operator">=</span> <span class="token class-name">InboardAppFactory</span><span class="token punctuation">.</span><span class="token function">toInnerScanType</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getScanDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScanTypeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创建或者更新进港单(入参使用简单类型)</span>
<span class="token class-name">Inboard</span> afterInboard <span class="token operator">=</span> inboardDomainService<span class="token punctuation">.</span><span class="token function">processScanMsg</span><span class="token punctuation">(</span>inboard<span class="token punctuation">,</span>scanSiteId<span class="token punctuation">,</span>nextSiteId<span class="token punctuation">,</span>scanTime<span class="token punctuation">,</span>inboardInnerScanTypeEnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/DDD/">DDD</a><a class="post-meta__tags" href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8/">领域驱动</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zs</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">37</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">53</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DDD%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">DDD踩坑记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Egateway%E7%9A%84%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.1.</span> <span class="toc-text">关于gateway的定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%E5%A4%AA%E5%A4%9A%EF%BC%8C%E9%A2%86%E5%9F%9F%E5%B1%82%E5%85%A5%E5%8F%82%E6%80%8E%E4%B9%88%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">查询条件太多，领域层入参怎么设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E9%A2%86%E5%9F%9F%E6%80%8E%E4%B9%88%E5%BC%95%E7%94%A8%E5%8F%A6%E4%B8%80%E4%B8%AA%E9%A2%86%E5%9F%9F%EF%BC%9F"><span class="toc-number">1.3.</span> <span class="toc-text">一个领域怎么引用另一个领域？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DO%E8%BD%ACPO%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%A1%AB%E5%85%85%E6%89%80%E6%9C%89%E7%9A%84%E5%8F%82%E6%95%B0%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">DO转PO的时候，是否需要填充所有的参数？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%86%E5%9F%9F%E6%9C%8D%E5%8A%A1-Domain-Service-%E7%9A%84%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.5.</span> <span class="toc-text">领域服务(Domain Service)的定位</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By zs</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.13.8/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>