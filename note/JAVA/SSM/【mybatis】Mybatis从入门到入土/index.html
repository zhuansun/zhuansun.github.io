<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>【mybatis】mybatis从入门到入土 | CCWorld</title><meta name="author" content="张三"><meta name="copyright" content="张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1 环境准备1.1 下载源码导入IDEA先下载这三个项目：我是fork到自己仓库了，也可以从mybatis官方仓库下载：https:&#x2F;&#x2F;github.com&#x2F;mybatis  https:&#x2F;&#x2F;github.com&#x2F;zhuansun&#x2F;mybatis-3   https:&#x2F;&#x2F;github.com&#x2F;zhuansun&#x2F;spring   https:&#x2F;&#x2F;github.com&#x2F;zhuansun&#x2F;parent">
<meta property="og:type" content="article">
<meta property="og:title" content="【mybatis】mybatis从入门到入土">
<meta property="og:url" content="https://zhuansun.github.io/note/JAVA/SSM/%E3%80%90mybatis%E3%80%91Mybatis%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/index.html">
<meta property="og:site_name" content="CCWorld">
<meta property="og:description" content="1 环境准备1.1 下载源码导入IDEA先下载这三个项目：我是fork到自己仓库了，也可以从mybatis官方仓库下载：https:&#x2F;&#x2F;github.com&#x2F;mybatis  https:&#x2F;&#x2F;github.com&#x2F;zhuansun&#x2F;mybatis-3   https:&#x2F;&#x2F;github.com&#x2F;zhuansun&#x2F;spring   https:&#x2F;&#x2F;github.com&#x2F;zhuansun&#x2F;parent">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/10/31/Ds1pc4HTNxezk2r.jpg">
<meta property="article:published_time" content="2022-10-31T18:37:15.000Z">
<meta property="article:modified_time" content="2023-06-01T10:14:17.621Z">
<meta property="article:author" content="张三">
<meta property="article:tag" content="mybatis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/10/31/Ds1pc4HTNxezk2r.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/note/JAVA/SSM/%E3%80%90mybatis%E3%80%91Mybatis%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【mybatis】mybatis从入门到入土',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-01 10:14:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="CCWorld" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">139</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/10/31/Ds1pc4HTNxezk2r.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">CCWorld</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【mybatis】mybatis从入门到入土</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2022-10-31T18:37:15.000Z" title="发表于 2022-10-31 18:37:15">2022-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/">JAVA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/SSM/">SSM</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1 环境准备"></a>1 环境准备</h1><h2 id="1-1-下载源码导入IDEA"><a href="#1-1-下载源码导入IDEA" class="headerlink" title="1.1 下载源码导入IDEA"></a>1.1 下载源码导入IDEA</h2><p>先下载这三个项目：我是fork到自己仓库了，也可以从mybatis官方仓库下载：<a target="_blank" rel="noopener" href="https://github.com/mybatis">https://github.com/mybatis</a></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/zhuansun/mybatis-3">https://github.com/zhuansun/mybatis-3</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/zhuansun/spring">https://github.com/zhuansun/spring</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/zhuansun/parent">https://github.com/zhuansun/parent</a></p>
</blockquote>
<p>mybatis-3：mybatis源码项目</p>
<p>spring：mybatis与spring集成使用的，方便mybatis集成spring</p>
<p>parent：mybatis源码所依赖的基础依赖</p>
<p>将这三个项目导入到IDEA，导入方式不是直接打开文件夹，而是新建空项目，然后添加module（可以参考《Mybatis3源码深度解析 1.4节》）：</p>
<img src="【mybatis】Mybatis从入门到入土.assets/12Qv-Ty5zzBk7QuJvMls9YcQJ1sdFDpF6dZ3G-izeN0.png" alt="image" style="zoom:80%;" />

<p>项目接口如下：</p>
<img src="【mybatis】Mybatis从入门到入土.assets/qptRYBgkk0ZUvKQ4jdiTI6mZ-hE3SQ5K1DhAE5OEEFs.png" alt="image" style="zoom: 150%;" />

<h2 id="1-2-HSQLDB数据库简介"><a href="#1-2-HSQLDB数据库简介" class="headerlink" title="1.2 HSQLDB数据库简介"></a>1.2 HSQLDB数据库简介</h2><ul>
<li><strong>是什么</strong></li>
<li>是纯java语言写的关系型数据库管理系统</li>
<li><strong>怎么用</strong></li>
<li>运行方式有两种：单独server部署（独立部署）或者内存模式运行（嵌入到应用中）；</li>
<li>数据保存有两种方式：内存或者磁盘；</li>
<li><strong>为什么要用</strong></li>
<li>因为Mybatis源码使用了HSQLDB作为单元测试使用的数据库，所以为了学习源码，需要了解。</li>
<li><strong>使用示例</strong></li>
<li>1、准备好sql文件；</li>
<li>2、在项目中引入hsqldb的依赖</li>
<li>3、在代码中就可以直接使用</li>
</ul>
<h1 id="2-JDBC知识准备"><a href="#2-JDBC知识准备" class="headerlink" title="2 JDBC知识准备"></a>2 JDBC知识准备</h1><h2 id="2-1-JDBC是什么？"><a href="#2-1-JDBC是什么？" class="headerlink" title="2.1 JDBC是什么？"></a>2.1 JDBC是什么？</h2><ul>
<li>java语言提供的访问关系型数据的接口，或者说是规范；</li>
</ul>
<h2 id="2-2-JDBC怎么用"><a href="#2-2-JDBC怎么用" class="headerlink" title="2.2 JDBC怎么用?"></a>2.2 JDBC怎么用?</h2><ul>
<li>一般来说分为四个步骤</li>
<li>1、与数据源建立连接；</li>
<li>2、执行SQL语句；</li>
<li>3、检索SQL执行结果；</li>
<li>4、关闭连接</li>
</ul>
<h3 id="与数据源建立连接"><a href="#与数据源建立连接" class="headerlink" title="* 与数据源建立连接"></a>* <strong>与数据源建立连接</strong></h3><ul>
<li>简单的来说，就是说去Connection对象：JDBC提供了Connection接口，用来表示与底层数据源的连接；</li>
<li>获取Connection对象的方式一：DriverManager</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:hsqldb:mem:mybatis"</span><span class="token punctuation">,</span><span class="token string">"sa"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>获取Connection对象的方式二：DataSource</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建DataSource实例</span>
<span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledDataSource</span><span class="token punctuation">(</span><span class="token string">"org.hsqldb.jdbcDriver"</span><span class="token punctuation">,</span><span class="token string">"jdbc:hsqldb:mem:mybatis"</span><span class="token punctuation">,</span><span class="token string">"sa"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取Connection对象</span>
<span class="token class-name">Connection</span> connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="执行SQL语句"><a href="#执行SQL语句" class="headerlink" title="* 执行SQL语句"></a>* <strong>执行SQL语句</strong></h3><ul>
<li><p>JDBC获取到Connection对象后，可以设置事务或者创建Statement，PreparedStatement，CllableStatement对象；</p>
</li>
<li><p>Statement对象可以理解为SQL语句的执行器，比如调用Statement中的executeQuery方法执行查询，executeUpdate方法执行更新；</p>
</li>
<li><p>Statement执行之后，可以通过Statement接口提供的getResultSet获取查询结果集，或者通过getUpdateCount获取更新影响的行数；</p>
</li>
</ul>
<h3 id="检索SQL执行结果"><a href="#检索SQL执行结果" class="headerlink" title="* 检索SQL执行结果"></a>* <strong>检索SQL执行结果</strong></h3><ul>
<li>执行SQL之后会有结果集，比如Statement使用getResultSet得到结果集，我们使用ResultSet这个接口来接收这些返回值；</li>
<li>获取到返回值之后，使用ResultSet提供的各种get方法可以拿到结果；</li>
</ul>
<h3 id="关闭连接"><a href="#关闭连接" class="headerlink" title="* 关闭连接"></a>* <strong>关闭连接</strong></h3><ul>
<li>关闭连接</li>
</ul>
<h2 id="2-3-JDBC核心类解读"><a href="#2-3-JDBC核心类解读" class="headerlink" title="2.3 JDBC核心类解读"></a>2.3 JDBC核心类解读</h2><h3 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h3><ul>
<li>是什么？一个Connection对象表示通过JDBC驱动与数据源建立的连接，这里的数据源可以是关系型数据库，文件系统或者是其他通过JDBC访问的数据。</li>
<li>特性：使用JDBC API的应用程序，可能需要维护多个Connection对象，一个Connection对象可能访问多个数据源，也可能访问单个数据源。<strong>？？？？没看懂</strong></li>
<li>获取Connection的方式有两种：<strong>一种是通过DriverManager，一种是通过DateSource（主流都是用这个，推荐）；</strong></li>
<li>具体相关：包括JDBC驱动类型，DriverManager类，Driver接口，DataSource接口等；</li>
<li>JDBC<strong>驱动类型</strong></li>
<li>JDBC驱动类型不是我们所说mysql-connection-java，而是更为底层的驱动类型方式，常见的mysql-connection-java这个jar包只是其中一个驱动类型的具体实现；</li>
<li>JDBC-ODBC Bridge Driver ：应用程序-&gt;JDBC API-&gt;JDBC驱动-&gt;ODBC驱动&lt;-通信协议-&gt;数据库（桥接影响性能，不推荐）</li>
<li>Native API Driver：应用程序-&gt;JDBC API-&gt;JDBC驱动-&gt;特定客户端&#x2F;特定链接库&lt;-通信协议-&gt;特定数据库（特定数据库使用特定链接库，不能跨平台）</li>
<li>JDBC-Net Driver：应用程序-&gt;JDBC API-&gt;JDBC驱动&lt;-通信协议-&gt;服务器&lt;-通信协议-&gt;数据库（中间使用了服务器转发，影响性能），微软有一款产品再用。</li>
<li>Native Protocol Driver：应用程序-&gt;JDBC API-&gt;JDBC驱动-&gt;&lt;-通信协议-&gt;数据库（直接使用java开发JDBC某一个数据库的驱动，直接使用该驱动访问数据库，少了转换，性能好，推荐）比如常见的mysql-connection-java.jar 以及oracle的等等，都是使用这个方式。</li>
<li><strong>Driver接口</strong></li>
<li>所有的驱动都需要实现Driver接口，并且实现一个静态代码块。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AcmeJdbcDriver</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Driver</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DriverManager</span><span class="token punctuation">.</span><span class="token function">registerDriver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AcmeJdbcDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>静态代码块的作用是：在类加载的时候，注册当前驱动的实例；</li>
<li>因为类加载的时候就会注册驱动，所以我们使用JDBC操作数据库之前都要先加载驱动</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">Class.forName(&quot;org.hsqldb.jdbcDriver&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>加载驱动类目前有两种方式，一种是Class.forName() 一种是通过SPI机制；</li>
<li><strong>DriverAction接口</strong></li>
<li>可以解除注册，从DriverManager中移除已经注册的驱动，知道就行了。一般是驱动开发人员需要关注；</li>
<li><strong>DriverManager类</strong></li>
<li>Driver接口是驱动，有一些实现类，这些实现类在实例化的时候，会将自己注册到DriverManager中；</li>
<li>DriverManager有两个重要的方式：registerDriver() 用来注册驱动实例的。一个是getConnection()用来获取数据库Connection对象的。</li>
<li>DriverManager的getConnection，会根据传进来的URL，解析，然后通过URL拿到具体的驱动实现类，最后通过具体的驱动实现类链接到对应的数据库。</li>
<li><strong>小结：三者之间的关系</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Driver调用DriverManager注册</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XXXDriver</span> <span class="token keyword">implements</span> <span class="token class-name">Driver</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">registerDriver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XXXDriver</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Connection</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties</span> info<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//具体实现</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//应用程序调用DriverManager获取Connection连接</span>
<span class="token keyword">public</span> <span class="token class-name">MainTest</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//DriverManager调用Driver获取Connection连接</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Drivermanager</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//DriverManager的源码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//最终调用的是Driver接口中的connect方法</span>
        <span class="token keyword">return</span> driver<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong>DataSource接口</strong></li>
<li>和DriverManager对比</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>DriverManager</th>
<th>DataSource</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>需要在代码中硬编码指定驱动；Class.forName(….)，如果需要修改的时候，需要修改业务代码</td>
<td>使用配置的方式，同时使用JNDI暴露服务，通过逻辑名称可以简单的获取到DataSource对象，从而获得Connection； 另外当修改数据源的时候，只需要修改配置，不需要对应用代码进行修改。提高了应用程序的可移植性</td>
</tr>
<tr>
<td></td>
<td>每获取一次Connection对象，都需要与数据库建立一次连接，使用完之后，需要关闭连接。</td>
<td>DataSource接口支持数据库连接池和分布式事务。连接池通过对连接的复用而不是新建一个物理连接来显著地提高程序的效率。从而适用于任务繁忙、负担繁重的企业级分布式事务。</td>
</tr>
<tr>
<td></td>
<td>参考文献：<a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-vwtcyipy-rn.html">http://www.voidcn.com/article/p-vwtcyipy-rn.html</a></td>
<td>参考文献：<a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-vwtcyipy-rn.html">http://www.voidcn.com/article/p-vwtcyipy-rn.html</a></td>
</tr>
</tbody></table>
<ul>
<li>大部分开源框架使用的都是DataSource接口；</li>
<li>关闭Connection对象</li>
<li>使用完之后需要显示的关闭；</li>
<li>close() 用于关闭connection对象</li>
<li>isClosed() 判断连接是否关闭</li>
<li>isValid() 判断连接是否有效</li>
</ul>
<h3 id="Statement"><a href="#Statement" class="headerlink" title="Statement"></a>Statement</h3><p>Statement是一个接口，有两个比较重要的子接口：PreparedStatement和CallableStatement。</p>
<p>Statement接口定义了执行SQL语句的方法，不支持参数输入；</p>
<p>PreparedStatement接口中增加了设置SQL参数的方法；设值字后，再次设值需要注意，可能需要clear之后才行。</p>
<p>CallableStatement接口继承自PreparedStatement，增加了调用存储过程以及检索存储过程调用结果的方法。</p>
<ul>
<li><strong>问题一：Statement接口中boolean execute(String sql, String columnNames[]) throws SQLException;这个方法的第二个入参的含义是什么？？</strong></li>
</ul>
<p>表示可以被用于检索！！去你妈的。。这是人能听懂的话吗？一步一步的往下看：</p>
<p>首先要知道，在Statement中，以execute(..)方法为例，总共有四个方法，其中有三个方法，提到了可以被用于检索：<strong>【注意：只有当sql是INSERT的时候，第二个字段才会生效，如果是UPDATE后者是DELETE语句，第二个参数填了也没用】</strong></p>
<p><img src="/%E3%80%90mybatis%E3%80%91Mybatis%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F.assets/7_2hrcGsoVHlxvOYILE01hMteeiMPRDWx1WojqRqa6s.png" alt="image"></p>
<p>对于这三个方法，我们来看看第二个字段分别是什么含义？（摘录自java8api）</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">autoGeneratedKeys - 一个常数，表示使用方法getGeneratedKeys是否应使自动生成的密钥可用于getGeneratedKeys; 以下常数之一： Statement.RETURN_GENERATED_KEYS或Statement.NO_GENERATED_KEYS<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">columnIndexes - 插入行中的列的索引数组，应该可用于通过调用方法进行 getGeneratedKeys<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">columnNames - 插入行中列的名称数组，应该可用于通过调用方法进行 getGeneratedKeys<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>瞅瞅，这说的是人话吗！！那么接下来用人话说就是：当我们希望拿到INSERT语句的返回结果（返回结果可以是主键，可以是表中某一个字段）的时候，就指定第二个参数，这样获取到resultSet的时候，就可以拿到我们期望的返回结果。这就叫做<strong>可用于检索</strong>！还是不懂，看个例子就懂了。</p>
<p>例子1：不指定检索字段，是什么样子的</p>
<img src="【mybatis】Mybatis从入门到入土.assets/yh0upAZS2UmhemvNqE9x10Sqbq5C9xv3yUbszNTb2Y4.png" alt="image" style="zoom:80%;" />

<p>例子2：指定autoGeneratedKeys检索</p>
<img src="【mybatis】Mybatis从入门到入土.assets/K2JlTQsnkVc0_tujJUfD9j77ppode0Z28voacv5dShk.png" alt="image" style="zoom:80%;" />

<p>例子3：</p>
<ul>
<li>不贴代码了</li>
<li>当我们指定检索为：</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">stmt.executeUpdate(sql,Statement.NO_GENERATED_KEYS);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>的时候，和没指定检索是一样的效果；</p>
<p>例子4：</p>
<img src="【mybatis】Mybatis从入门到入土.assets/peIsrngrofKF5hmFox_31n-jIK03_WatS4LrQMvmwy8.png" alt="image" style="zoom:80%;" />

<p>总结：到这里，可能有点眉目了，但是还是不知道检索是什么？我们再来接着看指定columnIndexes和columnNames的时候，是什么样子的。</p>
<p>例子5：</p>
<img src="【mybatis】Mybatis从入门到入土.assets/CTZdEsMJD22gk-eO4eaolRQ81UHZ8jwyrbkBfSqI0lI.png" alt="image" style="zoom:80%;" />

<p>例子6：</p>
<img src="【mybatis】Mybatis从入门到入土.assets/LdXnJySFue9S29nD9QMJ8TRGbc5MP7Zaa-K0lIzTZ0s.png" alt="image" style="zoom:80%;" />

<p>例子7：</p>
<ul>
<li>使用columnIndexes和columnNames的时候，如果超了（指定了3个索引，但是get4个），还是会报错的；</li>
<li>当指定是columnNames的时候，除了可以通过getXXX(数字)的形式，也可以通过getXXX(“name”)的形式；</li>
</ul>
<p>总结：当我们希望拿到INSERT语句的返回结果（返回结果可以是主键，可以是表中某一个字段）的时候，就指定第二个参数，这样获取到resultSet的时候，就可以拿到我们期望的返回结果。这就叫做<strong>可用于检索</strong></p>
<ul>
<li><strong>问题二：CallableStatement到底是干嘛的？什么是存储过程？什么是IN，什么是OUT，什么是INOUT？</strong></li>
</ul>
<p>想解答这个问题，需要知道什么是存储过程，都没有学习，也不知道是个啥。</p>
<h3 id="ResultSet"><a href="#ResultSet" class="headerlink" title="ResultSet"></a>ResultSet</h3><p>ResultSet简单的说，就是SQL执行的结果，掌握下面三点：</p>
<p>ResultSet的类型：游标是否是可以滚动和修改是否对数据库敏感</p>
<p>ResultSet的并行性：resultSet是否可以读写</p>
<p>ResultSet的可保持性：事务结束后是否要关闭resultSet</p>
<ul>
<li>ResultSet的类型：</li>
<li>TYPE_FORWARD_ONLY（默认）：游标只能向前</li>
<li>TYPE_SCROLL_INSENSITIVE：游标可向前向后，也可指定；ResultSet数据的修改对数据库不敏感（不敏感的意思就是ResultSet的修改不会影响到数据库中的记录）；</li>
<li>TYPE_SCROLL_SENSITIVE：游标可向前向后，也可指定；ResultSet数据库的修改对数据库敏感；</li>
<li>这三个类型，在创建Statement的时候，可以指定</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/MvWGhLnUmWRbrV8Smj9H7lUHrTZx8e41t5wRwKdh7yk.png" alt="image" style="zoom:80%;" />

<ul>
<li>ResultSet的并行性</li>
<li>CONCUR_READ_ONLY：为resultSet设置这种属性后，只能从ResultSet中读取数据；修改会报错；</li>
<li>CONCUR_UPDATABLE：为resultSet设置这种属性后，可读可写；</li>
<li>这两个属性，也是在创建Statement的时候，可以指定的（同ResultSet的类型一样，都是可以指定的）</li>
<li>ResultSet的可保持性</li>
<li>HOLD_CURSOURS_OVER_COMMIT：调用connection的commit方法后，不关闭当前事务创建的resultSet。</li>
<li>CLOSE_CURSOURS_AT_COMMIT：会关闭；好处就是会提高系统的性能。</li>
<li>默认的可保持性，取决于驱动的具体实现。</li>
<li>修改ResultSet对象</li>
<li>并行性为CONCUR_UPDATABLE的ResultSet可以使用ResultSet接口中提供的方法对其进行更新，包括更新行，删除行，在驱动的支持下，还可以插入行；</li>
<li>关闭ResultSet对象</li>
</ul>
<h3 id="DataBaseMetaData"><a href="#DataBaseMetaData" class="headerlink" title="DataBaseMetaData"></a>DataBaseMetaData</h3><ul>
<li>简单的说，就是用来提供底层数据源的相关的信息；比如获取数据源的信息，获取数据源是否支持某一特性，获取数据源的限制等等；</li>
<li>创建DataBaseMetaData对象：通过connection对象创建的。</li>
<li>获取数据源的基本信息</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Test
    public void testDbMetaData() &#123;
        try &#123;
            Class.forName(&quot;org.hsqldb.jdbcDriver&quot;);
            &#x2F;&#x2F; 获取Connection对象
            Connection conn &#x3D; DriverManager.getConnection(&quot;jdbc:hsqldb:mem:mybatis&quot;,
                    &quot;sa&quot;, &quot;&quot;);
            DatabaseMetaData dmd &#x3D; conn.getMetaData();
            System.out.println(&quot;数据库URL:&quot; + dmd.getURL());
            System.out.println(&quot;数据库用户名:&quot; + dmd.getUserName());
            System.out.println(&quot;数据库产品名:&quot; + dmd.getDatabaseProductName());
            System.out.println(&quot;数据库产品版本:&quot; + dmd.getDatabaseProductVersion());
            System.out.println(&quot;驱动主版本:&quot; + dmd.getDriverMajorVersion());
            System.out.println(&quot;驱动副版本:&quot; + dmd.getDriverMinorVersion());
            System.out.println(&quot;数据库供应商用于schema的首选术语:&quot; + dmd.getSchemaTerm());
            System.out.println(&quot;数据库供应商用于catalog的首选术语:&quot; + dmd.getCatalogTerm());
            System.out.println(&quot;数据库供应商用于procedure的首选术语:&quot; + dmd.getProcedureTerm());
            System.out.println(&quot;null值是否高排序:&quot; + dmd.nullsAreSortedHigh());
            System.out.println(&quot;null值是否低排序:&quot; + dmd.nullsAreSortedLow());
            System.out.println(&quot;数据库是否将表存储在本地文件中:&quot; + dmd.usesLocalFiles());
            System.out.println(&quot;数据库是否为每个表使用一个文件:&quot; + dmd.usesLocalFilePerTable());
            System.out.println(&quot;数据库SQL关键字:&quot; + dmd.getSQLKeywords());
            IOUtils.closeQuietly(conn);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-4-JDBC事务"><a href="#2-4-JDBC事务" class="headerlink" title="2.4 JDBC事务"></a>2.4 JDBC事务</h2><ul>
<li>事务边界：事务的开启是JDBC驱动或者数据库决定的，不能再代码中显示的开启；有些框架可能支持显示开始事务，至少JDBC不支持；什么时候开启事务，是SQL:2003规范决定的。</li>
<li>事务提交：关闭一个事务有两种方式，一种是自动提交（默认开启）：SQL在执行完之后，自动提交事务；还有一种是手动提交事务，需要关闭自动提交，然后在提交事务的时候，调用commit()方法；或者使用rollback()回滚事务；</li>
<li>事务隔离级别：事务隔离级别用于指定事务中对数据的操作对其他事务的可见性；</li>
<li>事务中出现的问题</li>
<li>脏读：B事务读取A事务中没有commit的数据，如果A回滚，此时B事务的数据就是错误的；</li>
<li>不可重复读：A事务操作时间很长，开始的时候读一条记录，B事务修改了这条记录，A事务再次读取这条记录将得到不同的结果；</li>
<li>幻读：A事务读取一些符合条件的数据，B事务插入了符合条件的若干数据，A通过相同的条件将会读取到B事务插入的数据；</li>
<li>事务的隔离级别</li>
<li>TRANSACTION_NONE：驱动不支持事务</li>
<li>TRANSACTION_READ_UNCOMMITED：允许其他事务读取当前事务未提交的数据，可能出现脏读，不可重复读，幻读；</li>
<li>TRANSACTION_READ_COMMITED：当前事务未提交对其他事务是不可见的。可以解决脏读，会出现不可重复读，幻读</li>
<li>TRANSACTION_REPEATABLE_READ：保证在一次事务中，相同查询得到结果是一致的，可以解决脏读和不可重复读，不能解决幻读；</li>
<li>TRANSACTION_SERIALIZABLE：串行事务；可以解决上面三个问题，但是并发效率极低；</li>
<li>默认的事务隔离级别是由数据库驱动实现的。也可以通过connecton.setTransactionSolation()设置；</li>
<li>事务的保存点</li>
<li>保存点通过在事务中标记一个中间的点，一旦标记，事务可以回滚到标记点，而不影响保存点之前的操作；</li>
<li>驱动是否支持保存点，可以通过DataBaseMetaData中的supportSavePoints()来指定；</li>
<li>设置保存点：connection.setSavePoint()</li>
<li>回滚到保存点：setSavePoint会返回一个SavePoint对象，rollback的时候可以把这个对象传进去；</li>
</ul>
<p><strong>“磨刀不误砍柴工”这句话说得好，掌握了JDBC，在学习框架源码，往上靠就行了</strong></p>
<h1 id="3-Mybatis常用工具类"><a href="#3-Mybatis常用工具类" class="headerlink" title="3 Mybatis常用工具类"></a>3 Mybatis常用工具类</h1><p>介绍mybatis中一些比较实用的工具类，例如：SQL，ScriptRunner，SqlRunner和MetaObject等；</p>
<h2 id="3-1-SQL类"><a href="#3-1-SQL类" class="headerlink" title="3.1 SQL类"></a>3.1 SQL类</h2><p>用于在Java代码中动态构建SQL语句；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSelectSQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> orgSql <span class="token operator">=</span> <span class="token string">"SELECT P.ID, P.USERNAME, P.PASSWORD, P.FULL_NAME, P.LAST_NAME, P.CREATED_ON, P.UPDATED_ON\n"</span> <span class="token operator">+</span>
                    <span class="token string">"FROM PERSON P, ACCOUNT A\n"</span> <span class="token operator">+</span>
                    <span class="token string">"INNER JOIN DEPARTMENT D on D.ID = P.DEPARTMENT_ID\n"</span> <span class="token operator">+</span>
                    <span class="token string">"INNER JOIN COMPANY C on D.COMPANY_ID = C.ID\n"</span> <span class="token operator">+</span>
                    <span class="token string">"WHERE (P.ID = A.ID AND P.FIRST_NAME like ?) \n"</span> <span class="token operator">+</span>
                    <span class="token string">"OR (P.LAST_NAME like ?)\n"</span> <span class="token operator">+</span>
                    <span class="token string">"GROUP BY P.ID\n"</span> <span class="token operator">+</span>
                    <span class="token string">"HAVING (P.LAST_NAME like ?) \n"</span> <span class="token operator">+</span>
                    <span class="token string">"OR (P.FIRST_NAME like ?)\n"</span> <span class="token operator">+</span>
                    <span class="token string">"ORDER BY P.ID, P.FULL_NAME"</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> newSql <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">SQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
                <span class="token function">SELECT</span><span class="token punctuation">(</span><span class="token string">"P.ID, P.USERNAME, P.PASSWORD, P.FULL_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">SELECT</span><span class="token punctuation">(</span><span class="token string">"P.LAST_NAME, P.CREATED_ON, P.UPDATED_ON"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FROM</span><span class="token punctuation">(</span><span class="token string">"PERSON P"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FROM</span><span class="token punctuation">(</span><span class="token string">"ACCOUNT A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">INNER_JOIN</span><span class="token punctuation">(</span><span class="token string">"DEPARTMENT D on D.ID = P.DEPARTMENT_ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">INNER_JOIN</span><span class="token punctuation">(</span><span class="token string">"COMPANY C on D.COMPANY_ID = C.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"P.ID = A.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"P.FIRST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">OR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"P.LAST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">GROUP_BY</span><span class="token punctuation">(</span><span class="token string">"P.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">HAVING</span><span class="token punctuation">(</span><span class="token string">"P.LAST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">OR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">HAVING</span><span class="token punctuation">(</span><span class="token string">"P.FIRST_NAME like ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ORDER_BY</span><span class="token punctuation">(</span><span class="token string">"P.ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ORDER_BY</span><span class="token punctuation">(</span><span class="token string">"P.FULL_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertEquals</span><span class="token punctuation">(</span>orgSql<span class="token punctuation">,</span> newSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-2-SqlRunner和ScriptRunner"><a href="#3-2-SqlRunner和ScriptRunner" class="headerlink" title="3.2 SqlRunner和ScriptRunner"></a>3.2 SqlRunner和ScriptRunner</h2><p>在Mybatis源码测试用例中出现的频率比较高；用于执行SQL语句和SQL脚本；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSelectOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">SqlRunner</span> sqlRunner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlRunner</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> qryUserSql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
           <span class="token function">SELECT</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">FROM</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">"id = ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> resultMap <span class="token operator">=</span> sqlRunner<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>qryUserSql<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testScriptRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
           <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:hsqldb:mem:mybatis"</span><span class="token punctuation">,</span>
                   <span class="token string">"sa"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">ScriptRunner</span> scriptRunner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptRunner</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
           scriptRunner<span class="token punctuation">.</span><span class="token function">runScript</span><span class="token punctuation">(</span><span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsReader</span><span class="token punctuation">(</span><span class="token string">"create-table.sql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-3-MetaObject和MetaClass"><a href="#3-3-MetaObject和MetaClass" class="headerlink" title="3.3 MetaObject和MetaClass"></a>3.3 MetaObject和MetaClass</h2><p>是Mybatis中的反射工具类，分别封装了对对象和类的反射访问；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMetaObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">></span></span> orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"order20171024010246"</span><span class="token punctuation">,</span> <span class="token string">"《Mybatis源码深度解析》图书"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"order20171024010248"</span><span class="token punctuation">,</span> <span class="token string">"《AngularJS入门与进阶》图书"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>orders<span class="token punctuation">,</span> <span class="token string">"江荣波"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取第一笔订单的商品名称</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"orders[0].goodsName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取第二笔订单的商品名称</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"orders[1].goodsName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 为属性设置值</span>
    metaObject<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"orders[1].orderNo"</span><span class="token punctuation">,</span><span class="token string">"order20181113010139"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断User对象是否有orderNo属性</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"是否有orderNo属性且orderNo属性有对应的Getter方法："</span> <span class="token operator">+</span> metaObject<span class="token punctuation">.</span><span class="token function">hasGetter</span><span class="token punctuation">(</span><span class="token string">"orderNo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断User对象是否有name属性</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"是否有name属性且name属性有对应的Getter方法："</span> <span class="token operator">+</span> metaObject<span class="token punctuation">.</span><span class="token function">hasGetter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMetaClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">MetaClass</span> metaClass <span class="token operator">=</span> <span class="token class-name">MetaClass</span><span class="token punctuation">.</span><span class="token function">forClass</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取所有有Getter方法的属性名</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> getterNames <span class="token operator">=</span> metaClass<span class="token punctuation">.</span><span class="token function">getGetterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>getterNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否有默认构造方法</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"是否有默认构造方法："</span> <span class="token operator">+</span> metaClass<span class="token punctuation">.</span><span class="token function">hasDefaultConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 某属性是否有对应的Getter/Setter方法</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"orderNo属性是否有对应的Getter方法："</span> <span class="token operator">+</span> metaClass<span class="token punctuation">.</span><span class="token function">hasGetter</span><span class="token punctuation">(</span><span class="token string">"orderNo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"orderNo属性是否有对应的Setter方法："</span> <span class="token operator">+</span> metaClass<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"orderNo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"orderNo属性类型："</span> <span class="token operator">+</span> metaClass<span class="token punctuation">.</span><span class="token function">getGetterType</span><span class="token punctuation">(</span><span class="token string">"orderNo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取属性Getter方法</span>
    <span class="token class-name">Invoker</span> invoker <span class="token operator">=</span> metaClass<span class="token punctuation">.</span><span class="token function">getGetInvoker</span><span class="token punctuation">(</span><span class="token string">"orderNo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 通过Invoker对象调用Getter方法获取属性值</span>
        <span class="token class-name">Object</span> orderNo <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"order20171024010248"</span><span class="token punctuation">,</span><span class="token string">"《Mybatis源码深度解析》图书"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-4-ObjectFactory和ProxyFactory"><a href="#3-4-ObjectFactory和ProxyFactory" class="headerlink" title="3.4 ObjectFactory和ProxyFactory"></a>3.4 ObjectFactory和ProxyFactory</h2><p>是对象创建的工具类，前者用于创建Mapper映射实体对象，后者用于创建Mapper映射实体对象对应的代理对象，通过动态代理实现Mybatis中懒加载机制。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ObjectFactory</span> objectFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建ProxyFactory对象</span>
    <span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavassistProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"gn20170123"</span><span class="token punctuation">,</span><span class="token string">"《Mybatis源码深度解析》图书"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ObjectFactory</span> objectFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用ProxyFactory对象的createProxy（）方法创建代理对象</span>
    <span class="token class-name">Object</span> proxyOrder <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span>order
            <span class="token punctuation">,</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">ResultLoaderMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span>objectFactory
            <span class="token punctuation">,</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order<span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>proxyOrder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">)</span>proxyOrder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="4-Mybatis核心组件介绍"><a href="#4-Mybatis核心组件介绍" class="headerlink" title="4 Mybatis核心组件介绍"></a>4 Mybatis核心组件介绍</h1><h2 id="4-1-使用Mybatis操作数据库"><a href="#4-1-使用Mybatis操作数据库" class="headerlink" title="4.1 使用Mybatis操作数据库"></a>4.1 使用Mybatis操作数据库</h2><ul>
<li>编写mybatis的主配置文件：mybatis-config.xml</li>
<li>新增Java实体与数据库记录建立映射</li>
<li>定义用于执行SQL的Mapper</li>
<li>通过Mybatis提供的API执行我们定义的Mapper</li>
</ul>
<h2 id="4-2-Mybatis核心组件"><a href="#4-2-Mybatis核心组件" class="headerlink" title="4.2 Mybatis核心组件"></a>4.2 Mybatis核心组件</h2><img src="【mybatis】Mybatis从入门到入土.assets/-TKD7IgXtBFz_zTiV8VgeJKYL2twPUzV38ZrFg6CzPs.png" alt="image" style="zoom:67%;" />

<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>Mybatis的配置信息有两种，一种是用来描述Mybatis的主配置信息，一种是用来配置执行SQL语句的Mapper配置文件。</p>
<p>Configuration是用来描述Mybatis的主配置信息的，其他组件需要获取配置信息的时候，直接通过Configuration对象获取。除此之外，MyBatis在应用启动时，将Mapper配置信息，类型别名，TypeHandler等注册到Configuration组件中，其他组件需要这些信息时，也可以从Configuration对象中获取。</p>
<p>三大作用：</p>
<ul>
<li>用于描述MyBatis配置信息，项目启动时，所有的配置信息都会转换为configuration对象；</li>
<li>作为中间这简化MyBatis各个组件之间的交互，属于<strong>中介者模式</strong>的应用；</li>
<li>作为Executor, ParameterHandler, ResultSetHandler, StatementHandler组件的工厂，便于创建这些组件的实例</li>
</ul>
<h3 id="MappedStatement"><a href="#MappedStatement" class="headerlink" title="MappedStatement"></a>MappedStatement</h3><p>用来描述Mapper中的SQL配置信息，是对XML配置文件中&#x2F;&#x2F;&#x2F;等标签或者@Select&#x2F;@Update等注解配置信息的封装。</p>
<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><p>是Mybatis提供的面向用户的API，表示和数据库交互时的会话对象，用于完成数据库的CRUD功能，SqlSession是Executor组件的外观，目的是对外提供易于理解和使用的数据库操作接口；</p>
<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p>是Mybatis的SQL执行器，在Mybatis中对数据库所有的增删改查操作都是由Executor组件完成的。</p>
<img src="【mybatis】Mybatis从入门到入土.assets/3MheQjlJAuwOpC0tNFJavPgWUJVQfKCxgQUX0X-ezWQ.png" alt="image" style="zoom: 150%;" />

<p>SimpleExecutor：能够完成基本的增删改查操作</p>
<p>ReuseExecutor：对JDBC的Statement做了缓存，当执行同样的SQL时，直接从缓存中取Statement，避免了频繁创建和销毁，从而提升系统性能；</p>
<p>BatchExecutor：会对调用同一个Mapper执行的update，insert和delete操作，调用Statement对象的批量处理功能。</p>
<p>CachingExecutor：我们知道Mybatis支持一二级缓存，当开启了二级缓存时，会使用CachingExecutor对上面三个进行装饰，为查询增加二级缓存功能。用到了<strong>装饰者模式</strong>的设计模式</p>
<p>Executor是在SqlSessionFactory.openSession的时候创建的。</p>
<h3 id="StatementHandler"><a href="#StatementHandler" class="headerlink" title="StatementHandler"></a>StatementHandler</h3><p>封装了对JDBC Statement对象的使用，比如为Statement对象设置参数，调用Statement接口与数据库交互等等。</p>
<img src="【mybatis】Mybatis从入门到入土.assets/2-ndfSVFWd93s2tMI-R9AYlw7zsz8AQp_Gs-lkLKYa0.png" alt="image" style="zoom:80%;" />

<p>BaseStatementHandler：抽象类，封装了通用逻辑和方法执行流程，使用了模板方法模式；</p>
<p>SImpleStatementHandler：封装了对JDBC中Statement对象的操作；</p>
<p>PreparedStatementHandler：封装了对JDBC中PreparedStatement对象的操作；</p>
<p>CallableStatementHandler：封装了对JDBC中CallableStatement对象的操作；</p>
<p>RoutingStatementHandler：会更具Mapper配置中的statementType属性（取值为STATEMENT，PREPARED或CALLABLE）创建对应的StatementHandler的实现</p>
<h3 id="ParameterHandler"><a href="#ParameterHandler" class="headerlink" title="ParameterHandler"></a>ParameterHandler</h3><p>当Mybatis框架使用的Statement类型是PreparedStatement和CallableStatement时，ParameterHandler用于为Statement对象参数占位符设置值。</p>
<p>比较简单，就一个实现：拿到sql中所有的参数，遍历所有的参数，如果需要设值，就获取TypeHandler，然后通过TypeHandler对这个占位符设值。</p>
<h3 id="ResultSetHandler"><a href="#ResultSetHandler" class="headerlink" title="ResultSetHandler"></a>ResultSetHandler</h3><p>封装了对JDBC中ResultSet的使用，当MyBatis执行的SQL类型是SELECT语句时，ResultSetHandler用于将查询结果转换成Java对象。</p>
<p>一样比较简单，只有一个默认的实现。</p>
<h3 id="TypeHandler"><a href="#TypeHandler" class="headerlink" title="TypeHandler"></a>TypeHandler</h3><p>是Mybatis中的类型处理器，用于处理Java类型与JDBC类型之间的映射。它的作用主要体现在能够根据Java类型调用PreparedStatement（JDBC的）或CallableStatement（JDBC的）对象对应的SetXXX()方法为Statement对象设置值，而且能够根据Java类型调用ResultSet（JDBC的）对象赌赢的getXXX()获取SQL执行结果。</p>
<p>简单的说：及时jdbc类型和Java类型处理映射的关系；</p>
<p>Mybatis通过TypeHandlerRegistry建立JDBC类型，Java类型与Typehandler之间的映射关系；这个类的逻辑比较简单，就是在维护了三个map，分别是jdbc类型与TypeHander的关系，Java类型与Jdbc类型与TypeHander的关系，TypeHander的class与TypeHander之间的关系；这三个map会在TypeHandlerRegistry的无参构造方法中进行register，而这个无参构造方法是在Configuration中被调用的。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Mybatis通过sqlSession操作数据库，sqlSession是用户层面的API。</p>
<p>实际上sqlSession是Executor组件的外观（外观模式），目的是为用户提供更友好的方式操作数据库。</p>
<p>真正执行sql操作的是Executor组件，Executor组件可以理解为SQL的执行器，它会使用StatementHandler组件对JDBC的Statement对象进行操作。</p>
<p>当Statement类型是CallableStatement和PreparedStatement时，会通过ParameterHandler组件为参数占位符赋值。</p>
<p>ParameterHandler组件中会根据Java类型找到对应的TypeHandler对象；</p>
<p>TypeHandler中会通过Statement提供的setXXX方法为Statement对象中的参数占位符进行设值。</p>
<p>StatementHandler组件使用JDBC中的Statement对象与数据库完成交互后，当SQL语句类型是SELECT时，Mybatis通过ResultSetHandler组件从Statement对象中获取ResultSet对象，然后将ResultSet对象转换为Java对象。</p>
<h1 id="5-SqlSession的创建过程"><a href="#5-SqlSession的创建过程" class="headerlink" title="5 SqlSession的创建过程"></a>5 SqlSession的创建过程</h1><p>sqlSession是Mybatis的最顶层API，来学习一下它的创建过程，从三个部分入手</p>
<ul>
<li>Configuration实例的创建过程</li>
<li>SqlSessionFactory实例的创建过程</li>
<li>SqlSession实例化的过程</li>
</ul>
<h2 id="5-1-Configuration实例的创建过程"><a href="#5-1-Configuration实例的创建过程" class="headerlink" title="5.1 Configuration实例的创建过程"></a>5.1 Configuration实例的创建过程</h2><p>Configuration是Mybatis中比较重要的组件，我们知道mybatis有两种配置文件，一种是描述sql的mapper.xml配置文件，一种是描述mybatis配置的文件；Configuration的创建和xml文件密切相关，但是怎么从xml文件到Configuration的呢？</p>
<ul>
<li>涉及到xml文件的解析，mybatis采用的<strong>XPath</strong>解析xml文件，将配置信息转换成Configuration对象的；（不细说）</li>
<li>MyBatis封装了<strong>XPathParser</strong>工具类，简化了XPath的操作，可以方便的获取节点属性，子节点信息等</li>
</ul>
<p>Configuration有三个作用：</p>
<ul>
<li>用于描述MyBatis配置信息，例如标签配置的参数信息</li>
<li>作为容器注册Mybatis的其他组件,例如TypeHandler，MappedStatement等</li>
<li>提供工厂方法，创建ResultSethandler，StatementHandler，Executor，Parameterhandler等</li>
</ul>
<p>Configuration的创建流程</p>
<ul>
<li>入口：MyBatis通过XMLConfigBuilder来创建Configuration对象的；XMLConfigBuilder接收一个xml配置文件的输入流，调用parse()方法，返回一个Configuration对象。</li>
<li>XMLConfigBuilder的parse()方法，会先解析configuration标签，然后通过parseConfiguration()这个方法，解析mybatis的所有标签，每一个标签的解析都有一个单独的方法。</li>
<li>当所有的方法都解析完成之后，就得到了我们的configuration对象。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Reader</span> reader <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsReader</span><span class="token punctuation">(</span><span class="token string">"mybatis-config.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建XMLConfigBuilder实例</span>
<span class="token class-name">XMLConfigBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用XMLConfigBuilder.parse（）方法，解析XML创建Configuration对象</span>
<span class="token class-name">Configuration</span> conf <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-2-SqlSessionFactory实例的创建过程"><a href="#5-2-SqlSessionFactory实例的创建过程" class="headerlink" title="5.2 SqlSessionFactory实例的创建过程"></a>5.2 SqlSessionFactory实例的创建过程</h2><p>mybatis中的sqlSession是使用工厂模式创建的。所以在创建sqlSession之前，需要先创建SqlSessionFactory对象；然后调用工厂的openSession()方法，得到一个sqlSession对象。</p>
<p>sqlSession是mybatis面向用户的最顶层的API；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取Mybatis配置文件输入流</span>
<span class="token class-name">Reader</span> reader <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsReader</span><span class="token punctuation">(</span><span class="token string">"mybatis-config.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过SqlSessionFactoryBuilder创建SqlSessionFactory实例</span>
<span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用SqlSessionFactory的openSession（）方法，创建SqlSession实例</span>
<span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了创建sqlSessionFactory对象，首先创建了一个SqlSessionFactoryBuilder对象，然后调用它的build方法，返回一个SqlSessionFactory对象；</p>
<p>那么他的build方法都做了什么事情呢？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">XMLConfigBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>build方法调用重载的build方法，创建了一个XMLConfigBuilder对象，通过XMLConfigBuilder的parse方法得到一个configuration对象，然后再次调用build方法，就可以得到一个SqlSessionFactory对象。</p>
<p>这里的build方法又做了什么呢？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> config<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSessionFactory</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>就是仅仅的一个new而已。这样就<strong>得到了SqlSessionFactory对象</strong>。接下来看<strong>怎么获取sqlSession</strong>呢？</p>
<h2 id="5-3-SqlSession实例化的过程"><a href="#5-3-SqlSession实例化的过程" class="headerlink" title="5.3 SqlSession实例化的过程"></a>5.3 SqlSession实例化的过程</h2><p><strong>得到了SqlSessionFactory对象</strong>。接下来看<strong>怎么获取sqlSession</strong>呢？</p>
<p>拿到sqlSessionFactory后，通过factory的openSession可以得到一个sqlSession对象；openSession都干了什么呢？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">SqlSession</span> <span class="token function">openSessionFromDataSource</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//获取mybatis主配置文件的环境信息</span>
    <span class="token keyword">final</span> <span class="token class-name">Environment</span> environment <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建事务管理器工厂</span>
    <span class="token keyword">final</span> <span class="token class-name">TransactionFactory</span> transactionFactory <span class="token operator">=</span> <span class="token function">getTransactionFactoryFromEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建事务管理器</span>
    tx <span class="token operator">=</span> transactionFactory<span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据mybatis主配置文件的executorType的类型创建对应的executor实例（我们知道mybatis执行sql使用过Executor执行的）</span>
    <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newExecutor</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> execType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建defaultSqlSession实例</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSession</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// may have fetched a connection so lets call close()</span>
    <span class="token function">closeTransaction</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">"Error opening session.  Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取mybatis主配置文件的环境信息，然后通过环境信息获取事务管理器工厂，通过事务管理器工厂获取事务管理器；</p>
<p>然后获取mybatis主配置文件的executorType类型，和事务管理器一起创建Executor实例；</p>
<p>最后获取sqlSession对象。sqlSession对象中持有executor对象的引用，真正执行SQL操作的是Executor对象。</p>
<h1 id="6-SqlSession执行Mapper的过程"><a href="#6-SqlSession执行Mapper的过程" class="headerlink" title="6 SqlSession执行Mapper的过程"></a>6 SqlSession执行Mapper的过程</h1><p>MyBatis的Mapper是由两部分组成：</p>
<ul>
<li>一个是Mapper接口：XXXMapper.java</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">></span></span> <span class="token function">listAllUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from user where id=#&#123;userId,jdbcType=INTEGER&#125;"</span><span class="token punctuation">)</span>
    <span class="token class-name">UserEntity</span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">></span></span> <span class="token function">getUserByEntity</span><span class="token punctuation">(</span> <span class="token class-name">UserEntity</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>一个是通过注解或者是XML配置的：XXXMapper.xml</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">?</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> mapper <span class="token constant">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
        <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>mapper namespace<span class="token operator">=</span><span class="token string">"com.blog4java.mybatis.example.mapper.UserMapper"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>sql id<span class="token operator">=</span><span class="token string">"userAllField"</span><span class="token operator">></span>
      id<span class="token punctuation">,</span>create_time<span class="token punctuation">,</span> name<span class="token punctuation">,</span> password<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> nick_name
    <span class="token operator">&lt;</span><span class="token operator">/</span>sql<span class="token operator">></span>

    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"listAllUser"</span>  resultType<span class="token operator">=</span><span class="token string">"com.blog4java.mybatis.example.entity.UserEntity"</span> <span class="token operator">></span>
        select
        <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">"userAllField"</span><span class="token operator">/</span><span class="token operator">></span>
        from user
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">></span>

<span class="token operator">&lt;</span><span class="token operator">/</span>mapper<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-1-Mapper-接口的注册和获取（动态代理）过程"><a href="#6-1-Mapper-接口的注册和获取（动态代理）过程" class="headerlink" title="6.1 Mapper 接口的注册和获取（动态代理）过程"></a>6.1 Mapper 接口的注册和获取（动态代理）过程</h2><p>既然是说注册和获取过程，肯定是两个部分，注册和获取；我们先从获取来看，因为简单。</p>
<p>Mapper接口用来定义执行SQL语句相关的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span>  <span class="token keyword">void</span> testMybatis <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// ...</span>
       <span class="token comment">// 获取SqlSession实例</span>
       <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 获取UserMapper代理对象</span>
       <span class="token class-name">UserMapper</span> userMapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 执行Mapper方法，获取执行结果</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">></span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">listAllUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>userList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>sqlSession.getMapper()获取了一个UserMapper的引用，返回的这个引用到底是什么呢？</p>
<p>我们知道接口中定义的方法一定要通过某个类实现，然后创建这个实现类的实例，才能调用方法。</p>
<p>那么sqlSession.getMapper()方法返回的一定是某个类的实例，是哪个类呢？</p>
<p>其实返回的是一个动态代理对象；下面从两个部分来解析这个部分：</p>
<ul>
<li>简单而标准的JDK动态代理是什么样子的？</li>
<li>Mybatis的动态代理怎么实现的？</li>
</ul>
<p><strong>简单而标准的动态代理</strong>，代码可以参考mybatis-chapter06</p>
<img src="【mybatis】Mybatis从入门到入土.assets/Ir1XxRhQgNjnKG39bM_HfWNuek7zmX99GosqiHhoA9k.png" alt="image" style="zoom:80%;" />

<p><strong>Mybatis的动态代理怎么实现的？</strong></p>
<img src="【mybatis】Mybatis从入门到入土.assets/sA8c4Sv6GSkiDxHGuXIig0uq8wvE5pflypKz3yN7x6Q.png" alt="image" style="zoom:80%;" />

<p>sqlSession.getmapper做了什么事情呢？</p>
<img src="【mybatis】Mybatis从入门到入土.assets/MZOwlUoFHpxp37EI-6X3gZ5mdx2RIUh-C_GFME_RWkU.png" alt="image" style="zoom:80%;" />

<p>简单的描述就是：</p>
<p>1、SqlSession.getMapper()调用的是DefaultSqlSession中的getMapper();</p>
<p>2、DefaultSqlSession中的getMapper()是从configuration中getMapper中获取；</p>
<p>3、configuration中getMapper调用的是MapperRegistry的getMapper;</p>
<p>4、MapperRegistry的getMapper是从自己的一个属性中获取：knownMappers.get()，获取代理工厂MapperProxyfactory；</p>
<p>5、然后代理工厂MapperProxyfactory通过newInstance方法，调用Proxy(JDK)生成动态代理对象。</p>
<blockquote>
<p>在这里，有一个问题，对比标准的代理方式，我们发现mybatis的代理方式，好像没有持有被代理对象的引用？那么这个动态代理，代理的是什么呢？？ —-&gt; <a href="#6.6.1%20%20Mybatis%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%BB%A3%E7%90%86%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F">按住ctrl,点我查看答案</a></p>
</blockquote>
<p>在第4步中，从knownMappers中后获取代理工厂，拿到代理工厂，就可以创建代理对象了，那么，knownMappers是什么时候注册进去的呢？这里就说了我们的<strong>Mapper接口的注册过程</strong>；</p>
<p>knownMappers是一个Map对象，它里面维护的是：Mapper接口对应的class对象 和 代理工厂对象的关系；</p>
<p>knownMappers是类MapperRegistry的一个属性，在MapperRegister中提供一个方法addMappers，通过这个方法可以注册：Mapper接口对应的class对象 和 代理工厂对象的关系；（同时MapperRegistry还有getMapper方法，可以用来获取）</p>
<p>那么这个addMapper是什么时候调用的呢？？这里先简单的说一下，后面还会再提到。</p>
<p>在Configuration初始化的时候，我们知道Configuration的初始化，是从过XMLConfigBuilder中的parse方法初始化的，在parse方法中初始化了很多的属性，其中就包括mapper的初始化。</p>
<img src="【mybatis】Mybatis从入门到入土.assets/2w3wQEXMBA-jF6EoD1Kycz-7tU6ENXtkCFjA_qYDmK4.png" alt="image" style="zoom:80%;" />

<p>在mapper初始化的方法中mapperElement中，调用了configuration的addMapper方法，然后调用了mapperRegistry.addMappers;最终会调用到我们期望调用的方法；</p>
<h2 id="6-2-Mapper-XML配置信息的解析和注册过程"><a href="#6-2-Mapper-XML配置信息的解析和注册过程" class="headerlink" title="6.2 Mapper XML配置信息的解析和注册过程"></a>6.2 Mapper XML配置信息的解析和注册过程</h2><p>前面说过，MyBatis通过MappedStatement描述Mapper的SQL配置信息，SQL配置有两种方式：</p>
<ul>
<li>一种是通过XML文件配置</li>
<li>一种是通过Java注解（其实本质就是一种轻量级的配置信息）</li>
</ul>
<p>流程图搞了几天，都弄不出来，简单点，用语言描述一下</p>
<p>1、我们知道解析xml，都要解析之后保存在Configuration中，那么找到configuration的解析入口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">XMLConfigBuilder</span>#parseConfiguration<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2、因为这里说的是解析mapper，我们找到专门解析mapper标签的方法；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span>XMLConfigBuilder</span>#mapperElement<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mapperElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> mapperPackage <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里就是将mapper，找到对应的mapper文件和mapper class，保存在mapperRegistry中</span>
        configuration<span class="token punctuation">.</span><span class="token function">addMappers</span><span class="token punctuation">(</span>mapperPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">//通过 resource 属性指定XML文件路径</span>
          <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3、在上面的代码中，进入到</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在这个方法里面解析所有的sql，并将sql生成MappedStatement，保存在configuration中；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">isResourceLoaded</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//调用XPathParser的evalNode()方法获取根节点对应的XNode对象，</span>
    <span class="token comment">//然后开始解析所有的sql</span>
    <span class="token function">configurationElement</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"/mapper"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将资源路径添加到Configuration中</span>
    configuration<span class="token punctuation">.</span><span class="token function">addLoadedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//</span>
    <span class="token function">bindMapperForNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">//之前已经解析过一遍了，如果出了异常，继续解析之前出现异常的ResultMap对象</span>
  <span class="token function">parsePendingResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//之前已经解析过一遍了，如果出了异常，继续解析之前出现异常的CacheRef对象</span>
  <span class="token function">parsePendingCacheRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//之前已经解析过一遍了，如果出了异常，继续解析之前出现异常的select|insert|update|delete对象</span>
  <span class="token function">parsePendingStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4、进入到主要的解析方法中</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span>XMLMapperBuilder</span>#configurationElement<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>,在这个方法里面，解析所有的具体的sql语句；</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configurationElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//获取命名空间，命名空间不能为空</span>
    <span class="token class-name">String</span> namespace <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>namespace <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> namespace<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Mapper's namespace cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//设置当前正在解析的mapper的名称空间</span>
    builderAssistant<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cacheRefElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"cache-ref"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cacheElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"cache"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parameterMapElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/parameterMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resultMapElements</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/resultMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sqlElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/sql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"select|insert|update|delete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error parsing Mapper XML. The XML location is '"</span> <span class="token operator">+</span> resource <span class="token operator">+</span> <span class="token string">"'. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>5、这个方法里面解析了很多，我们以解析crud的sql为例，进入到</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>，然后在进入到</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">org.apache.ibatis.builder.xml.XMLMapperBuilder#buildStatementFromContext(java.util.List&lt;org.apache.ibatis.parsing.XNode&gt;, java.lang.String)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>到这里面就比较清晰了。</p>
<p>6、使用XMLStatementBuilder进行解析，</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">statementParser.parseStatementNode();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>解析的方法很长，就不一一列举了，当解析完成的时候，会调用builderAssistant的方法，这是一个辅助类。</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">public void parseStatementNode() &#123;

  &#x2F;&#x2F;解析select|insert|update|delete标签

  &#x2F;&#x2F;将&lt;include&gt;标签替换成&lt;sql&gt;中的内容

  &#x2F;&#x2F;获取languageDriver对象

  &#x2F;&#x2F; Parse selectKey after includes and remove them.

  &#x2F;&#x2F; Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)

  &#x2F;&#x2F;通过languageDriver解析SQL内容，生成SqlSource对象

  &#x2F;&#x2F;默认的Statement类型是PreparedStatement

  builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,
      fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,
      resultSetTypeEnum, flushCache, useCache, resultOrdered,
      keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>7、在<code>builderAssistant.addMappedStatement</code>中，会调用<code>configuration.addMappedStatement(statement);</code>将生成的MappedStatement放在configuration中。</p>
<h2 id="6-3-Mapper-接口中的方法调用过程"><a href="#6-3-Mapper-接口中的方法调用过程" class="headerlink" title="6.3 Mapper 接口中的方法调用过程"></a>6.3 Mapper 接口中的方法调用过程</h2><p>我们知道，mybatis的方法调用的过程，其实是调用动态代理对象的invoke方法，所以，想知道接口方法的调用过程，就看看invoke方法的执行过程。</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&#x2F;&#x2F; 从SqlSession中获取UserMapper代理对象
UserMapper userMapper &#x3D; sqlSession.getMapper(UserMapper.class);
&#x2F;&#x2F; 执行Mapper方法，获取执行结果
List&lt;UserEntity&gt; userList &#x3D; userMapper.listAllUser();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面代码通过获取到的userMapper调用listAlluser的时候，其实userMapper对象已经是一个动态代理对象了。当这个方法执行的时候，其实执行的是MapperProxy的invoke方法；</p>
<p>MapperProxy的invoke方法的代码很简单：</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;
  try &#123;
    if (Object.class.equals(method.getDeclaringClass())) &#123;
      &#x2F;&#x2F;如果是继承自Object的类，就直接执行，不处理
      return method.invoke(this, args);
    &#125; else &#123;
      &#x2F;&#x2F;通过cachedInvoker获取MapperMethodInvoker
      return cachedInvoker(method).invoke(proxy, method, args, sqlSession);
    &#125;
  &#125; catch (Throwable t) &#123;
    throw ExceptionUtil.unwrapThrowable(t);
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>1、继承自Object的就不说了，看else里面的。</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">cachedInvoker(method)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法是mybatis新版本里面的，之前不是这样的。</p>
<p>2、这个方法主要作用是根据动态代理对象调用的方法，判断是否是默认方法（jdk8提供的接口也可以有方法实现体）</p>
<p>3、如果是默认方法，就获取MethodHandle，然后封装成DefaultMethodInvoker；这里不说，不是我们关注的重点。</p>
<p>4、如果不是默认方法，就是调用的mapper接口中的方法，就获取MapperMethod，然后封装成PlainMethodInvoker；这个是重点。</p>
<p>5、获取到MapperMethodInvoker之后，调用invoke方法，重点关注PlainMethodInvoker的invoke方法内容。在这个方法内部，调用了MapperMethod的execute方法。</p>
<p>6、execute方法中的内容，我们等会再说，先回过头看看MapperMethod是个什么东西？</p>
<p>7、MapperMethod中包含SqlCommand（封装了SQL语句的类型和Mapper的ID）和MethodSignature（方法签名，返回值类型，分页信息和参数信息）；分别来看这两个内部类。</p>
<p>8、SqlCommand：</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">public SqlCommand(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123;
  final String methodName &#x3D; method.getName();
  &#x2F;&#x2F; 获取声明该方法的类或接口的Class对象，目的是为了获取MappedStatement
  final Class&lt;?&gt; declaringClass &#x3D; method.getDeclaringClass();
  &#x2F;&#x2F; 获取描述 insert,update 等标签的MappedStatement对象
  MappedStatement ms &#x3D; resolveMappedStatement(mapperInterface, methodName, declaringClass,
      configuration);

&#x2F;&#x2F; 目的就是为了从MappedStatement中获取id和type
    name &#x3D; ms.getId();
    type &#x3D; ms.getSqlCommandType();

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>9、MethodSignature：</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">public MethodSignature(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123;
  &#x2F;&#x2F;获取方法的返回值类型
  Type resolvedReturnType &#x3D; TypeParameterResolver.resolveReturnType(method, mapperInterface);
  .....
  &#x2F;&#x2F;RowBounds参数位置索引,用于处理后续的分页查询
  this.rowBoundsIndex &#x3D; getUniqueParamIndex(method, RowBounds.class);
  &#x2F;&#x2F;ResultHander参数位置索引，用于处理数据库中检索的每一行数据
  this.resultHandlerIndex &#x3D; getUniqueParamIndex(method, ResultHandler.class);
  &#x2F;&#x2F;ParamNameResolver用于解析Mapper方法参数
  this.paramNameResolver &#x3D; new ParamNameResolver(configuration, method);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中new ParamNameResolver(configuration, method)需要说一说，这个类是用来描述sql的参数信息。</p>
<ul>
<li>将@params注解的参数获取到；</li>
<li>如果没有注解，检查参数useActualParamName，使用参数名称作为sql参数的名字。</li>
<li>获取到所有的参数之后，保存在map中，放在不可变的names中。</li>
</ul>
<p>10、说完了SqlCommand和MethodSignature，在回过头看MapperMethod的execute方法；</p>
<ul>
<li>首先根据SqlCommand对象获取sql语句的类型；</li>
<li>然后根据sql语句的类型调用sqlSession对象对应的方法；（sqlSession是mybatis提供的用户层面的API，方便操作，mybatis中真正执行的是Executor组件）</li>
</ul>
<p>好了，结束了，在往下看，就是sqlSession怎么执行一个sql的了。</p>
<h2 id="6-4-SqlSession执行Mapper的过程"><a href="#6-4-SqlSession执行Mapper的过程" class="headerlink" title="6.4 SqlSession执行Mapper的过程"></a>6.4 SqlSession执行Mapper的过程</h2><p>mybatis生成动态代理之后，调用mapperProxy的invoke方法，在invoke方法中，最终会调用sqlSession的方法，以查询为例子，会调用</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">sqlSession.selectList(command.getName(), param);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>,我们知道sqlSession是mybatis提供的用户层面的API，方便用户查询操作的，所以我们看下他具体是怎么执行查询的呢？</p>
<p>1、selectList会不停的调用重载方法，最终调用到：</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">private &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler) &#123;
  try &#123;
    &#x2F;&#x2F;MappedStatement是在mybatis启动的时候就解析xml加载进来了，这里只是根据sql的ID，拿到具体sql的MappedStatement
    MappedStatement ms &#x3D; configuration.getMappedStatement(statement);
    &#x2F;&#x2F; sqlSession是面向用户的API，真正执行查询的是executor执行器，它是哪里来的？
    &#x2F;&#x2F; 是当前sqlSession自带的，sqlSession哪里来的？是在最开始的时候openSession获取到的，然后session.getMapper将this传进来的。
    &#x2F;&#x2F; executor是在openSession时候赋值的
    return executor.query(ms, wrapCollection(parameter), rowBounds, handler);
  &#125; catch (Exception e) &#123;
    throw ExceptionFactory.wrapException(&quot;Error querying database.  Cause: &quot; + e, e);
  &#125; finally &#123;
    ErrorContext.instance().reset();
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2、然后看executor.query方法</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">
  @Override
  public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException &#123;
    &#x2F;&#x2F;获取BoundSql对象，BoundSql是对动态SQL解析生成的SQL语句和参数映射信息的封装
    BoundSql boundSql &#x3D; ms.getBoundSql(parameter);
    &#x2F;&#x2F;创建cacheKey，用于缓存
    CacheKey key &#x3D; createCacheKey(ms, parameter, rowBounds, boundSql);
    &#x2F;&#x2F;调用重载的query方法
    return query(ms, parameter, rowBounds, resultHandler, key, boundSql);
  &#125;



&#x2F;&#x2F;重载的query方法
  public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException &#123;
    try &#123;
      queryStack++;
      &#x2F;&#x2F;从缓存中获取结果
      list &#x3D; resultHandler &#x3D;&#x3D; null ? (List&lt;E&gt;) localCache.getObject(key) : null;
      if (list !&#x3D; null) &#123;
        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
      &#125; else &#123;
        &#x2F;&#x2F;缓存中获取不到，去数据库里面查询
        list &#x3D; queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
      &#125;

    return list;
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3、可以看到，最终的查询，会走到</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">queryFromDatabase<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法中，这个方法的入参是MappedStatement（sql所有信息），parameter（参数信息），rowBounds（分页信息），resultHandler（处理结果集的），key（用户缓存），boundSql（sql和参数信息）；</p>
<p>4、</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">queryFromDatabase<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>会调用</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">doQuery<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>,它有很多实现，这里SimpleExecutor中的实现为例子:</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Override
public &lt;E&gt; List&lt;E&gt; doQuery(.....) throws SQLException &#123;
  Statement stmt &#x3D; null;
  try &#123;
    Configuration configuration &#x3D; ms.getConfiguration();
    &#x2F;&#x2F;获取StatementHandler(Mybatis)
    StatementHandler handler &#x3D; configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
    &#x2F;&#x2F;创建statement对象，并通过JDBC进行参数设置(JDBC)
    stmt &#x3D; prepareStatement(handler, ms.getStatementLog());
    &#x2F;&#x2F;执行查询(Mybatis)
    return handler.query(stmt, resultHandler);
  &#125; finally &#123;
    closeStatement(stmt);
  &#125;
&#125;


&#x2F;&#x2F;执行查询(Mybatis)
@Override
public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException &#123;
  &#x2F;&#x2F;获取sql语句
  String sql &#x3D; boundSql.getSql();
  &#x2F;&#x2F;JDBC查询
  statement.execute(sql);
  &#x2F;&#x2F;处理结果集
  return resultSetHandler.handleResultSets(statement);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>5、上面步骤中的参数处理，通过获取connection对象，创建statement，执行查询，获取结果，都是mybatis调用JDBC操作的。</p>
<h2 id="6-5-处理结果集"><a href="#6-5-处理结果集" class="headerlink" title="6.5 处理结果集"></a>6.5 处理结果集</h2><p>6、现在来看一下处理结果集</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&#x2F;&#x2F;
@Override
public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException &#123;
  ErrorContext.instance().activity(&quot;handling results&quot;).object(mappedStatement.getId());

  final List&lt;Object&gt; multipleResults &#x3D; new ArrayList&lt;&gt;();

  int resultSetCount &#x3D; 0;
  &#x2F;&#x2F;获取resultSet（JDBC）对象，将ResuleSet对象包装成ResultSetWrapper（MyBatis）
  ResultSetWrapper rsw &#x3D; getFirstResultSet(stmt);

  &#x2F;&#x2F;获取resultMap信息，一般只有一个：在xml中配置的resultMap
  List&lt;ResultMap&gt; resultMaps &#x3D; mappedStatement.getResultMaps();
  int resultMapCount &#x3D; resultMaps.size();
  validateResultMapsCount(rsw, resultMapCount);
  while (rsw !&#x3D; null &amp;&amp; resultMapCount &gt; resultSetCount) &#123;
    ResultMap resultMap &#x3D; resultMaps.get(resultSetCount);
    &#x2F;&#x2F;处理结果集
    handleResultSet(rsw, resultMap, multipleResults, null);
    rsw &#x3D; getNextResultSet(stmt);
    cleanUpAfterHandlingResultSet();
    resultSetCount++;
  &#125;

  &#x2F;&#x2F;这里一样，获取resultSet，也是xml中配置的
  String[] resultSets &#x3D; mappedStatement.getResultSets();
  if (resultSets !&#x3D; null) &#123;
    while (rsw !&#x3D; null &amp;&amp; resultSetCount &lt; resultSets.length) &#123;
      ResultMapping parentMapping &#x3D; nextResultMaps.get(resultSets[resultSetCount]);
      if (parentMapping !&#x3D; null) &#123;
        String nestedResultMapId &#x3D; parentMapping.getNestedResultMapId();
        ResultMap resultMap &#x3D; configuration.getResultMap(nestedResultMapId);
        &#x2F;&#x2F;处理结果集
        handleResultSet(rsw, resultMap, null, parentMapping);
      &#125;
      rsw &#x3D; getNextResultSet(stmt);
      cleanUpAfterHandlingResultSet();
      resultSetCount++;
    &#125;
  &#125;

  &#x2F;&#x2F;返回结果集
  return collapseSingleResultList(multipleResults);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-56问题解决"><a href="#6-56问题解决" class="headerlink" title="6.56问题解决"></a>6.56问题解决</h2><h3 id="6-6-1-Mybatis的动态代理代理的是什么？"><a href="#6-6-1-Mybatis的动态代理代理的是什么？" class="headerlink" title="6.6.1 Mybatis的动态代理代理的是什么？"></a>6.6.1 Mybatis的动态代理代理的是什么？</h3><p>mybatis的动态代理，其实谁都没有代理； 它仅仅只是生成了一个mapper实例，然后利用了动态代理的“切面”功能； 然后统一使用mapperMethod执行sql查询 标准的JDK动态代理，在真正执行的时候会调用method.invoke() Mybatis的动态代理在真正执行的时候根本没用到method</p>
<img src="【mybatis】Mybatis从入门到入土.assets/75hg7lcYF4FCkeoxJwcroQ0L0z6VKwGWiNERUHXwGeQ.png" alt="image" style="zoom:80%;" />

<h1 id="7-Mybatis缓存"><a href="#7-Mybatis缓存" class="headerlink" title="7 Mybatis缓存"></a>7 Mybatis缓存</h1><h2 id="7-1-Mybatis-缓存（一级和二级）的使用"><a href="#7-1-Mybatis-缓存（一级和二级）的使用" class="headerlink" title="7.1 Mybatis 缓存（一级和二级）的使用"></a>7.1 Mybatis 缓存（一级和二级）的使用</h2><p>Mybatis缓存分为一级缓存和二级缓存；</p>
<ul>
<li>一级缓存默认就是开启的，不能关闭，但是可以通过localCacheScope这个属性控制级别，这个参数的取值为SESSION、STATEMENT；</li>
<li>SESSION：缓存对整个SqlSession有效，只有执行DML语句的时候，才会被清除。</li>
<li>STATEMENT：缓存仅对当前执行的语句有效，当语句执行完毕后，缓存就被清空。</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/3RlWYUTSyXpRjSV3kBog5MhiAThQ9ZyFalGFxSr-vWM.png" alt="image" style="zoom:80%;" />

<ul>
<li>二级缓存</li>
<li>mybaits的二级缓存是mapper范围级别（二级缓存是基于namespace级别的，在同一个Mapper下有效），需要的话首先要在mybatis主配置文件中开启缓存&lt;setting name&#x3D;”cacheEnabled”value&#x3D;”true”&#x2F;&gt;</li>
<li>然后在需要二级缓存的具体mapper中配置cache，配置缓存策略，缓存刷新频率，缓存的容量等</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/HnSrXtmhbeYFG8Rz9vtJCsdEmI-oowTIpynDWmp4yTY.png" alt="image" style="zoom:80%;" />

<ul>
<li>在配置mapper时，通过useCache属性执行mapper执行的时候是否使用缓存，还可以通过flushCache属性执行Mapper执行后是否刷新缓存。</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/ZP3e4gYDIp9OX8g-f2wsi-FdgZHWyyIQKt-ndvM0qIg.png" alt="image" style="zoom:80%;" />

<h2 id="7-2-Mybatis缓存框架的实现（装饰者模式）"><a href="#7-2-Mybatis缓存框架的实现（装饰者模式）" class="headerlink" title="7.2 Mybatis缓存框架的实现（装饰者模式）"></a>7.2 Mybatis缓存框架的实现（装饰者模式）</h2><pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">public interface Cache &#123;

  &#x2F;**
   * 获取缓存的id，通常情况下缓存的id是Mapper的命名空间名称
   *&#x2F;
  String getId();

  &#x2F;**
   * 讲一个Java对象添加到缓存中
   *&#x2F;
  void putObject(Object key, Object value);

  Object getObject(Object key);

  Object removeObject(Object key);

  &#x2F;**
   * Clears this cache instance.
   *&#x2F;
  void clear();

  int getSize();

  &#x2F;**
   * 在3.2.6版本后已经不在使用
   *&#x2F;
  default ReadWriteLock getReadWriteLock() &#123;
    return null;
  &#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="【mybatis】Mybatis从入门到入土.assets/-gJXouI-iocqoypYF5uhVARHtXyxs7B1vk5GLjeWc10.png" alt="image" style="zoom:80%;" />

<p>Mybatis的缓存设计采用的是装饰者模式，装饰者模式用的最经典的例子就是Java的IO包，Mybatis同样采用了装饰者模式。</p>
<ul>
<li>提供一个接口Cache，提供缓存的基本操作，比如：put，get，remove，clear等</li>
<li>提供一个基本实现：PerpetualCache，仅使用HashMap存放缓存对象。</li>
<li>提供了大量的装饰器，这些装饰器的构造方法入参就是Cache，比如BlockingCache（阻塞的缓存装饰器），FifoCache（先入先出缓存装饰器）等等</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Test
public void testCache() &#123;
    final int N &#x3D; 100000;
    Cache cache &#x3D; new PerpetualCache(&quot;default&quot;);
    cache &#x3D; new LruCache(cache);
    cache &#x3D; new FifoCache(cache);
    cache &#x3D; new SoftCache(cache);
    cache &#x3D; new WeakCache(cache);
    cache &#x3D; new ScheduledCache(cache);
    cache &#x3D; new SerializedCache(cache);
    cache &#x3D; new SynchronizedCache(cache);
    cache &#x3D; new TransactionalCache(cache);
    for (int i &#x3D; 0; i &lt; N; i++) &#123;
        cache.putObject(i, i);
        ((TransactionalCache) cache).commit();
    &#125;
    System.out.println(cache.getSize());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>另外，还提用了一个CacheBuilder方法构建缓存对象。</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Test
public void testCacheBuilder() &#123;
    final int N &#x3D; 100000;
    Cache cache &#x3D; new CacheBuilder(&quot;com.blog4java.mybatis.example.mapper.UserMapper&quot;)
            .implementation( PerpetualCache.class)
            .addDecorator(LruCache.class)
            .clearInterval(10 * 60L)
            .size(1024)
            .readWrite(false)
            .blocking(false)
            .properties(null)
            .build();
    for (int i &#x3D; 0; i &lt; N; i++) &#123;
        cache.putObject(i, i);
    &#125;
    System.out.println(cache.getSize());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-3-一级缓存的具体实现"><a href="#7-3-一级缓存的具体实现" class="headerlink" title="7.3 一级缓存的具体实现"></a>7.3 一级缓存的具体实现</h2><ul>
<li>我们知道sqlSession是面向用户的API，真正执行的操作的是Executor，以查询为例，在Executor中的具体实现类BaseExecutror中的query方法中，我们知道，执行一个select语句的时候，会先从缓存中获取数据，如果缓存中没有，才会去数据库中查，并且从数据库中查到之后，还会放到缓存中。</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/S0vRu1xQJVhbEbyxcpb9KVAkWuZM1sKv1vgo1edueXU.png" alt="image" style="zoom:80%;" />

<ul>
<li>这里涉及到两个属性，这两个属性存在BaseExecutor中</li>
<li>localCache：Mybatis一级缓存对象，用于缓存Mybatis的查询结果</li>
<li>localOutputParameterCache：Mybatis存储过程输出参数缓存，用于缓存存储过程调用结果</li>
<li>这里主要探讨一下localCache，看一下一级缓存是怎么实现的。</li>
<li>需要了解一下CacheKey的实现，如果两个查询的CacheKey一样，就认定为是同一个sql；</li>
<li>Cache的生成在CacheKey key &#x3D; createCacheKey(ms, parameter, rowBounds, boundSql);</li>
<li>Cache的生成和Mapper的id，执行的sql的参数，以及mapper的的namespace有关；</li>
<li>key生成之后，就是关于一级缓存的使用了（用来做什么的），还是以查询为例，当查询的时候，会先从缓存中获取数据，如果缓存中没有，才会去数据库中查，并且从数据库中查到之后，还会放到缓存中。</li>
<li>注意：如果一级缓存的范围设置为localCacheScope&#x3D;STATEMENT，则每次查询操作完成后，都会清空缓存。</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/q6o8_UiLUVbOQ_y7gHV1CoFAp3qvH30l10IBUlz97x4.png" alt="image" style="zoom:80%;" />

<ul>
<li>注意：在分布式环境下，务必将localCache设置为STATEMENT，避免其他节点执行SQL更新语句之后，本节点缓存得不到刷新而导致数据一致性的问题。</li>
</ul>
<h2 id="7-4-二级缓存的具体实现"><a href="#7-4-二级缓存的具体实现" class="headerlink" title="7.4 二级缓存的具体实现"></a>7.4 二级缓存的具体实现</h2><h3 id="7-4-1-二级缓存的两点常识"><a href="#7-4-1-二级缓存的两点常识" class="headerlink" title="7.4.1 二级缓存的两点常识"></a>7.4.1 二级缓存的两点常识</h3><p>了解二级缓存之前，先了解下面两个常识：</p>
<ul>
<li>二级缓存默认是关闭的，需要开启，具体开启方法，参考：<a href="#7.1%20Mybatis%20%E7%BC%93%E5%AD%98%EF%BC%88%E4%B8%80%E7%BA%A7%E5%92%8C%E4%BA%8C%E7%BA%A7%EF%BC%89%E7%9A%84%E4%BD%BF%E7%94%A8">7.1 Mybatis 缓存（一级和二级）的使用</a></li>
<li>还是以查询为例，真正执行查询的是Executor，Executor有几种不同的实现（BaseExecutor不是实现，是抽象类）</li>
<li>SImpleExecutor</li>
<li>BatchExecutor</li>
<li>ReuseExecutor</li>
<li>CachingExecutor（比较特殊，用到了装饰者模式，在其他几种Executor基础上，增加了二级缓存功能）</li>
</ul>
<h3 id="7-4-2-Mybatis是怎么创建CachingExecutor的呢"><a href="#7-4-2-Mybatis是怎么创建CachingExecutor的呢" class="headerlink" title="7.4.2 Mybatis是怎么创建CachingExecutor的呢"></a>7.4.2 Mybatis是怎么创建CachingExecutor的呢</h3><p>如果我们配置二级缓存为开启状态，那么Mybatis是怎么创建CachingExecutor的呢？涉及到两部分：</p>
<ul>
<li>CachingExecutor是怎么创建出来的？</li>
<li>Executor采用工厂模式创建，Configuration类提供了一个工厂方法，newExecutor</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/yaqhOGttroVfNjfXcV-oeb65dc82IbyaFQsnCV7jLok.png" alt="image" style="zoom:80%;" />

<ul>
<li>可以看到CachingExecutor是对其他三个Executor的<strong>装饰</strong>；</li>
<li>然后再继续分析CachingExecutor的具体实现；</li>
<li>二级缓存开启之后，Mybatis怎么知道它开启了（CacheEnabled这个属性是什么时候初始化的）</li>
<li>在XmlConfigBuilder中，parseConfiguration()中的settingsElement()方法中。</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">configuration.setCacheEnabled(booleanValueOf(props.getProperty(&quot;cacheEnabled&quot;), true));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="7-4-3-CachingEexcutor的具体实现"><a href="#7-4-3-CachingEexcutor的具体实现" class="headerlink" title="7.4.3 CachingEexcutor的具体实现"></a>7.4.3 CachingEexcutor的具体实现</h3><ul>
<li>CachingEexcutor的具体实现</li>
<li>这个类的代码比较少；看他的属性：</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&#x2F;&#x2F;delegate是被装饰的Executor
private final Executor delegate;
&#x2F;&#x2F;这个就比较重要了，用于管理所有的二级缓存对象
private final TransactionalCacheManager tcm &#x3D; new TransactionalCacheManager();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>TransactionalCacheManager的实现</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/z_EJdtrI8-abJABqiy2E2KUL-Y44WXeD6buYhouYfiE.png" alt="image" style="zoom:80%;" />

<ul>
<li>接下来，以查询为例，看看二级缓存是怎么工作的</li>
</ul>
<h3 id="7-4-4-以查询为例，看看二级缓存是怎么工作的"><a href="#7-4-4-以查询为例，看看二级缓存是怎么工作的" class="headerlink" title="7.4.4 以查询为例，看看二级缓存是怎么工作的"></a>7.4.4 以查询为例，看看二级缓存是怎么工作的</h3><ul>
<li>执行查询</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Override
public &lt;E&gt; List&lt;E&gt; query(....) throws SQLException &#123;
  Cache cache &#x3D; ms.getCache();
  if (cache !&#x3D; null) &#123;
    flushCacheIfRequired(ms);
    &#x2F;&#x2F;如果当前sql开启了二级缓存（就是mapper.xml中的select|update|delete|insert标签中使用了useCache&#x3D;true这个属性）
    if (ms.isUseCache() &amp;&amp; resultHandler &#x3D;&#x3D; null) &#123;
      ensureNoOutParams(ms, boundSql);
      &#x2F;&#x2F;先从二级缓存中获取(使用二级缓存管理器TransactionalCacheManager进行获取)
      @SuppressWarnings(&quot;unchecked&quot;)
      List&lt;E&gt; list &#x3D; (List&lt;E&gt;) tcm.getObject(cache, key);
      &#x2F;&#x2F;如果获取不到，就用原来的Executor（也就是被装饰的Executor进行获取）：先从一级缓存拿，拿不到，再从数据库中拿
      if (list &#x3D;&#x3D; null) &#123;
        list &#x3D; delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
        &#x2F;&#x2F; issue #578 and #116
        tcm.putObject(cache, key, list);
      &#125;
      return list;
    &#125;
  &#125;
  return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>执行更新语句</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">@Override
public int update(MappedStatement ms, Object parameterObject) throws SQLException &#123;
  flushCacheIfRequired(ms);
  return delegate.update(ms, parameterObject);
&#125;


private void flushCacheIfRequired(MappedStatement ms) &#123;
  Cache cache &#x3D; ms.getCache();
  &#x2F;&#x2F;判断是否需要刷新缓存，（就是mapper.xml中的select|update|delete|insert标签中使用了flushCache&#x3D;true这个属性）
  if (cache !&#x3D; null &amp;&amp; ms.isFlushCacheRequired()) &#123;
    tcm.clear(cache);
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-4-5-二级缓存Cache实例的创建"><a href="#7-4-5-二级缓存Cache实例的创建" class="headerlink" title="7.4.5 二级缓存Cache实例的创建"></a>7.4.5 二级缓存Cache实例的创建</h3><p>在7.4.4中我们看到，不管是执行查询，还是执行更新，我们都要获取两个参数</p>
<ul>
<li>一个是Cache对象（从MappedStatement中获取的）：这是二级缓存对象–&gt;对应的是mapper.xml中的cache标签</li>
<li>一个就是CacheKey</li>
<li>获取到这两个参数之后，才可以通过二级缓存管理器TransactionalCacheManager获取对应的缓存</li>
</ul>
<p>CacheKey的创建我们已经知道了，是和sqlID，sql的参数信息，nameSpace有关的。那么二级缓存对象实例Cache对象是什么时候创建的，并且是什么时候保存到MappedStatement中的呢？</p>
<ul>
<li>在</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">org.apache.ibatis.builder.xml.XMLMapperBuilder#parse<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法中，会解析cache标签；</p>
<ul>
<li>cache标签解析之后，会通过builderAssistant辅助工具类创建Cache实例（用到的是Cache的builder模式）；</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">public Cache useNewCache(Class&lt;? extends Cache&gt; typeClass,
  Class&lt;? extends Cache&gt; evictionClass,
  Long flushInterval,
  Integer size,
  boolean readWrite,
  boolean blocking,
  Properties props) &#123;
Cache cache &#x3D; new CacheBuilder(currentNamespace)
    .implementation(valueOrDefault(typeClass, PerpetualCache.class))
    .addDecorator(valueOrDefault(evictionClass, LruCache.class))
    .clearInterval(flushInterval)
    .size(size)
    .readWrite(readWrite)
    .blocking(blocking)
    .properties(props)
    .build();
configuration.addCache(cache);
currentCache &#x3D; cache;
return cache;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Cache对象创建完成之后，除了保存到configuration中，还会先<strong>暂时保存</strong>在当前这个辅助工具类中</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">MapperBuilderAssistant<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>然后是什么时候，将cache对象保存到MappedStatement中的呢？</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">private void configurationElement(XNode context) &#123;
try &#123;
  ....
  &#x2F;&#x2F;解析cache标签，生成Cache对象，保存到configuration中，并且暂存在builderAssistant中
  cacheElement(context.evalNode(&quot;cache&quot;));
    .....    
    &#x2F;&#x2F;在这里，解析完select|insert|update|delete,会调用addMappedStatement这个方法
  buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));
&#125; catch (Exception e) &#123;
  throw ...
&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>在上面的代码中，我们知道解析完select|insert|update|delete,会调用</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">org.apache.ibatis.builder.MapperBuilderAssistant#addMappedStatement(...)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">public MappedStatement addMappedStatement(....) &#123;
  ....
  MappedStatement.Builder statementBuilder &#x3D; new MappedStatement.Builder(...)
      .....
      .useCache(valueOrDefault(useCache, isSelect))
      &#x2F;&#x2F;在这里，就将暂存在MapperBuilderAssistant中的cache对象赋值给了MappedStatement
      .cache(currentCache);
  return statement;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-5-问题解决？？？？？"><a href="#7-5-问题解决？？？？？" class="headerlink" title="7.5 问题解决？？？？？"></a>7.5 问题解决？？？？？</h2><h3 id="7-5-1-实际项目中，比如东南亚项目中，怎么控制的缓存呢？"><a href="#7-5-1-实际项目中，比如东南亚项目中，怎么控制的缓存呢？" class="headerlink" title="7.5.1 实际项目中，比如东南亚项目中，怎么控制的缓存呢？"></a>7.5.1 实际项目中，比如东南亚项目中，怎么控制的缓存呢？</h3><p>目前还没有找到答案，应该和mybatis-spring有关，因为代码使用的JavaConfig类进行配置的，不是使用xml，没找到具体的配置在哪里。</p>
<h1 id="8-Mybatis日志实现"><a href="#8-Mybatis日志实现" class="headerlink" title="8 Mybatis日志实现"></a>8 Mybatis日志实现</h1><p>常见的日志框架</p>
<ul>
<li>Log4j：是欧洲一个项目组开发的日志<strong>实现</strong>，现在是apache基金会的一个项目（1996）</li>
<li>Log4j2：是apache开发的日志<strong>实现</strong>，Log4j的升级版（2012）</li>
<li>Commons Logging（JCL）：Apache的，一套Java日志<strong>接口</strong>，本身只有一个简单的<strong>实现</strong>（2002下）</li>
<li>SLF4J：类似于Commons Logging，也是日志<strong>接口</strong>，本身没有实现（2006）</li>
<li>Logback：是日志组件的具体<strong>实现</strong>，属于SLF4J的阵营（2006）</li>
<li>JUL：JDK1.4之后java提供日志<strong>实现</strong>（2002上）</li>
</ul>
<h1 id="9-动态SQL实现原理"><a href="#9-动态SQL实现原理" class="headerlink" title="9 动态SQL实现原理"></a>9 动态SQL实现原理</h1><p>动态SQL，顾名思义，就是事先无法预知具体的条件，需要在运行的时候根据具体的情况动态的生成SQL语句。</p>
<p>比如下面的SQL，就是一个动态的SQL</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&lt;select id&#x3D;&quot;getUserByEntity&quot;  resultType&#x3D;&quot;com.blog4java.mybatis.example.entity.UserEntity&quot;&gt;
    select
    &lt;include refid&#x3D;&quot;userAllField&quot;&#x2F;&gt;
    from user
    &lt;where&gt;
        &lt;if test&#x3D;&quot;id !&#x3D; null&quot;&gt;
            AND id &#x3D; #&#123;id&#125;
        &lt;&#x2F;if&gt;
        &lt;if test&#x3D;&quot;name !&#x3D; null&quot;&gt;
            AND name &#x3D; #&#123;name&#125;
        &lt;&#x2F;if&gt;
        &lt;if test&#x3D;&quot;phone !&#x3D; null&quot;&gt;
            AND phone &#x3D; #&#123;phone&#125;
        &lt;&#x2F;if&gt;
    &lt;&#x2F;where&gt;
&lt;&#x2F;select&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们的入参可能是id，可能是name，可能是phone，也可能是这三个参数中任意两个或者三个的组合。</p>
<p>当我们SQL的参数不固定的时候，生成SQL就需要根据参数动态来增加或者去除关键字，比如添加上WHERE，去掉多余的AND，OR等。</p>
<h2 id="9-1-动态SQL的使用"><a href="#9-1-动态SQL的使用" class="headerlink" title="9.1 动态SQL的使用"></a>9.1 动态SQL的使用</h2><p>主要是一些涉及的标签</p>
<ul>
<li>&lt;choose|when|otherwise&gt;</li>
<li>&lt;trim|set&gt;</li>
</ul>
<h2 id="9-2-SqlSource、BoundSql、LanguageDriver、SqlNode详解和它们之间的关系"><a href="#9-2-SqlSource、BoundSql、LanguageDriver、SqlNode详解和它们之间的关系" class="headerlink" title="9.2 SqlSource、BoundSql、LanguageDriver、SqlNode详解和它们之间的关系"></a>9.2 SqlSource、BoundSql、LanguageDriver、SqlNode详解和它们之间的关系</h2><img src="【mybatis】Mybatis从入门到入土.assets/4ApX3_MkEJJYJUp-QisORKINyjbWe6fjhB9iMRuO6V4.png" alt="image" style="zoom:80%;" />

<h2 id="9-3-动态SQL解析过程"><a href="#9-3-动态SQL解析过程" class="headerlink" title="9.3 动态SQL解析过程"></a>9.3 动态SQL解析过程</h2><p>SqlSource有四个实现，分别是ProviderSqlSource,DynamicSqlSource,RawSqlSource,StaticSqlSource; 其中StaticSqlSource比较特殊，它是用来描述通过ProviderSqlSource,SynamicSqlSource,RawSqlSource解析之后得到的静态sql资源。</p>
<ul>
<li>1、通过注解或者xml配置的sql怎么封装成SqlSource对象的？（SqlSource是怎么来的）</li>
<li>是通过LanguageDriver将Sql配置解析成SqlSource的，什么时候解析的呢？解析的逻辑是什么呢？</li>
<li>是在XmlMapperBuilder中解析select|update|delete|insert语句的时候，会获取到LanguageDriver对象，然后将XNode解析成SqlSource对象</li>
<li>解析的逻辑就是，LanguageDriver通过创建XmlScriptBuilder对象，进行解析，具体逻辑后面说；</li>
<li>2、SqlSource又是怎么解析最后转换成StaticSqlSource的？</li>
<li>比如一个动态sql资源，解析之后肯定一个静态的sql资源；</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/pEIcEuUUVLmiZMER0tKvgXf714RH58QFpihw6DPdkwI.png" alt="image" style="zoom:80%;" />

<ul>
<li>那么就是从DynamicSqlSource转换成StaticSqlSource的过程，是在：</li>
<li>DynamicSqlSource中的getBoundSql方法中会调用SqlSourceBuilder的parse方法</li>
<li>SqlSourceBuilder的parse方法会返回一个sqlSource（返回的这个就是StaticSqlSource）</li>
<li>LanguageDriver通过创建XmlScriptBuilder对象，进行解析，这是解析的具体逻辑（Xnode–&gt;SqlSource的过程）</li>
</ul>
<p>比如一个动态sql：</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&lt;select id&#x3D;&quot;getUserByEntity&quot;  resultType&#x3D;&quot;com.blog4java.mybatis.example.entity.UserEntity&quot;&gt;
    select
    &lt;include refid&#x3D;&quot;userAllField&quot;&#x2F;&gt;
    from user
    &lt;where&gt;
        &lt;if test&#x3D;&quot;id !&#x3D; null&quot;&gt;
            AND id &#x3D; #&#123;id&#125;
        &lt;&#x2F;if&gt;
        &lt;if test&#x3D;&quot;name !&#x3D; null&quot;&gt;
            AND name &#x3D; #&#123;name&#125;
        &lt;&#x2F;if&gt;
        &lt;if test&#x3D;&quot;phone !&#x3D; null&quot;&gt;
            AND phone &#x3D; #&#123;phone&#125;
        &lt;&#x2F;if&gt;
    &lt;&#x2F;where&gt;
&lt;&#x2F;select&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它解析成的SqlSource的格式是下面这样的</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">

DynamicSqlSource
    MixSqlNode
        1、StaticTextSqlNode select
        2、StaticTextSqlNode id,name.phone
        3、StaticTextSqlNode from user
        4、WhereSqlNode where
            MixSqlNode
                1、StaticTextSqlNode &quot;空&quot;
                2、IfSqlNode if
                    MixSqlNode
                        StaticTextSqlNode AND id &#x3D; #&#123;id&#125;
                        test id !&#x3D; null
                3、StaticTextSqlNode &quot;空&quot;
                4、IfSqlNode if
                    MixSqlNode
                        StaticTextSqlNode AND name &#x3D; #&#123;name&#125;
                        test name !&#x3D; null
                5、StaticTextSqlNode &quot;空&quot;
                6、IfSqlNode if
                    MixSqlNode
                        StaticTextSqlNode AND phone &#x3D; #&#123;phone&#125;
                        test phone !&#x3D; null            
                7、StaticTextSqlNode &quot;空&quot;
         5、StaticTextSqlNode &quot;空&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>问题：SqlNode中有一个apply，用于解析sql，替换占位符，生成静态sql，这个方法什么时候调用的呢？</li>
<li>在通过sqlSource的getBoundSql方法调用的时候，会调用apply方法</li>
<li>那么sqlSource的getBoundSql什么时候调用的呢？</li>
<li>我们知道Mybatis是通过MappedStatement保存sql各种信息的，那么理所当然，MappedStatement中有一个sqlSource的引用，是在XMLMapperBuilder中通过languageDriver解析获取到SqlSource之后，然后通过MapperBuilderAssistant.addMappedStatement方法，会将sqlSource存在MappedStatement中。</li>
<li>在MappedStatement中也有一个getBoundSql方法，这个方法会在真正执行sql之前调用</li>
<li>sqlSource的getBoundSql会解析动态sql，但是我们知道sqlSource中存的不过是SqlNode，而sqlNode中可能包含很多AND，OR等关键字，那么这些关键字在apply方法的时候，是怎么被去掉的呢？</li>
<li>以where为例子，我们现在获取到了select * from user 然后下一句是 AND phone &#x3D; #{phone} 我们就需要把AND去掉，然后加上WHERE，拼接成这个样子 WHERE phone&#x3D;#{phone}</li>
<li>这一步，是在TrimSqlNode中做的，为什么是在这里呢，因为WhereSqlNode是TrimSqlNode的子类，在apply的时候，会创建FilteredDynamicContext这个类，然后会调用applyAll这个方法，在这个方法里，会判断当前的SqlSource的类型，是WHERE的话，就把AND去掉改成Where，同理TrimSqlNode的另一个子类SetSqlNode也是这样的，将And替换成Set。</li>
<li>其他的替换，都是类似的</li>
</ul>
<h2 id="9-4-分析-和-的区别"><a href="#9-4-分析-和-的区别" class="headerlink" title="9.4 分析${}和#{}的区别"></a>9.4 分析${}和#{}的区别</h2><p>${}：当使用这个占位符的时候，Mybatis会使用TextSqlNode来进行描述，在解析的时候，会直接将参数进行替换，比如一个sql</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">select * from user where name &#x3D; $&#123;name&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>,假设前端给的参数是</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">String name &#x3D; &quot;zhangsan&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>，那么解析之后得到的最终sql就是</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">select * from user where name &#x3D; zhangsan<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>,这个sql是会报错的。当使用这个占位符的时候，参数应该这么传</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">String name &#x3D; &quot;&#39;zhangsan&#39;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>,手动加上引号。</p>
<p>#{}：略</p>
<h1 id="10-MyBatis插件实现原理"><a href="#10-MyBatis插件实现原理" class="headerlink" title="10 MyBatis插件实现原理"></a>10 MyBatis插件实现原理</h1><h2 id="10-1-Mybatis插件的使用"><a href="#10-1-Mybatis插件的使用" class="headerlink" title="10.1 Mybatis插件的使用"></a>10.1 Mybatis插件的使用</h2><ul>
<li>首先有一个已经写好的Mybatis拦截器类，怎么写？可以参考10.4自定义拦截器插件</li>
<li>对拦截器进行配置，在MyBatis的主配置文件中：</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&lt;plugins&gt;
      &lt;plugin interceptor&#x3D;&quot;com.blog4java.plugin.pager.PageInterceptor&quot;&gt;
          &lt;property name&#x3D;&quot;databaseType&quot; value&#x3D;&quot;hsqldb&quot;&#x2F;&gt;
      &lt;&#x2F;plugin&gt;

      &lt;plugin interceptor&#x3D;&quot;com.blog4java.plugin.slowsql.SlowSqlInterceptor&quot;&gt;
          &lt;property name&#x3D;&quot;limitSecond&quot; value&#x3D;&quot;0&quot;&#x2F;&gt;
      &lt;&#x2F;plugin&gt;
  &lt;&#x2F;plugins&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>这样，这个拦截器就生效了。</li>
</ul>
<h2 id="10-2-Mybatis拦截器的拦截节点（可以拦截哪些方法）"><a href="#10-2-Mybatis拦截器的拦截节点（可以拦截哪些方法）" class="headerlink" title="10.2 Mybatis拦截器的拦截节点（可以拦截哪些方法）"></a>10.2 Mybatis拦截器的拦截节点（可以拦截哪些方法）</h2><p>用户自定义的插件，只能针对MyBatis中的4个组件中的部分方法进行拦截</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>方法</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Executor</td>
<td>update</td>
<td></td>
</tr>
<tr>
<td></td>
<td>query</td>
<td></td>
</tr>
<tr>
<td></td>
<td>flushStatements</td>
<td></td>
</tr>
<tr>
<td></td>
<td>commit</td>
<td></td>
</tr>
<tr>
<td></td>
<td>rollback</td>
<td></td>
</tr>
<tr>
<td></td>
<td>getTransaction</td>
<td></td>
</tr>
<tr>
<td></td>
<td>close</td>
<td></td>
</tr>
<tr>
<td></td>
<td>isClosed</td>
<td></td>
</tr>
<tr>
<td>ParameterHandler</td>
<td>getparameterObject</td>
<td></td>
</tr>
<tr>
<td></td>
<td>setParameters</td>
<td></td>
</tr>
<tr>
<td>ResultSetHandler</td>
<td>handleResultSets</td>
<td></td>
</tr>
<tr>
<td></td>
<td>handleOutputParameters</td>
<td></td>
</tr>
<tr>
<td>StatementHandler</td>
<td>prepare</td>
<td></td>
</tr>
<tr>
<td></td>
<td>parameterize</td>
<td></td>
</tr>
<tr>
<td></td>
<td>batch</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update</td>
<td></td>
</tr>
<tr>
<td></td>
<td>query</td>
<td></td>
</tr>
</tbody></table>
<h2 id="10-3-Mybatis插件的注册和拦截过程（原理：动态代理）"><a href="#10-3-Mybatis插件的注册和拦截过程（原理：动态代理）" class="headerlink" title="10.3 Mybatis插件的注册和拦截过程（原理：动态代理）"></a>10.3 Mybatis插件的注册和拦截过程（原理：动态代理）</h2><p>分为两个部分，注册和执行拦截；</p>
<p>注册</p>
<ul>
<li><p>在configuration中有一个<code>interceptorChain</code>属性，用来保存所有的通过标签配置的拦截器实例；</p>
</li>
<li><p>在XMLConfigBuilder中构建configuration的时候，有一个方法专门解析的</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pluginElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">String</span> interceptor <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"interceptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Properties</span> properties <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getChildrenAsProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//通过java的反射机制，创建拦截器实例</span>
      <span class="token class-name">Interceptor</span> interceptorInstance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span><span class="token punctuation">)</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      interceptorInstance<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
      configuration<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>interceptorInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解析完成之后，将生成的拦截器实例，保存在 <code>interceptorChain </code>中；执行拦截.</p>
<p>那么拦截逻辑是怎么执行的呢？</p>
<p>之前说过，configuration有三大作用，其中一个作用就是：作为Executor, ParameterHandler, ResultSetHandler, StatementHandler组件的工厂，便于创建这些组件的实例， [点我查看configuration的三个作用](#Configuration)</p>
<p>统一使用工厂创建者四个类的实例，这样做的好处是什么呢？</p>
<ul>
<li>将创建的类的实例统一起来，可以根据用于配置参数的不同，创建不同的实例：比如用户使用了缓存，就会创建CacheExecutor一样；</li>
<li>可以在工厂方法中，执行拦截逻辑；</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
statementHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>statementHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
resultSetHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultSetHandler</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>resultSetHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
parameterHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ParameterHandler</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>parameterHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
executor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拦截逻辑都是在pluginAll中执行的。至于pluginAll到底做了什么，我们待会在看。</p>
<p>以Executor组件为例（其他3个类同理），看一下Configuration的newExecutor是怎么创建代理对象的。</p>
<p>![image-20210223162433312](<a target="_blank" rel="noopener" href="https://youdao-note-【mybatis】mybatis从入门到入土.assets.oss-cn-hangzhou.aliyuncs.com/2021-02/20210223162434.png">https://youdao-note-【mybatis】Mybatis从入门到入土.assets.oss-cn-hangzhou.aliyuncs.com/2021-02/20210223162434.png</a>)</p>
<p>当我们系统中配置了Plugin的时候，生成的Executor才是动态代理对象，否则生成的就是Executor对象；因为</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">pluginAll</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//没有拦截器配置，就不会执行plugin，也就不会生成动态代理对象</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span> interceptor <span class="token operator">:</span> interceptors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    target <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以sqlSession的selectOne为例，被代理的Executor执行query方法的调用链路图；</p>
<ul>
<li>被代理的Executor对象，会先执行到Plugin类的invoke方法中</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/2KSB9I7XUzXCy41tQEljCCAlPax8LvCgTdoSUdio7QQ.png" alt="image" style="zoom:80%;" />

<h2 id="10-4-自定义Mybatis拦截器"><a href="#10-4-自定义Mybatis拦截器" class="headerlink" title="10.4 自定义Mybatis拦截器"></a>10.4 自定义Mybatis拦截器</h2><p>拦截器代码</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">
&#x2F;**
 * @author : zhuansun
 * @date : 2021-02-23 16:48
 **&#x2F;
@Intercepts( &#123;
    &#x2F;&#x2F;指定拦截Executor的query方法，因为query方法有很多个，我们要通过args执行拦截入参是这些的query方法
    &#x2F;&#x2F;&lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException;
    @Signature(type &#x3D; Executor.class, method &#x3D; &quot;query&quot;, args &#x3D; &#123;MappedStatement.class,
        Object.class, RowBounds.class, ResultHandler.class&#125;)
&#125;)
public class ZspcSqlInterceptor implements Interceptor &#123;

    &#x2F;**
     * 这个参数可以通过&lt;plugin&gt;标签中的&lt;properties&gt;设值
     *&#x2F;
    private String name;

    @Override
    public Object intercept(Invocation invocation) throws Throwable &#123;

        System.out.println(&quot;111111&quot;+name);

        return invocation.proceed();
    &#125;

    @Override
    public Object plugin(Object target) &#123;
        return Plugin.wrap(target, this);
    &#125;

    @Override
    public void setProperties(Properties properties) &#123;
        this.name &#x3D; (String) properties.get(&quot;name&quot;);
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Mybatis配置拦截器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>plugins<span class="token punctuation">></span></span>

    <span class="token operator">&lt;</span>plugin interceptor<span class="token operator">=</span><span class="token string">"com.blog4java.plugin.zspc.ZspcSqlInterceptor"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"name"</span> value<span class="token operator">=</span><span class="token string">"我就试试"</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">></span>

<span class="token operator">&lt;</span><span class="token operator">/</span>plugins<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPageInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">UserQuery</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">setFull</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">></span></span> users <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getUserPageable</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总数据量："</span> <span class="token operator">+</span> query<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",总页数："</span>
            <span class="token operator">+</span> query<span class="token punctuation">.</span><span class="token function">getTotalPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"，当前查询数据："</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token number">111111</span>我就试试
总数据量：<span class="token number">0</span><span class="token punctuation">,</span>总页数：<span class="token number">0</span>，当前查询数据：<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User1"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User2"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User3"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User4"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User5"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User6"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User7"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User8"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User9"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User10"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User11"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User12"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User13"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token operator">:</span><span class="token string">"User14"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"phone"</span><span class="token operator">:</span><span class="token string">"18700001111"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
<span class="token class-name">Disconnected</span> from the target <span class="token constant">VM</span><span class="token punctuation">,</span> address<span class="token operator">:</span> '<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">60862</span>'<span class="token punctuation">,</span> transport<span class="token operator">:</span> <span class="token char">'socket'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="11-MyBatis级联映射与懒加载"><a href="#11-MyBatis级联映射与懒加载" class="headerlink" title="11 MyBatis级联映射与懒加载"></a>11 MyBatis级联映射与懒加载</h1><h2 id="11-1-级联映射的介绍与使用"><a href="#11-1-级联映射的介绍与使用" class="headerlink" title="11.1 级联映射的介绍与使用"></a>11.1 级联映射的介绍与使用</h2><ul>
<li>知道什么是级联映射</li>
<li>级联映射的配置（一对多配置 collection，一对一配置 association）</li>
<li>discriminator 鉴别器</li>
</ul>
<p>有一个用户表，有一个订单表，订单表存了用户表的id</p>
<p>比如用户表：id,name(用户名),phone(手机号)</p>
<p>比如订单表：id,userId(用户id),orderNo(订单号),amount(订单金额)</p>
<p>现在有一个需求，我们想查出一个用户，同时查出来这个用户下的所有订单；当然我们有几个方法：</p>
<ul>
<li>先查出user，再根据user查出来订单，最后封装返回值；</li>
<li>使用MyBatis的级联映射</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&#x2F;&#x2F;使用级联映射，resultMap指定为detailMap
&lt;select id&#x3D;&quot;getUserByIdFull&quot; resultMap&#x3D;&quot;detailMap&quot;&gt;
  select * from user where id &#x3D; #&#123;userId&#125;
&lt;&#x2F;select&gt;
&#x2F;&#x2F;这是detialMap的定义，type是User类型的，里面包含一个collection,指定property为User类的orders属性
&#x2F;&#x2F;ofType标识orders属性的类是Order类
&#x2F;&#x2F;select标识要执行OrderMapper中的listOrderByUserId这个sql查出来的数据填充orders这个属性
&lt;resultMap id&#x3D;&quot;detailMap&quot; type&#x3D;&quot;com.blog4java.mybatis.example.entity.User&quot;&gt;
   &lt;collection property&#x3D;&quot;orders&quot; ofType&#x3D;&quot;com.blog4java.mybatis.example.entity.Order&quot;
                  select&#x3D;&quot;com.blog4java.mybatis.example.mapper.OrderMapper.listOrdersByUserId&quot;
                  javaType&#x3D;&quot;java.util.ArrayList&quot;
                  column&#x3D;&quot;id&quot;&gt;
   &lt;&#x2F;collection&gt;
&lt;&#x2F;resultMap&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面是比较简单的级联映射的配置；当然难得也有，比如：</p>
<p>一对多级联映射；</p>
<p>一对一级联映射；</p>
<p>如果我们的需求升级了，用户性别是女的才查订单信息，否则就不查询订单信息；这个时候需要使用到Discriminator。这个的作用类似java中的switch</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&lt;resultMap id&#x3D;&quot;detailMapForDiscriminator&quot; type&#x3D;&quot;com.blog4java.mybatis.example.entity.User&quot;&gt;
    &lt;discriminator javaType&#x3D;&quot;String&quot; column&#x3D;&quot;gender&quot;&gt;
        &lt;case value&#x3D;&quot;female&quot; resultType&#x3D;&quot;com.blog4java.mybatis.example.entity.User&quot;&gt;
            &lt;collection property&#x3D;&quot;orders&quot; ofType&#x3D;&quot;com.blog4java.mybatis.example.entity.Order&quot;
                        select&#x3D;&quot;com.blog4java.mybatis.example.mapper.OrderMapper.listOrdersByUserId&quot;
                        javaType&#x3D;&quot;java.util.ArrayList&quot;
                        column&#x3D;&quot;id&quot;&gt;
            &lt;&#x2F;collection&gt;
        &lt;&#x2F;case&gt;
    &lt;&#x2F;discriminator&gt;
&lt;&#x2F;resultMap&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-2-懒加载机制的介绍与使用"><a href="#11-2-懒加载机制的介绍与使用" class="headerlink" title="11.2 懒加载机制的介绍与使用"></a>11.2 懒加载机制的介绍与使用</h2><p><strong>注意：懒加载本身就是针对级联查询的，对于普通查询，没有懒加载一说’</strong></p>
<p>有这样一个需求，当我们查询用户的时候，如果每次都带出订单信息，但是并不是所有使用到的地方都需要使用订单信息，这样的话，每次都带出，就多了一步这么无用的查询。</p>
<p>那么我们可不可以在调用用户的getOrders方法的时候，就是说当我们确定要拿用户的订单信息的时候，再去数据库里面查询出来。这就叫做懒加载。</p>
<p>MyBatis提供了懒加载机制：</p>
<ul>
<li>在MyBatis的主配置文件中，提供了lazaLoadingEnabled和aggressiveLazyLoading两个参数用于控制是否开启懒加载；</li>
<li>lazaLoadingEnabled：是否开启懒加载 true开启</li>
<li>aggressiveLazyLoading：控制ResultMap默认的加载行为，false表示懒加载，true表示积极加载</li>
<li>标签提供了一个fetchType属性，为</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">lazy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>表示懒加载，为</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">eager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>表示积极加载</p>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">&lt;settings&gt;
   ...
    &lt;!-- 打开延迟加载的开关 --&gt;
    &lt;setting name&#x3D;&quot;lazyLoadingEnabled&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;
    &lt;!-- 将积极加载改为懒加载即按需加载 --&gt;
    &lt;setting name&#x3D;&quot;aggressiveLazyLoading&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;
    &lt;!-- toString,hashCode等方法不触发懒加载 --&gt;
    &lt;setting name&#x3D;&quot;lazyLoadTriggerMethods&quot; value&#x3D;&quot;&quot;&#x2F;&gt;
    ...
&lt;&#x2F;settings&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-3-级联查询和懒加载的原理"><a href="#11-3-级联查询和懒加载的原理" class="headerlink" title="11.3 级联查询和懒加载的原理"></a>11.3 级联查询和懒加载的原理</h2><ul>
<li>首先是标签转换成ResultMap对象的逻辑，也是在XMLCOnfigBuilder中解析的，看看代码就知道了。</li>
<li>其次是级联查询的实现逻辑：</li>
<li>知道一个sql在查询完成之后，会使用ResultSetHandler对象的handleResultSets方法处理结果集；</li>
<li>handleResultSets方法简化了JDBC对ResultSet对象的操作，会在这里将级联查询的结果进行处理与赋值；</li>
<li>再详细的就不说了，注意一点：级联查询的第二个sql是什么时候执行的呢？可以参考<a href="#11.4%20%E9%97%AE%E9%A2%98">点我跳转查看</a></li>
<li>懒加载的实现逻辑</li>
<li>在处理级联查询的结果集的时候，也就是在handleResultSets方法中；</li>
<li>在handleResultSets方法中调用handleRowValues；</li>
<li>然后根据是否是否有嵌套的ResultMap，调用handleRowValuesForNestedResultMap或者handleRowValuesForSimpleResultMap，这都不重要；</li>
<li>重要的是最终会调用到getRowValue方法；</li>
<li>然后会调用到createResultObject这个方法，在这个方法内部，如果开启了懒加载，则调用createProxy创建代理对象（CgLib代理或者javassist代理，只有这两种）；</li>
<li>也就是说，对于开启了懒加载的查询，返回的不是User的实例，而是User实例的代理对象；</li>
<li>当我们执行了User实例代理对象的get方法，就会执行代理类的拦截逻辑；</li>
<li>在拦截逻辑中，会调用到lazyLoader的load方法，最后调用到LoadPair的load方法；</li>
<li>然后会创建ResultLoader对象，最后调用到</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">resultLoader.loadResult()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>，至此完成；</p>
<ul>
<li>懒加载最后一步和正常不开启懒加载的的查询，其实调用的是同一个方法。</li>
</ul>
<h2 id="11-4-问题"><a href="#11-4-问题" class="headerlink" title="11.4 问题"></a>11.4 问题</h2><ul>
<li>Mybatis的级联查询，是执行一次sql，还是执行多次sql？</li>
</ul>
<img src="【mybatis】Mybatis从入门到入土.assets/WU1bC7GCTaqfR93WF6GZyxDzDGb_U3DIwPnscF3awwc.png" alt="image" style="zoom:80%;" />

<ul>
<li>从测试的结果来看，是执行了多次sql，那么第二次的sql是在什么时候执行的呢？</li>
</ul>
<p>他娘的，要骂人了。在跑测试用例的时候，一直很好奇，明天控制台打印出了两个sql，为什么断点只能看到一个。而且IDEA还会有这个提示：</p>
<img src="【mybatis】Mybatis从入门到入土.assets/rQzgBZ0o9gq2FaPOBMqu3WbmwTx1632pZxk5yAM1zS4.png" alt="image"  />

<p>一开始没有在意，还以为是自己断点的位置不对，最后针对这个提示，百度了一下，了解到：</p>
<ul>
<li>IDEA对于在toString中调用的方法，是不会走到断点的。具体了解的可以自己百度，很多的。</li>
<li>按照百度的设置，我们把相关设置配置好，最后才发现：</li>
<li>我说为什么断点只能进来一次，原来是因为测试用例默认开启了懒加载；</li>
<li>这就导致查询用户的时候的断点可以进来，在查询order的时候，因为是在toString中调用的，IDEA直接跳过了。</li>
<li>修改了相关配置后，第二个sql就可以断点进来啦。</li>
<li>最后我们测试关闭懒加载模式，看看第二个sql是什么时候调用的呢？</li>
<li>实在第一个sql执行完的之后，处理第一个sql的结果集的时候，在getRowValue方法中，调用applyPropertyMappings方法，然后调用getPropertyMappingValue方法，然后调用getNestedQueryMappingValue方法，然后调用</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">value &#x3D; resultLoader.loadResult()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>方法，在这个方法内部，执行了第二个sql的查询。</p>
<h1 id="12-MyBatis与Spring整合"><a href="#12-MyBatis与Spring整合" class="headerlink" title="12 MyBatis与Spring整合"></a>12 MyBatis与Spring整合</h1><p><strong>简介</strong></p>
<ul>
<li>我们知道MyBatis是使用sqlSession操作数据库的；</li>
<li>我们知道sqlSession是通过sqlSessionFactory.openSession获取的；</li>
<li>在mybatis-spring中，我们使用spring提供的</li>
</ul>
<pre class="line-numbers language-Plain" data-language="Plain"><div class="caption"><span>Text</span></div><code class="language-Plain">SqlSessionFactoryBean<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>来创建sqlSessionFactory对象</p>
<ul>
<li>在mybatis中，使用sqlSessionFactory.openSession每次都会获取一个新的sqlSession对象，然后调用sqlSession的相关方法就可以与数据库交互了。</li>
<li>在mybatis-spring中，spring提供了sqlSessionTemplate用于完成数据库交互，它是单例的。</li>
</ul>
<p><strong>原理</strong></p>
<ul>
<li>spring容器在启动的时候，会将bean的配置信息转换成BeanDefinition对象，BeanDefinition是一个接口，有很多实现类，用来描述不同方式配置的Bean信息；</li>
<li>BeanDefinition有一个容器，叫做BeanDefinitionRegistry，所有的Bean信息都会注册到里面；另外，spring对BeanDefinitionRegistry提供了扩展机制，允许用户在spring框架启动时，动态的注册bean信息；</li>
<li>现在我们有了Bean信息，有个Bean信息的容器，spring框架在启动的时候，会根据bean信息创建生成bean实例，并保存在BeanFactory中，他们都是单例的。</li>
<li>BeanFactoryPostProcessor</li>
<li>ImportBeanDefinitionRegister</li>
<li>BeanPostProcessor</li>
<li>ClassPathBeanDefinitionScanner</li>
<li>FactoryBean：可以理解为生成Bean的，当我们获取FactoryBean的时候，其实获取的是FactoryBean对象getObject方法返回的实例，比如配置SqlSessionFactoryBean，其实获取的是SqlSessionFactory</li>
</ul>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text">1 环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%E5%AF%BC%E5%85%A5IDEA"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 下载源码导入IDEA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-HSQLDB%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 HSQLDB数据库简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-JDBC%E7%9F%A5%E8%AF%86%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">2 JDBC知识准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-JDBC%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 JDBC是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-JDBC%E6%80%8E%E4%B9%88%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 JDBC怎么用?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%BA%90%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.2.1.</span> <span class="toc-text">* 与数据源建立连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8CSQL%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">* 执行SQL语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2SQL%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">2.2.3.</span> <span class="toc-text">* 检索SQL执行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.2.4.</span> <span class="toc-text">* 关闭连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-JDBC%E6%A0%B8%E5%BF%83%E7%B1%BB%E8%A7%A3%E8%AF%BB"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 JDBC核心类解读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Connection"><span class="toc-number">2.3.1.</span> <span class="toc-text">Connection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Statement"><span class="toc-number">2.3.2.</span> <span class="toc-text">Statement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResultSet"><span class="toc-number">2.3.3.</span> <span class="toc-text">ResultSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataBaseMetaData"><span class="toc-number">2.3.4.</span> <span class="toc-text">DataBaseMetaData</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-JDBC%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 JDBC事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Mybatis%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">3.</span> <span class="toc-text">3 Mybatis常用工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-SQL%E7%B1%BB"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 SQL类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-SqlRunner%E5%92%8CScriptRunner"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 SqlRunner和ScriptRunner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MetaObject%E5%92%8CMetaClass"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MetaObject和MetaClass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-ObjectFactory%E5%92%8CProxyFactory"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 ObjectFactory和ProxyFactory</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Mybatis%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.</span> <span class="toc-text">4 Mybatis核心组件介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E4%BD%BF%E7%94%A8Mybatis%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 使用Mybatis操作数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Mybatis%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Mybatis核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Configuration"><span class="toc-number">4.2.1.</span> <span class="toc-text">Configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MappedStatement"><span class="toc-number">4.2.2.</span> <span class="toc-text">MappedStatement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSession"><span class="toc-number">4.2.3.</span> <span class="toc-text">SqlSession</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Executor"><span class="toc-number">4.2.4.</span> <span class="toc-text">Executor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StatementHandler"><span class="toc-number">4.2.5.</span> <span class="toc-text">StatementHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ParameterHandler"><span class="toc-number">4.2.6.</span> <span class="toc-text">ParameterHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ResultSetHandler"><span class="toc-number">4.2.7.</span> <span class="toc-text">ResultSetHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TypeHandler"><span class="toc-number">4.2.8.</span> <span class="toc-text">TypeHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.2.9.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-SqlSession%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">5 SqlSession的创建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Configuration%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 Configuration实例的创建过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-SqlSessionFactory%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 SqlSessionFactory实例的创建过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-SqlSession%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 SqlSession实例化的过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-SqlSession%E6%89%A7%E8%A1%8CMapper%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">6 SqlSession执行Mapper的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-Mapper-%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%B3%A8%E5%86%8C%E5%92%8C%E8%8E%B7%E5%8F%96%EF%BC%88%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%EF%BC%89%E8%BF%87%E7%A8%8B"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 Mapper 接口的注册和获取（动态代理）过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-Mapper-XML%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E7%9A%84%E8%A7%A3%E6%9E%90%E5%92%8C%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 Mapper XML配置信息的解析和注册过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-Mapper-%E6%8E%A5%E5%8F%A3%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 Mapper 接口中的方法调用过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-SqlSession%E6%89%A7%E8%A1%8CMapper%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 SqlSession执行Mapper的过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%9C%E9%9B%86"><span class="toc-number">6.5.</span> <span class="toc-text">6.5 处理结果集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-56%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">6.6.</span> <span class="toc-text">6.56问题解决</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-1-Mybatis%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%BB%A3%E7%90%86%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">6.6.1.</span> <span class="toc-text">6.6.1 Mybatis的动态代理代理的是什么？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Mybatis%E7%BC%93%E5%AD%98"><span class="toc-number">7.</span> <span class="toc-text">7 Mybatis缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Mybatis-%E7%BC%93%E5%AD%98%EF%BC%88%E4%B8%80%E7%BA%A7%E5%92%8C%E4%BA%8C%E7%BA%A7%EF%BC%89%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 Mybatis 缓存（一级和二级）的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-Mybatis%E7%BC%93%E5%AD%98%E6%A1%86%E6%9E%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%88%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 Mybatis缓存框架的实现（装饰者模式）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.3.</span> <span class="toc-text">7.3 一级缓存的具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.4.</span> <span class="toc-text">7.4 二级缓存的具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E4%B8%A4%E7%82%B9%E5%B8%B8%E8%AF%86"><span class="toc-number">7.4.1.</span> <span class="toc-text">7.4.1 二级缓存的两点常识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2-Mybatis%E6%98%AF%E6%80%8E%E4%B9%88%E5%88%9B%E5%BB%BACachingExecutor%E7%9A%84%E5%91%A2"><span class="toc-number">7.4.2.</span> <span class="toc-text">7.4.2 Mybatis是怎么创建CachingExecutor的呢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3-CachingEexcutor%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.4.3.</span> <span class="toc-text">7.4.3 CachingEexcutor的具体实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-4-%E4%BB%A5%E6%9F%A5%E8%AF%A2%E4%B8%BA%E4%BE%8B%EF%BC%8C%E7%9C%8B%E7%9C%8B%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="toc-number">7.4.4.</span> <span class="toc-text">7.4.4 以查询为例，看看二级缓存是怎么工作的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-5-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98Cache%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">7.4.5.</span> <span class="toc-text">7.4.5 二级缓存Cache实例的创建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%EF%BC%9F%EF%BC%9F%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="toc-number">7.5.</span> <span class="toc-text">7.5 问题解决？？？？？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-1-%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE%E4%B8%AD%EF%BC%8C%E6%AF%94%E5%A6%82%E4%B8%9C%E5%8D%97%E4%BA%9A%E9%A1%B9%E7%9B%AE%E4%B8%AD%EF%BC%8C%E6%80%8E%E4%B9%88%E6%8E%A7%E5%88%B6%E7%9A%84%E7%BC%93%E5%AD%98%E5%91%A2%EF%BC%9F"><span class="toc-number">7.5.1.</span> <span class="toc-text">7.5.1 实际项目中，比如东南亚项目中，怎么控制的缓存呢？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Mybatis%E6%97%A5%E5%BF%97%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">8 Mybatis日志实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E5%8A%A8%E6%80%81SQL%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">9 动态SQL实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%8A%A8%E6%80%81SQL%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">9.1.</span> <span class="toc-text">9.1 动态SQL的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-SqlSource%E3%80%81BoundSql%E3%80%81LanguageDriver%E3%80%81SqlNode%E8%AF%A6%E8%A7%A3%E5%92%8C%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">9.2.</span> <span class="toc-text">9.2 SqlSource、BoundSql、LanguageDriver、SqlNode详解和它们之间的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%8A%A8%E6%80%81SQL%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">9.3.</span> <span class="toc-text">9.3 动态SQL解析过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E5%88%86%E6%9E%90-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">9.4.</span> <span class="toc-text">9.4 分析${}和#{}的区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-MyBatis%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">10.</span> <span class="toc-text">10 MyBatis插件实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-Mybatis%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 Mybatis插件的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Mybatis%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E6%8B%A6%E6%88%AA%E8%8A%82%E7%82%B9%EF%BC%88%E5%8F%AF%E4%BB%A5%E6%8B%A6%E6%88%AA%E5%93%AA%E4%BA%9B%E6%96%B9%E6%B3%95%EF%BC%89"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 Mybatis拦截器的拦截节点（可以拦截哪些方法）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-Mybatis%E6%8F%92%E4%BB%B6%E7%9A%84%E6%B3%A8%E5%86%8C%E5%92%8C%E6%8B%A6%E6%88%AA%E8%BF%87%E7%A8%8B%EF%BC%88%E5%8E%9F%E7%90%86%EF%BC%9A%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%EF%BC%89"><span class="toc-number">10.3.</span> <span class="toc-text">10.3 Mybatis插件的注册和拦截过程（原理：动态代理）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E8%87%AA%E5%AE%9A%E4%B9%89Mybatis%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">10.4.</span> <span class="toc-text">10.4 自定义Mybatis拦截器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-MyBatis%E7%BA%A7%E8%81%94%E6%98%A0%E5%B0%84%E4%B8%8E%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">11.</span> <span class="toc-text">11 MyBatis级联映射与懒加载</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E7%BA%A7%E8%81%94%E6%98%A0%E5%B0%84%E7%9A%84%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">11.1.</span> <span class="toc-text">11.1 级联映射的介绍与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E6%87%92%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">11.2.</span> <span class="toc-text">11.2 懒加载机制的介绍与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E7%BA%A7%E8%81%94%E6%9F%A5%E8%AF%A2%E5%92%8C%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">11.3.</span> <span class="toc-text">11.3 级联查询和懒加载的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-4-%E9%97%AE%E9%A2%98"><span class="toc-number">11.4.</span> <span class="toc-text">11.4 问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-MyBatis%E4%B8%8ESpring%E6%95%B4%E5%90%88"><span class="toc-number">12.</span> <span class="toc-text">12 MyBatis与Spring整合</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2022/10/31/Ds1pc4HTNxezk2r.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 张三</div><div class="footer_custom_text"><a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备2023014267号</a></div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>