<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>spring注解AOP开发和源码解读及实践 | 张三碎碎念</title><meta name="author" content="zs"><meta name="copyright" content="zs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="spring注解AOP开发和源码解读及实践本文主要介绍spring的aop，基于注解和XML的简单使用和源码解读, 本文涉及的所有图片，如果不清晰，可以下载PDF文件进行查看： AOP的使用在了解使用之前，我们需要先了解一下：execution表达式 execution表达式&#x2F;&#x2F; 任意公共方法的执行： execution(public * *(..))  &#x2F;&#x2F;任何一个以“set”开始的方法的执行：">
<meta property="og:type" content="article">
<meta property="og:title" content="spring注解AOP开发和源码解读及实践">
<meta property="og:url" content="https://zspcer.gitee.io/note/JAVA/SSM%E4%B8%89%E5%A4%A7%E6%A1%86%E6%9E%B6/%E3%80%90spring%E3%80%91spring%E6%B3%A8%E8%A7%A3AOP%E5%BC%80%E5%8F%91%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%8F%8A%E5%AE%9E%E8%B7%B5/index.html">
<meta property="og:site_name" content="张三碎碎念">
<meta property="og:description" content="spring注解AOP开发和源码解读及实践本文主要介绍spring的aop，基于注解和XML的简单使用和源码解读, 本文涉及的所有图片，如果不清晰，可以下载PDF文件进行查看： AOP的使用在了解使用之前，我们需要先了解一下：execution表达式 execution表达式&#x2F;&#x2F; 任意公共方法的执行： execution(public * *(..))  &#x2F;&#x2F;任何一个以“set”开始的方法的执行：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/10/31/JCPQ9ogz7USpYlb.jpg">
<meta property="article:published_time" content="2023-02-23T13:45:00.880Z">
<meta property="article:modified_time" content="2023-02-23T13:45:00.880Z">
<meta property="article:author" content="zs">
<meta property="article:tag" content="spring">
<meta property="article:tag" content="源码解读">
<meta property="article:tag" content="AOP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/10/31/JCPQ9ogz7USpYlb.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zspcer.gitee.io/note/JAVA/SSM%E4%B8%89%E5%A4%A7%E6%A1%86%E6%9E%B6/%E3%80%90spring%E3%80%91spring%E6%B3%A8%E8%A7%A3AOP%E5%BC%80%E5%8F%91%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%8F%8A%E5%AE%9E%E8%B7%B5/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'spring注解AOP开发和源码解读及实践',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-23 13:45:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="张三碎碎念" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">54</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">85</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/alist/"><i class="fa-fw fas fa-folder"></i><span> 网盘</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/10/31/JCPQ9ogz7USpYlb.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">张三碎碎念</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/alist/"><i class="fa-fw fas fa-folder"></i><span> 网盘</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">spring注解AOP开发和源码解读及实践</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-23T13:45:00.880Z" title="发表于 2023-02-23 13:45:00">2023-02-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-23T13:45:00.880Z" title="更新于 2023-02-23 13:45:00">2023-02-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/">JAVA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/SSM%E4%B8%89%E5%A4%A7%E6%A1%86%E6%9E%B6/">SSM三大框架</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="spring注解AOP开发和源码解读及实践"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="spring注解AOP开发和源码解读及实践"><a href="#spring注解AOP开发和源码解读及实践" class="headerlink" title="spring注解AOP开发和源码解读及实践"></a>spring注解AOP开发和源码解读及实践</h1><p>本文主要介绍spring的aop，基于注解和XML的简单使用和源码解读, 本文涉及的所有图片，如果不清晰，可以下载PDF文件进行查看：</p>
<h2 id="AOP的使用"><a href="#AOP的使用" class="headerlink" title="AOP的使用"></a>AOP的使用</h2><p>在了解使用之前，我们需要先了解一下：execution表达式</p>
<h3 id="execution表达式"><a href="#execution表达式" class="headerlink" title="execution表达式"></a>execution表达式</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 任意公共方法的执行：</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//任何一个以“set”开始的方法的执行：</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> set<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//AccountService 接口的任意方法的执行：</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xyz<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AccountService</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//定义在service包里的任意方法的执行：</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> com<span class="token punctuation">.</span>xyz<span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//定义在service包和所有子包里的任意类的任意方法的执行：</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> com<span class="token punctuation">.</span>xyz<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//定义在pointcutexp包和所有子包里的JoinPointObjP2类的任意方法的执行：</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>pointcutexp<span class="token punctuation">.</span><span class="token punctuation">.</span>JoinPointObjP2<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="基于注解的使用"><a href="#基于注解的使用" class="headerlink" title="基于注解的使用"></a>基于注解的使用</h3><p>目前最火的使用方式就是基于注解的使用方式，避免了大量的配置文件，而且易于管理和维护。简单明了，推荐使用。</p>
<h4 id="导入aop所必须的最小maven依赖"><a href="#导入aop所必须的最小maven依赖" class="headerlink" title="导入aop所必须的最小maven依赖"></a>导入aop所必须的最小maven依赖</h4><ul>
<li><p>1.spring的aop依赖于spring的ioc容器，所以需要导入spring-context,同时spirng-context中已经引入了spring-aop，所以就不需要单独的引入spring-aop了。</p>
</li>
<li><p>2.spring的aop依赖于强大的AspectJ，所以需要引入aspectjweaver的依赖，但是spring-aspects已经加入了这个依赖，所以，只需要再引入spring-aspects就可以了。</p>
</li>
<li><p>3.关于为什么只引入这两个依赖，请移步：<a href="#spring-aop%E5%92%8CaspectJ%E7%9A%84%E5%85%B3%E7%B3%BB">spring-aop和aspectJ的关系</a></p>
</li>
<li><p>4.最后，我们自己会编写了一些测试方法，所以需要引入Junit的依赖。</p>
</li>
</ul>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.3.12.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-aspects<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.3.12.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221222163808764.png" alt="image-20221222163808764" style="zoom:80%;" />



<h4 id="实现业务逻辑类"><a href="#实现业务逻辑类" class="headerlink" title="实现业务逻辑类"></a>实现业务逻辑类</h4><ul>
<li><p>在这个实例中，具体的业务逻辑类是： com.zspc.core.spring.aop.service.Calculator</p>
</li>
<li><p>我们想要的目的是：在业务逻辑运行的时候将日志进行打印（方法之前、方法运行结束、方法出现异常，等等等）</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Calculator</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 计算两个数的除法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开始计算-->除数:"</span><span class="token operator">+</span>a<span class="token operator">+</span><span class="token string">",被除数:"</span><span class="token operator">+</span>b<span class="token operator">+</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> a<span class="token operator">/</span>b<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="实现具体的日志切面类"><a href="#实现具体的日志切面类" class="headerlink" title="实现具体的日志切面类"></a>实现具体的日志切面类</h4><ul>
<li><p>之前说到，我们的目的是：在业务逻辑类运行的时候将日志进行打印（方法之前、方法运行结束、方法出现异常，等等等）</p>
</li>
<li><p>所以我们需要一个切面类，切面类里面的方法需要动态感知Calculator.div(int,int)方法运行到哪里然后执行通知方法；</p>
</li>
<li><p>环绕通知：目标方法运行前后都运行，需要手动运行joinPoint.proceed()，才能推进目标方法的执行，对应切面类中的logAround()</p>
</li>
<li><p>前置通知：目标方法运行之前运行，对应切面类中的logStart()</p>
</li>
<li><p>后置通知：目标方法运行之后，结束之前（无论方法正常结束(return)还是异常结束(exception)）运行，对应切面类中的logAfter()</p>
</li>
<li><p>返回通知：目标方法返回之后运行，对应切面类中logReturn()</p>
</li>
<li><p>异常通知：目标方法发生异常的时候运行，该异常运行后，返回通知不会运行，对应切面类中的logException()</p>
</li>
<li><p>执行流程：环绕通知开始–&gt;前置通知–&gt;环绕通知joinPoint.proceed()–&gt;环绕通知结束–&gt;后置通知–&gt;返回通知&#x2F;异常通知</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogAspect</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logStart</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logEnd</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logReturn</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Object</span> result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logException</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">logAround</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="对切面类的方法添加注解，标注执行时机"><a href="#对切面类的方法添加注解，标注执行时机" class="headerlink" title="对切面类的方法添加注解，标注执行时机"></a>对切面类的方法添加注解，标注执行时机</h4><ul>
<li><p>对切面类添加注解,并指定切面</p>
<ul>
<li><p>@Around</p>
</li>
<li><p>@Before</p>
</li>
<li><p>@After</p>
</li>
<li><p>@AfterReturning</p>
</li>
<li><p>@AfterThrowing</p>
</li>
</ul>
</li>
<li><p>指定切面有两种方法</p>
<ul>
<li><p>定义一个公共的切面方法，@Pointcut(“execution (xxxxx)”)，并在切面类注解中引入</p>
</li>
<li><p>直接在切面类注解中指定切面：@Before(“com.xxx.xxx.xxx()”)</p>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogAspect</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//抽取公共的切入点表达式</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* com.zspc.core.spring.aop.service.Calculator.*(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointCut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"pointCut()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logStart</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"pointCut()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logEnd</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">,</span> returning <span class="token operator">=</span> <span class="token string">"result"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logReturn</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Object</span> result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//....</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">,</span> throwing <span class="token operator">=</span> <span class="token string">"exception"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logException</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pointCut()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">logAround</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="告诉spring哪个类是切面类"><a href="#告诉spring哪个类是切面类" class="headerlink" title="告诉spring哪个类是切面类"></a>告诉spring哪个类是切面类</h4><ul>
<li>就是给切面类加上 @Aspect 注解，让spirng容器知道这是一个切面类。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogAspect</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//....省略...</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="将切面类和业务逻辑类纳入spirng管理"><a href="#将切面类和业务逻辑类纳入spirng管理" class="headerlink" title="将切面类和业务逻辑类纳入spirng管理"></a>将切面类和业务逻辑类纳入spirng管理</h4><ul>
<li>就是在配置类中添加@Bean</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token variable">@Configuration</span>
<span class="token keyword">public</span> class MainConfig &#123;


    <span class="token variable">@Bean</span>
    <span class="token keyword">public</span> LogAspect logAspect<span class="token punctuation">(</span><span class="token punctuation">)</span> &#123;
        <span class="token keyword">return</span> new LogAspect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    &#125;


    <span class="token variable">@Bean</span>
    <span class="token keyword">public</span> Calculator calculator<span class="token punctuation">(</span><span class="token punctuation">)</span> &#123;
        <span class="token keyword">return</span> new Calculator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    &#125;

&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="开启基于注解的aop模式"><a href="#开启基于注解的aop模式" class="headerlink" title="开启基于注解的aop模式"></a>开启基于注解的aop模式</h4><ul>
<li>给配置类添加@EnableAspectJAutoProxy,，这样spring才能识别所有的aop注解。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainConfig</span> <span class="token punctuation">&#123;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">LogAspect</span> <span class="token function">logAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LogAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Calculator</span> <span class="token function">calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="最后一步，编写测试类，进行测试"><a href="#最后一步，编写测试类，进行测试" class="headerlink" title="最后一步，编写测试类，进行测试"></a>最后一步，编写测试类，进行测试</h4><ul>
<li>测试类</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">MainConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Calculator</span> calculator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Calculator</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"calculator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> div <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>测试结果</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">环绕通知开始
前置通知运行。。。参数列表是：<span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
开始计算<span class="token operator">--</span><span class="token operator">></span>除数<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span>被除数<span class="token operator">:</span><span class="token number">5.</span>
环绕通知结束
后置通知运行。。。<span class="token annotation punctuation">@After</span>
返回通知运行。。。<span class="token annotation punctuation">@AfterReturning</span><span class="token operator">:</span>运行结果：<span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">&#125;</span>
<span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="基于XML的使用"><a href="#基于XML的使用" class="headerlink" title="基于XML的使用"></a>基于XML的使用</h3><h4 id="略"><a href="#略" class="headerlink" title="略"></a>略</h4><p>这个就不说了，和上面差不多</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> 
       <span class="token attr-name"><span class="token namespace">xmlns:</span>aop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/aop<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans 
       http://www.springframework.org/schema/beans/spring-beans.xsd 
       http://www.springframework.org/schema/aop 
       http://www.springframework.org/schema/aop/spring-aop.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logAspect<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.zspc.core.spring.aop.config.LogAspect<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>calculator<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.zspc.core.spring.aop.service.Calculator<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logAspect<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>execution (* com.zspc.core.spring.aop.service.Calculator.*(..))<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pointCut<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pointCut<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logStart<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-returning</span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pointCut<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logReturn<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-throwing</span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pointCut<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logException<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token comment">&lt;!--&lt;aop:after pointcut-ref="pointCut" method="doAfter"/>--></span>
            <span class="token comment">&lt;!--&lt;aop:around pointcut-ref="pointCut" method="doAround"/>--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="AOP的源码流程分析"><a href="#AOP的源码流程分析" class="headerlink" title="AOP的源码流程分析"></a>AOP的源码流程分析</h2><p>对于任何的源码分析，都做到三步分析，就可以非常明确了：</p>
<ul>
<li><p>看给容器中注入了什么组件</p>
</li>
<li><p>这个组件什么时候工作</p>
</li>
<li><p>这个组件的功能是什么</p>
</li>
</ul>
<p>从 <code>@EnableAspectJAutoProxy </code> 开始</p>
<h3 id="EnableAspectJAutoProxy-是什么，干啥用的"><a href="#EnableAspectJAutoProxy-是什么，干啥用的" class="headerlink" title="@EnableAspectJAutoProxy 是什么，干啥用的"></a>@EnableAspectJAutoProxy 是什么，干啥用的</h3><p>结论先行：<code>@EnableAspectJAutoProxy</code>的作用就是为了给我们的容器中注入一个：<code>AnnotationAwareAspectJAutoProxyCreator</code></p>
<p>先看看这个注解类<code>EnableAspectJAutoProxy.java</code>的源码:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Documented</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ElementType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Retention</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RetentionPolicy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">AspectJAutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAspectJAutoProxy</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><code>EnableAspectJAutoProxy.java</code>类上有一个注解： <code>@Import(&#123;AspectJAutoProxyRegistrar.class&#125;)</code>： </p>
<ul>
<li><code>@Import</code>这个注解给容器中导入了一个组件 <code>AspectJAutoProxyRegistrar</code></li>
</ul>
</li>
<li><p><code>AspectJAutoProxyRegistrar</code>这个组件是干嘛呢？ 我们点进去看他的继承关系，源码如下：</p>
<ul>
<li><p>&#96;&#96;&#96;java<br>  package org.springframework.context.annotation;</p>
<p>  import org.springframework.aop.config.AopConfigUtils;<br>  import org.springframework.beans.factory.support.BeanDefinitionRegistry;<br>  import org.springframework.core.annotation.AnnotationAttributes;<br>  import org.springframework.core.type.AnnotationMetadata;</p>
<p>  class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar {<br>  AspectJAutoProxyRegistrar() {<br>  }<br><br>  public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {<br>      AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);<br>      AnnotationAttributes enableAspectJAutoProxy &#x3D; AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);<br>      if (enableAspectJAutoProxy !&#x3D; null) {<br>          if (enableAspectJAutoProxy.getBoolean(“proxyTargetClass”)) {<br>              AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);<br>          }<br><br>          if (enableAspectJAutoProxy.getBoolean(“exposeProxy”)) {<br>              AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);<br>          }<br>      }<br>  }<br>  }</p>
  <pre class="line-numbers language-none"><code class="language-none">
    - &#96;class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar &#96; 这个类继承自 &#96;ImportBeanDefinitionRegistrar&#96;

    - 我们发现他是一个 &#96;ImportBeanDefinitionRegistrar &#96;，通过之前的学习，我们知道&#96;ImportBeanDefinitionRegistrar&#96;的作用是：
        - 使用&#96;@Import&#96;的时候，可以指定&#96;ImportBeanDefinationRegitrar.&#96;
        - 自定义一个类实现&#96;ImportBeanDefinationRegistrar&#96;接口,并实现&#96;resisterBeanDefinatons&#96;方法，在这个方法里面，可以指定需要注册的组件。
        - 使用&#96;ImportBeanDefinationRegistrar&#96;,可以指定bean名，以及作用域之类的，比之前两种方式拥有更多的定制性
        - 关于这些作用，看不懂，没关系，可以参考：

    - 所以，我们要看看&#96;AspectJAutoProxyRegistrar&#96;这个到底给我们容器中注入了什么东西？
        - &#96;AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);&#96; 通过这行代码，我们看到他给我们注册了一个&#96;AspectJAnnotationAutoProxyCreator&#96;如果需要的话。
        - 一直点进去这个方法，最后会看到给我们的容器中注入了一个bean：
        - 注入的bean的名字叫做：&#96;org.springframework.aop.config.internalAutoProxyCreator&#96;
        - 注入的bena的实际对象是：&#96;org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator&#96;

简单的说就是：EnableAspectJAutoProxy 使用了 @Import，@Import导入了一个AspectJAutoProxyRegistrar ，这个Register继承自ImportBeanDefinitionRegister，并实现了registerBeanDifinitions方法，向容器中注册了一个：AnnotationAwareAspectJAutoProxyCreator

总结：&#96;@EnableAspectJAutoProxy&#96;的作用就是为了给我们的容器中注入一个：&#96;AnnotationAwareAspectJAutoProxyCreator&#96;

以下是示意图（图中也有步骤说明）

&lt;img src&#x3D;&quot;【spring】spring注解AOP开发和源码解读及实践.assets&#x2F;image-20221222170945180.png&quot; alt&#x3D;&quot;image-20221222170945180&quot; style&#x3D;&quot;zoom: 33%;&quot; &#x2F;&gt;





### AnnotationAwareAspectJAutoProxyCreator 是什么？干啥用的？

- 我们看看这个类&#96;AnnotationAwareAspectJAutoProxyCreator.java&#96;的继承关系：
    - class AnnotationAwareAspectJAutoProxyCreator extends AspectJAwareAdvisorAutoProxyCreator
    - class AspectJAwareAdvisorAutoProxyCreator extends AbstractAdvisorAutoProxyCreator
    - class AbstractAdvisorAutoProxyCreator extends AbstractAutoProxyCreator
    - class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware
    - 到这里就到底了，我们发现了两个重要的接口：
        - &#96;SmartInstantiationAwareBeanPostProcessor&#96;：是一个后置处理器xxxxBeanPostProcessor，我们知道在spirng中，后置处理器是一个非常重要的概念，他会在bean的初始化前后做一些工作。所以，我们要看这个&#96;SmartInstantiationAwareBeanPostProcessor&#96;到底做了什么，实现了我们的aop的强大功能
        - &#96;BeanFactoryAware&#96;：实现了这个接口的bean，可以直接访问 Spring 容器，该bean被容器创建以后，它会拥有一个指向 Spring 容器（也就是BeanFactory）的引用，可以利用该bean根据传入参数动态获取被spring工厂加载的其他的所有的bean。 eg：这部分是IOC的内容，我们不扯那么多

&lt;img src&#x3D;&quot;【spring】spring注解AOP开发和源码解读及实践.assets&#x2F;znInKzNU3RP5vLmcaq7ij3QsxgXDADDfgxV76ZhS-58.png&quot; alt&#x3D;&quot;znInKzNU3RP5vLmcaq7ij3QsxgXDADDfgxV76ZhS-58&quot; style&#x3D;&quot;zoom: 25%;&quot; &#x2F;&gt;



- AnnotationAwareAspectJAutoProxyCreator 作为 xxxBeanPostProcessor 做了什么工作

- AnnotationAwareAspectJAutoProxyCreator 作为 BeanFactoryAware 做了什么工作

- 在分析上面两个问题之前，我们先来看看AnnotationAwareAspectJAutoProxyCreator是什么时候被创建的。

- 在之前，我们知道@EnableAspectJAutoProxy的给我们的容器中注入一个：AnnotationAwareAspectJAutoProxyCreator

- 同时，我们知道AnnotationAwareAspectJAutoProxyCreator的作用主要是作为一个后置处理器，在bean的创建前后做一些工作，以及实现了BeanFactoryAware接口，可以直接与spring容器进行操作。

- 那么，AnnotationAwareAspectJAutoProxyCreator是什么时候被创建的呢？



### AnnotationAwareAspectJAutoProxyCreator 是什么时候被创建的

- 从程序的入口开始看，这里的入口是指我们的测试类，也就是下面这段代码

&#96;&#96;&#96;java
public class AOPTest &#123;
    @Test
    public void testAop() &#123;
        ApplicationContext applicationContext &#x3D; new AnnotationConfigApplicationContext(MainConfig.class);
        Calculator calculator &#x3D; (Calculator) applicationContext.getBean(&quot;calculator&quot;);
        int div &#x3D; calculator.div(2, 1);
        System.out.println(div);
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>new AnnotationConfigApplicationContext(MainConfig.class)： 传入配置类，创建Spring容器</p>
</li>
<li><p>点击进去构造方法，在创建容器的时候，有一个非常重要的方法叫做：refresh();</p>
</li>
<li><p>refresh()方式是整个IOC容器创建的关键，对于他的解释，看下面的说明，关于refresh()方法，在本文中不是重点，可以略过…</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token comment">// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符</span>
      <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，</span>
      <span class="token comment">// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，</span>
      <span class="token comment">// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-> beanDefinition 的 map)</span>
      <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean</span>
      <span class="token comment">// 这块待会会展开说</span>
      <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
         <span class="token comment">// 【这里需要知道 BeanFactoryPostProcessor 这个知识点，Bean 如果实现了此接口，</span>
         <span class="token comment">// 那么在容器初始化以后，Spring 会负责调用里面的 postProcessBeanFactory 方法。】</span>

         <span class="token comment">// 这里是提供给子类的扩展点，到这里的时候，所有的 Bean 都加载、注册完成了，但是都还没有初始化</span>
         <span class="token comment">// 具体的子类可以在这步的时候添加一些特殊的 BeanFactoryPostProcessor 的实现类或做点什么事</span>
         <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 方法</span>
         <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 注册 BeanPostProcessor 的实现类，注意看和 BeanFactoryPostProcessor 的区别</span>
         <span class="token comment">// 此接口两个方法: postProcessBeforeInitialization 和 postProcessAfterInitialization</span>
         <span class="token comment">// 两个方法分别在 Bean 初始化之前和初始化之后得到执行。注意，到这里 Bean 还没初始化</span>
         <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 初始化当前 ApplicationContext 的 MessageSource，国际化这里就不展开说了，不然没完没了了</span>
         <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 初始化当前 ApplicationContext 的事件广播器，这里也不展开了</span>
         <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 从方法名就可以知道，典型的模板方法(钩子方法)，</span>
         <span class="token comment">// 具体的子类可以在这里初始化一些特殊的 Bean（在初始化 singleton beans 之前）</span>
         <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 注册事件监听器，监听器需要实现 ApplicationListener 接口。这也不是我们的重点，过</span>
         <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 重点，重点，重点</span>
         <span class="token comment">// 初始化所有的 singleton beans</span>
         <span class="token comment">//（lazy-init 的除外）</span>
         <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 最后，广播事件，ApplicationContext 初始化完成</span>
         <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - "</span> <span class="token operator">+</span>
                  <span class="token string">"cancelling refresh attempt: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>

         <span class="token comment">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="token comment">// 销毁已经初始化的 singleton 的 Beans，以免有些 bean 会一直占用资源</span>
         <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// Reset 'active' flag.</span>
         <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 把异常往外抛</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
         <span class="token comment">// Reset common introspection caches in Spring's core, since we</span>
         <span class="token comment">// might not ever need metadata for singleton beans anymore...</span>
         <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>在refresh()方法中，调用了registerBeanPostProcessors(beanFactory);用来注册xxxBeanPostProcessor后置处理器。</p>
</li>
<li><p>正如我们的标题：AnnotationAwareAspectJAutoProxyCreator类，他其实就是一个继承了SmartInstantiationAwareBeanPostProcessor的一个后置处理器。</p>
</li>
<li><p>所以这个方法里面，其实就创建了我们的AnnotationAwareAspectJAutoProxyCreator类。</p>
<ul>
<li><p>作者注：registerBeanPostProcessors(beanFactory)是用来注册xxxBeanPostProcessor的，但是我们的AnnotationAwareAspectJAutoProxyCreator不是以BeanPostProcessor结尾的，能创建它吗？</p>
</li>
<li><p>作者注：当然是能的，在这里，一开始没转过弯，我们要知道我们的AnnotationAwareAspectJAutoProxyCreator虽然不是BeanPostProcessor结尾的，但是他可是继承了xxxBeanPostProcessor的，所以他也是一个BeanPostProcessor。</p>
</li>
</ul>
</li>
<li><p>知道了registerBeanPostProcessors(beanFactory)是用来注册xxxBeanPostProcessor，所以我们知道我们的AnnotationAwareAspectJAutoProxyCreator类也是在这里创建的，那么我们进去看看。</p>
</li>
<li><p>首先获取所有等待注册的xxxBeanPostProcessor的定义，注意这里只是定义！并不是真正的bean。：String[] postProcessorNames &#x3D; beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);</p>
</li>
<li><p>怎么理解这里所说的“定义”呢？</p>
<ul>
<li><p>就相当于我出门买东西，要买牙刷，牙膏，洗衣液，衣架. 我列了一个清单。</p>
</li>
<li><p>这个清单，是所有要买的东西的定义，但是它不是真正的东西！</p>
</li>
</ul>
</li>
<li><p>下一步，对所有的xxxBeanPostProcessor进行归类，并且按类分别生成Bean,这里就是生成真正的Bean了。</p>
</li>
<li><p>归类，共分为三类：继承了PriorityOrdered的为一类，继承了Ordered的为一类，剩下的为一类。</p>
</li>
<li><p>然后对这三类，分别进行注册。</p>
<ul>
<li><p>优先注册实现了PriorityOrdered接口的BeanPostProcessor； </p>
</li>
<li><p>再给容器中注册实现了Ordered接口的BeanPostProcessor；</p>
</li>
<li><p>最后注册没实现优先级接口的BeanPostProcessor；</p>
</li>
</ul>
</li>
<li><p>所谓的注册，实际上就是创建BeanPostProcessor的具体Bean实例，放在容器里。</p>
</li>
<li><p>现在，我们知道了，所谓的注册，实际上就是创建BeanPostProcessor的具体Bean实例，并且我们知道了在哪里注册我们的BeanPostProcessor。下面我们具体看看怎么注册的。</p>
</li>
<li><p>在看怎么注册的之前，明确一点：在spring启动的时候，会注册很多xxxBeanPostProcessor，我们现在先不需要关注其他的，我们关注的是</p>
</li>
<li><p>bean 的定义为：InternalAutoProxyCreator</p>
</li>
<li><p>创建的bean实例为：AnnonationAwareAspectJAutoProxyCreator</p>
</li>
<li><p>主要是关注这个，其他的我们先不看</p>
</li>
<li><p>之前我们说了，在refresh()方法中，会注册BeanPostProcessor，而且是按照分类进行注册的。</p>
</li>
<li><p>下面这个图，是上面这部分逻辑的图示（图中有说明）</p>
</li>
</ul>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221222174926824.png" alt="image-20221222174926824" style="zoom: 67%;" />



<ul>
<li>我们的关注点：AnnontationAwareAspectJAutpProxyCreator是实现了了Ordered接口的，所以我们关注怎么注册实现了Ordered的接口的BeanPostProcessor</li>
<li>主要是在源码：BeanPostProcessor pp &#x3D; beanFactory.getBean(ppName, BeanPostProcessor.class); 这一行，通过我们的bean定义和要获取的bean实例类型–&gt;来获取我们的bean实例</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Next, register the BeanPostProcessors that implement Ordered.</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span> orderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> orderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>getBean() –调用了–&gt; doGetBean()，doGetBean的主要逻辑如下</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> requiredType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 尝试从缓存中获取我们的目标Bean对象</span>
    <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//获取到了，直接拿到目标bean对象</span>
        bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 缓存中获取不到，那么就去生成</span>
        <span class="token comment">// 生成之前会做一些检查</span>
            <span class="token comment">// Create bean instance. 开始生成目标bean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//目标类是单例</span>
                sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token comment">//异常</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//目标类是多例--省略了</span>
                bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//其他</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 检查并返回--省略了</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>我们是第一次运行，缓存中肯定没有，所以肯定会去生成createBean()，我们进去createBean()看一下，createBean里面 –调用了–&gt; doCreateBean()</p>
</li>
<li><p>创建bean实例，都是在 doCreateBean() 中完成的，doCreateBean()主要完成了下面几个工作</p>
<ul>
<li><p>创建bean实例，但是没有任何属性： instanceWrapper &#x3D; createBeanInstance(beanName, mbd, args);</p>
</li>
<li><p>对bean进行属性复制：populateBean(beanName, mbd, instanceWrapper); </p>
</li>
<li><p>初始化bean：exposedObject &#x3D; initializeBean(beanName, exposedObject, mbd); 这个初始化，才是重点中的重点</p>
</li>
</ul>
</li>
<li><p>返回初始化之后的bean，就是真真正正的bean了，也就是我们苦思冥想的：AnnotationAwareAspectJAutoProxyCreator的实例。</p>
</li>
<li><p><strong>初始化bean：exposedObject &#x3D; initializeBean(beanName, exposedObject, mbd); 这个初始化，才是重点中的重点</strong></p>
</li>
<li><p>我们来单独看看这部分重点内容，初始化bean里面会在bean的初始化之前和之后分别执行BeanPostProcessor</p>
</li>
<li><p>处理Aware接口的方法回调：invokeAwareMethods(beanName, bean);</p>
</li>
<li><p>只有实现了Aware接口的bean才会调用</p>
</li>
<li><p>这里主要是做了一步：就是把BeanFactory交给当前的bean，换句话说：就是当前bean里面保存了一个对beanFactory的一个引用。</p>
</li>
<li><p>应用后置处理器的postProcessBeforeInitialization（）：wrappedBean &#x3D; applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</p>
</li>
<li><p>执行自定义的初始化方法：invokeInitMethods(beanName, wrappedBean, mbd);</p>
</li>
<li><p>这里所说的自定义的初始化方法，是我们自己配置的 init 方法，会在这里执行</p>
<ul>
<li>什么是自己配置的init方法，就是下面这种，指定的 initMethod </li>
<li><blockquote>
<p>@Bean(initMethod&#x3D;””,destoryMethod&#x3D;””)</p>
</blockquote>
</li>
<li><blockquote>
<p>&lt;bean id&#x3D;””, class&#x3D;””, init-method&#x3D;””, destory-method&#x3D;””&gt;</p>
</blockquote>
</li>
</ul>
</li>
<li><p>执行后置处理器的postProcessAfterInitialization（）：wrappedBean &#x3D; applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</p>
</li>
<li><p>返回wrappedBean，就是我们的目标结果了。</p>
</li>
</ul>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221222175654720.png" alt="image-20221222175654720" style="zoom: 50%;" />



<ul>
<li><p>最后创建完之后，会将我们的BeanPostProcessor放在BeanFoctory中。beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext))</p>
<ul>
<li>作者注：BeanPostProcessor也是一个Bean，既然是Bean，就要满足Bean的生成步骤，每一个Bean的生成都会判断是否有对应的BeanPostProcessor需要执行！这也是为什么我们的 AnnotationAwareAspectJAutoProxyCreator明明是一个BeanPostProcessor，为什么还要执行applyBeanPostProcessorsBeforeInitialization和applyBeanPostProcessorsAfterInitialization</li>
</ul>
</li>
<li><p>总结：至此，我们本小节的标题：AnnotationAwareAspectJAutoProxyCreator 是什么时候被创建的呢？就已经完成了。我们总体回顾一下</p>
<ul>
<li>首先是，我们知道@EnableAspectJAutoProxy的给我们的容器中注入一个：AnnotationAwareAspectJAutoProxyCreator</li>
<li>同时，我们知道AnnotationAwareAspectJAutoProxyCreator的作用主要是作为一个后置处理器，在bean的创建前后做一些工作，以及实现了BeanFactoryAware接口，可以直接与spring容器进行操作。</li>
<li>那么，我们现在又知道了AnnotationAwareAspectJAutoProxyCreator的是什么时候被创建的，怎么被创建的，以及创建完之后是加入到了BeanFacory中。</li>
</ul>
</li>
<li><p>下面，我们就要看看，这个 AnnotationAwareAspectJAutoProxyCreator 是怎么具体影响我们的业务的，是怎么把aop功能添加进来的。</p>
</li>
<li><p>在看这个问题之前，我们要先看一下，我们具体的业务类是怎么创建的。包括：MainConfig, LogAspect, Calculator这三个类</p>
</li>
<li><p>MainConfig是一个配置类</p>
</li>
<li><p>LogAspect是一个切面类</p>
</li>
<li><p>Calculator是一个普通类</p>
</li>
</ul>
<h3 id="具体的业务类-MainConfig-LogAspect-Calculator-是怎么创建的"><a href="#具体的业务类-MainConfig-LogAspect-Calculator-是怎么创建的" class="headerlink" title="具体的业务类(MainConfig, LogAspect, Calculator)是怎么创建的"></a>具体的业务类(MainConfig, LogAspect, Calculator)是怎么创建的</h3><ul>
<li><p>首先我们明确一点，在spirng中，所有bean的生成走的代码都是同一个，只不过根据接口的不同，走的逻辑不同</p>
</li>
<li><p>对于这三个类bean的生成，因为三个类所代表的含义都是不同的，所以他们分别生成的逻辑是不同的。</p>
</li>
<li><p>在区分这三个类的生成逻辑之前，我们总体看一下，bean的通用生成规则：</p>
</li>
<li><p>对于一个Bean来说，不管这个Bean是BeanPostProcessor，还是config类，还是切面类，或者是普通类，在spirng中，都是通过getBean()作为统一入口</p>
</li>
<li><p>比如对于前面说的BeanPostProcessor，他的创建入口在：</p>
<ul>
<li>开始：refresh() </li>
<li>紧接着：registerBeanPostProcessors(beanFactory);</li>
<li>紧接着：registerBeanPostProcessors(beanFactory, this);</li>
<li>这一行调用了getBean()：BeanPostProcessor pp &#x3D; beanFactory.getBean(ppName, BeanPostProcessor.class);</li>
</ul>
</li>
<li><p>比如我们的普通Bean 的创建</p>
<ul>
<li>开始：refresh() </li>
<li>紧接着：finishBeanFactoryInitialization(beanFactory);</li>
<li>紧接着：beanFactory.preInstantiateSingletons();</li>
<li>最后调用了 getBean()：getBean(beanName);</li>
</ul>
</li>
<li><p>所以，我们从getBean开始，看一下spring是怎么创建Bean的，以及怎么兼容所有的bean类型的（BeanPostProcessor，Config，切面类等）</p>
</li>
<li><p>下面的代码是getBean的主要逻辑流程，我是把所有的逻辑汇总在了一起，实际的代码中，是涉及到多个类的多个方法，比较复杂。我们只看主逻辑。</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">//遍历所有的bean定义</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> 所有的<span class="token class-name">BeanName</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 尝试从缓存中获取我们的目标Bean对象</span>
            <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//获取到了，直接拿到目标bean对象</span>
                bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 缓存中获取不到，那么就去生成</span>
                <span class="token comment">// 生成之前会做一些检查</span>
                <span class="token comment">// Create bean instance. 开始生成目标bean</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//生成单例bean</span>
                    <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

                        <span class="token comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
                        <span class="token comment">// 给 BeanPostProcessors 一个机会：返回代理类替代目标类(这里的代理类并不是说从缓存中取出代理类，而是用另一种方式生成代理类)</span>
                        <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                            <span class="token number">1.</span><span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                        <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                            <span class="token comment">//我们可以看到，这里也有创建代理的逻辑，以至于很多人会搞错。</span>
                                            <span class="token comment">//确实，这里是有可能创建代理的，但前提是对于相应的 bean 我们有自定义的 TargetSource 实现，</span>
                                            <span class="token comment">//进到 getCustomTargetSource(...) 方法就清楚了，我们需要配置一个 customTargetSourceCreators，它是一个 TargetSourceCreator 数组。</span>
                                            <span class="token comment">//这里就不再展开说 TargetSource 了</span>
                                        <span class="token punctuation">&#125;</span>
                                    <span class="token punctuation">&#125;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token number">2.</span>如果before返回的bean是个<span class="token keyword">null</span>，after不会执行
                            <span class="token number">3.</span><span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    postProcessAfterInitialization    
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token comment">//开始创建Bean</span>
                        <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                            <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                <span class="token comment">//生成bean对象</span>
                                <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//给bean对象赋属性值</span>
                                <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//初始化bean对象</span>
                                <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                    <span class="token comment">//执行后置处理器</span>
                                    <span class="token number">1.</span><span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                        postProcessBeforeInitialization
                                    <span class="token punctuation">&#125;</span>
                                    <span class="token number">2.</span>invokeInitMethods
                                    <span class="token number">3.</span><span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                        <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                            <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                                <span class="token comment">//Create proxy if we have advice.</span>
                                                <span class="token comment">//如果有切面的话，就创建代理</span>
                                                <span class="token comment">//Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span>
                                                <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token punctuation">&#125;</span>
                                        <span class="token punctuation">&#125;</span>
                                    <span class="token punctuation">&#125;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>

                    <span class="token punctuation">&#125;</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//生成多例bean--省略了</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//其他--省略</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 检查并返回--省略了</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>要想把上面那部分代码看懂，至少需要debug调试十几遍，反正我是不知道调试了几十遍，才看懂的。现在对上面的代码几个注意点说下：</p>
</li>
<li><p>applyBeanPostProcessorsBeforeInstantiation 和 applyBeanPostProcessorsBeforeInitialization 这是两个不一样的方法,一定不要看错，否则会很迷惑</p>
<ul>
<li>一个结尾是：Instantiation（实例化）</li>
<li>一个结尾是：Initialization（初始）</li>
</ul>
</li>
<li><p>下面我们就来看一下，我们关注的三个类的具体创建步骤，结合上面的代码流程，通过三个具体类的创建，来温故知新一下。</p>
</li>
</ul>
<h4 id="MainConfig"><a href="#MainConfig" class="headerlink" title="MainConfig"></a>MainConfig</h4><ul>
<li>我们从refresh()–&gt;finishBeanFactoryInitialization()–&gt;preInstantiateSingletons()–&gt;这些就不说了，我们从遍历Bean定义开始</li>
</ul>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/hNUBsLKhDYiqy_0t9sgVmMs6XhnbS9UO2ETVGIxlHBE.png" alt="hNUBsLKhDYiqy_0t9sgVmMs6XhnbS9UO2ETVGIxlHBE" style="zoom: 50%;" />



<h4 id="LogAspect"><a href="#LogAspect" class="headerlink" title="LogAspect"></a>LogAspect</h4><img src="【spring】spring注解AOP开发和源码解读及实践.assets/n64jjFWSA8kCbc9AgoYEMtaVPtku_Nu8LSTDjyp8QsU.png" alt="n64jjFWSA8kCbc9AgoYEMtaVPtku_Nu8LSTDjyp8QsU" style="zoom: 80%;" />



<h4 id="Calculator"><a href="#Calculator" class="headerlink" title="Calculator"></a>Calculator</h4><img src="【spring】spring注解AOP开发和源码解读及实践.assets/WkX2HY8q-7QE94zE6_AGpMWC9AxxIOOW0M6DZ3mCDCA.png" alt="WkX2HY8q-7QE94zE6_AGpMWC9AxxIOOW0M6DZ3mCDCA" style="zoom:80%;" />



<ul>
<li><p>总结：通过以上的分析，我们收获了什么呢？</p>
</li>
<li><p>我们知道了BeanPostProcessor有两种，一种是在创建Bean之前给一个机会返回代理，一种是在创建bean之后进行一些操作。</p>
</li>
<li><p>前者是继承了SmartInstantiationAwareBeanPostProcessor的才有的功能。后者是所有的BeanPostProcessor都有的功能（包括SmartInstantiationAwareBeanPostProcessor）。</p>
</li>
<li><p>同时，我们知道了三个类的具体创建流程：mainConfig，LogAspect，Calculator的创建流程。</p>
</li>
<li><p>最后，我们仍然有一个疑问：</p>
</li>
<li><p>@EnableAspectJAutoProxy给我们的容器中注入一个：AnnotationAwareAspectJAutoProxyCreator</p>
</li>
<li><p>AnnotationAwareAspectJAutoProxyCreator是一个SmartInstantiationAwareBeanPostProcessor，我们目前只知道他是在bean创建之前给一个返回代理的机会。</p>
</li>
<li><p>但是同时我们知道，我们生成的所有这些类（仅限于当前这个demo里的所有类），貌似都没有把握这个机会，在bean创建之前生成了代理。</p>
</li>
<li><p>那么，这么AnnotationAwareAspectJAutoProxyCreator到底是有什么作用呢？？我还不知道！！！</p>
</li>
<li><p>除了上面那个问题，我们不知道之外，接下来，再来具体看看我们的代理对象，就是Calculator代理对象具体是怎么生成！</p>
</li>
</ul>
<h3 id="Calculator代理对象具体是怎么生成的？"><a href="#Calculator代理对象具体是怎么生成的？" class="headerlink" title="Calculator代理对象具体是怎么生成的？"></a>Calculator代理对象具体是怎么生成的？</h3><ul>
<li><p>话接上回，我们知道了spinrg的aop会对需要增强的bean的创建代理对象。在这里，被切的Calculator类就是一个增强的类，所以spirng会对他创建代理。</p>
</li>
<li><p>同样的，我们知道，spring在对切面增强类创建代理，是在wrapIfNessary()这个方法里面创建代理的。那么我们就来看看是什么创建的，切面方法是怎么注入进来的。</p>
</li>
<li><p>首先是获取当前bean可用的所有通知方法，Object[] specificInterceptors</p>
</li>
<li><p>找到候选的所有的增强器（找哪些通知方法是需要切入当前bean方法的）</p>
</li>
<li><p>获取到能在bean使用的增强器。</p>
</li>
<li><p>给增强器排序</p>
</li>
<li><p>这个获取当前类的所有通知方法的代码，就不看了，我们只需要知道运行完这个方法之后，就会拿到当前类的所有通知方法就可以啦。</p>
</li>
<li><p>然后，当我们获取到当前类的所有通知方法之后，保存当前bean在advisedBeans中，并设置为true，表示它是一个增强bean</p>
</li>
<li><p>紧接着就是创建代理：Object proxy &#x3D; createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</p>
</li>
<li><p>将代理保存到proxyFactory，然后创建代理对象：代理有两种，有Spring自动决定创建哪一个代理</p>
</li>
<li><p>JdkDynamicAopProxy(config);jdk动态代理；</p>
</li>
<li><p>ObjenesisCglibAopProxy(config);cglib的动态代理；</p>
</li>
<li><p>代理创建成功后，给容器中返回当前组件使用cglib增强了的代理对象；</p>
</li>
<li><p>以后容器中获取到的就是这个组件的代理对象，执行目标方法的时候，代理对象就会执行通知方法。</p>
</li>
<li><p>这部分我们不深究究竟是怎么获取通知方法的，已经具体是怎么选择创建什么代理的，以及代理最终是怎么创建的。所以这里就不贴图了。</p>
</li>
<li><p>总结：</p>
</li>
<li><p>我们知道spring的aop会对需要增强的bean的创建代理对象</p>
</li>
<li><p>需要增强的bean会被保存在advisedBeans中，创建后的代理对象也会保存在proxyFactory中，最终创建的proxy代理对象会返回，并保存在IOC容器中，供以后使用。</p>
</li>
<li><p>那么，接下来，我们就看看，当我们调用目标方法的时候，代理对象是怎么具体执行的？</p>
</li>
</ul>
<h3 id="调用目标方法，代理对象是怎么执行的？"><a href="#调用目标方法，代理对象是怎么执行的？" class="headerlink" title="调用目标方法，代理对象是怎么执行的？"></a>调用目标方法，代理对象是怎么执行的？</h3><ul>
<li><p>通过以上所有的步骤，我们现在终于走到了最后一步，在开始执行目标方法之前，我们先来简单的整体回顾一下。</p>
</li>
<li><p>@EnableAspectJAutoProxy 开启AOP功能，并给容器中注册一个组件 AnnotationAwareAspectJAutoProxyCreator</p>
</li>
<li><p>AnnotationAwareAspectJAutoProxyCreator这个组件通过refresh()中的registerBeanPostProcessors(beanFactory);这个方法被注册进来</p>
</li>
<li><p>然后开始生成所有的bean（包括我们的mainConfig，LogAspect, Calculator）等的创建，在这类的创建步骤中，之前注册的组件：AnnotationAwareAspectJAutoProxyCreator会产生作用</p>
</li>
<li><p>什么作用呢？就是在bean的创建之前执行BeanPostProcessor，在before中给一个返回代理对象的机会。</p>
</li>
<li><p>如果没有返回代理对象，那么就创建bean，创建bean之后，会再次执行BeanPostProcessor，在after中会判断是否是增强bean，会是需要创建代理</p>
</li>
<li><p>如果不需要创建代理，那么就直接返回bean（比如MainConfig，LogAspect这两个就不需要创建代理）</p>
</li>
<li><p>如果需要创建代理，那么就获取所有的通知方法，然后spirng决定创建cglib代理还是jdk代理，并返回代理对象。</p>
</li>
<li><p>最后，就到了我们这一小节的主题：代理对象是怎么替代目标方法执行的？</p>
</li>
<li><p>代理对象创建成功之后，执行目标方法，其实就是通过代理对象来执行目标方法了。</p>
</li>
<li><p>执行目标的方法的入口是在我们的测试类中</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">MainConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Calculator</span> calculator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Calculator</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"calculator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里是是入口</span>
        <span class="token keyword">int</span> div <span class="token operator">=</span> calculator<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>意思就是当我们执行int div &#x3D; calculator.div(2, 1);，实际上就是我们的代理对象执行的。所以他会进入到代理对象的执行流程里。</p>
</li>
<li><p>下一步，就是进入到代理对象的执行，执行目标方法进入了CglibAopProxy.intercept()方法中</p>
</li>
<li><p>intercept()方法的作用就是在目标方法执行前后进行拦截，这也是我们aop代理对象的核心，就是通过拦截器执行切面。</p>
</li>
<li><p>在intercept()方法中主要做了两件事：</p>
</li>
<li><p>getInterceptorsAndDynamicInterceptionAdvice() 获取所有的拦截器链</p>
</li>
<li><p>proceed() 执行拦截器链</p>
</li>
<li><p>当拦截器链执行完之后，所有的切面也就执行完了。同时会进行返回 return retVal;这个retVal就是我们目标方法的返回值。</p>
</li>
<li><p>这就是调用目标方法，代理对象的大致执行流程。</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//一些变量的定义</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//获取拦截器链</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 对拦截器链进行检查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//如果拦截器链为空，就直接执行目标方法</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> <span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">adaptArgumentsIfNecessary</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 否则就执行拦截器链</span>
            retVal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> methodProxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//最后得到返回值，进行返回</span>
        retVal <span class="token operator">=</span> <span class="token function">processReturnType</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> retVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//一些处理</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>总结：我们知道了代理对象执行的大致流程，无非是两个关键的步骤：</p>
</li>
<li><p>拦截器链的获取</p>
</li>
<li><p>拦截器链的执行</p>
</li>
</ul>
<h3 id="目标方法执行之拦截器链的获取"><a href="#目标方法执行之拦截器链的获取" class="headerlink" title="目标方法执行之拦截器链的获取"></a>目标方法执行之拦截器链的获取</h3><ul>
<li><p>通过上面我们知道，目标方法的执行，其实就是代理对象的执行。代理对象在之前之前， 会获取到所有的拦截器（这里的拦截器，实际上就是我们之前说的通知方法，也叫切面方法）</p>
</li>
<li><p>那么，现在我们来看一看，拦截器链是怎么获取的。</p>
</li>
<li><p>首先，进入拦截器链的获取方法中： List chain &#x3D; this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</p>
</li>
<li><p>会先从缓存中拿一下，缓存中没有的话，再去获取拦截器链。会将获取的结果放在缓存中，以便于下次可以直接使用</p>
</li>
<li><p>获取拦截器链：this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice(this, method, targetClass)</p>
</li>
<li><p>获取拦截器链的步骤比较简单，我们直接通过简化后的代码进行查看（省略了很多代码，建议跟着源码看）</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 定义一个List，从来存放所有的拦截器链：看看人家List的定义，会传入list的大小，不浪费一点内存空间，真好！</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> interceptorList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历所有的Advisors，Advisors里面都是我们的通知方式，通过断点我们看到。包含一个系统默认的通知方法和我们定义的所有拦截方法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor <span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//会根据不同的类型，分别走不同的逻辑，但是都会调用同一个方法，就是getInterceptors()</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//从advisor中获取MInterceptor</span>
            <span class="token class-name">MethodInterceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Interceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Interceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//最后返回所有的拦截器</span>
    <span class="token keyword">return</span> interceptorList<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>明白了拦截器链的获取流程之后，我们在进入看看怎么从从advisor中获取MInterceptor，这部分代码更简单，直接贴上源码</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownAdviceTypeException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//创建list用于保存</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">></span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取具体的通知方法，advice其实就是我们具体的通知方法。 </span>
    <span class="token comment">//advice和advisor的作用是：advisor是一个大集合，里面包含了很多很多东西，advice就是advisor包含的内容之一，就是具体的通知方法</span>
    <span class="token class-name">Advice</span> advice <span class="token operator">=</span> advisor<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//然后对通知方法进行判断，我们知道通知方法有很多种：前置通知，后置通知等等</span>
    <span class="token comment">//如果当前通知方法是MethodInterceptor类型的，就直接放进去</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advice <span class="token keyword">instanceof</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> advice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//如果不是MethodInterceptor类型的，就会通过一个适配器，将通知方法转换成MethodInterceptor类型的。 </span>
    <span class="token comment">//可以进去看看这个适配器，其实就是装饰模式，进行了一次包装，包装成MethodInterceotor</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AdvisorAdapter</span> adapter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adapters<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adapter<span class="token punctuation">.</span><span class="token function">supportsAdvice</span><span class="token punctuation">(</span>advice<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>adapter<span class="token punctuation">.</span><span class="token function">getInterceptor</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//最后进行一下校验，然后返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownAdviceTypeException</span><span class="token punctuation">(</span>advisor<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> interceptors<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">[</span>interceptors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li>执行完以上的步骤，我们就获取到了当前目标类的所有的拦截器。下一步就是执行拦截器了。</li>
</ul>
<h3 id="目标方法执行之拦截器链的执行"><a href="#目标方法执行之拦截器链的执行" class="headerlink" title="目标方法执行之拦截器链的执行"></a>目标方法执行之拦截器链的执行</h3><ul>
<li><p>到这一步，才是我们切面的真真正正的执行，前面做的都是准备。什么是真真正正的执行呢？就是我们可以在控制台，看到输出。</p>
</li>
<li><p>明确一个概念：所谓的spring的aop，就是一个代理类，这个代理类内有很多拦截器，在真正的方法执行前后，会执行这些拦截器，这就是aop的本质。</p>
</li>
<li><p>好了，下面我们看看拦截器链的执行吧。这是重点！！</p>
</li>
<li><p>retVal &#x3D; new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</p>
</li>
<li><p>其中proceed()方法是重点，他是一个递归调用的方法。</p>
</li>
<li><p>在方法的一开始，保存了一个变量，这个变量从-1开始，每一次process()的执行，都会++，直到所有的拦截器都执行完了，才会开始返回。</p>
</li>
<li><p>我们直接看源码，这个方法并不是很长。</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//    这个变量从-1开始执行，直到所有的拦截器全都执行完</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//变量每次执行++</span>
    <span class="token class-name">Object</span> interceptorOrInterceptionAdvice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptorOrInterceptionAdvice <span class="token keyword">instanceof</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Evaluate dynamic method matcher here: static part will already have</span>
        <span class="token comment">// been evaluated and found to match.</span>
        <span class="token class-name">InterceptorAndDynamicMethodMatcher</span> dm <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dm<span class="token punctuation">.</span>methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> dm<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Dynamic matching failed.</span>
            <span class="token comment">// Skip this interceptor and invoke the next in the chain.</span>
            <span class="token keyword">return</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// It's an interceptor, so we just invoke it: The pointcut will have</span>
        <span class="token comment">// been evaluated statically before this object was constructed.</span>
        <span class="token comment">//这里是拦截器链的递归调用，注意传入的是this，也就是当前的MethodInvocation，因为invoke()方法中会用到</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>



<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//拦截器链，在invoke的时候，会进入到这个方法</span>
    <span class="token comment">//注意注意注意，每一次invoke的时候，其实进入的是不一样的方法。 注意自己打断点看一下，所以，我这里把其他的都删掉了。</span>
    <span class="token comment">//只留了一个mi.proceed()方法，因为每次进入的都是不同的类的invoke()方法，但是都会调用proceed()</span>
    <span class="token comment">//也可以看看，我提供的方法调用栈信息图</span>
    <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><p>我之前说，proceed()是递归调用，其实是不对的！他其实不能算作递归调用。</p>
</li>
<li><p>因为他是一个MethodInvocation，内部包含了其他的MethodInvocation，内部的MethodInvocation又包含了其他的MethodInvocation。</p>
</li>
<li><p>MethodInvocation调用proceed()，并不断压栈，直到所有的MethodInvocation调用完了。</p>
</li>
<li><p>然后从最最内部的MethodInvocation开始，一个一个返回。直到返回到最上层的MethonInvocation。</p>
</li>
<li><p>proceed调用栈图</p>
</li>
</ul>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221222183003694.png" alt="image-20221222183003694" style="zoom:80%;" />



<ul>
<li><p>一些注意点：</p>
</li>
<li><p>注意点1：around拦截器的执行时机，要了解，是在压栈之后，立即执行，然后我们知道around里面，调用了proceed，然后会再次将around进行压栈。这个一会再说！</p>
</li>
<li><p>注意点2：压栈的顺序，这个一会和注意点1一起说。</p>
</li>
<li><p>注意点3：每一个拦截器，分别都执行了什么，比如前置通知压栈后，直接开始调用，然后前置通知调用玩，直接调用目标方法。比如后置通知里有一个finally，表示不管是否发生异常，后置通知都执行。比如返回通知，会直接throw异常，throw异常之后，返回通知就不在执行，交给异常通知了。等等之类的。</p>
</li>
<li><p>我们来总体看一下调用流程。并解决注意点1和2</p>
</li>
</ul>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/4OTL2oICo5fo_CqT86SyAdIp1Txk-x__mt7r3e0KDto.png" alt="4OTL2oICo5fo_CqT86SyAdIp1Txk-x__mt7r3e0KDto" style="zoom:80%;" />



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><pre><code>1）、@EnableAspectJAutoProxy 开启AOP功能
</code></pre>
</li>
<li><pre><code>2）、@EnableAspectJAutoProxy 会给容器中注册一个组件 AnnotationAwareAspectJAutoProxyCreator
</code></pre>
</li>
<li><pre><code>3）、AnnotationAwareAspectJAutoProxyCreator是一个后置处理器；
</code></pre>
</li>
<li><pre><code>4）、容器的创建流程：
*     1）、registerBeanPostProcessors（）注册后置处理器；创建AnnotationAwareAspectJAutoProxyCreator对象
*     2）、finishBeanFactoryInitialization（）初始化剩下的单实例bean
      *     1）、创建业务逻辑组件和切面组件
      *     2）、AnnotationAwareAspectJAutoProxyCreator拦截组件的创建过程
      *     3）、组件创建完之后，判断组件是否需要增强
            *     是：切面的通知方法，包装成增强器（Advisor）;给业务逻辑组件创建一个代理对象（cglib）；
</code></pre>
</li>
<li><pre><code>5）、执行目标方法：
*     1）、代理对象执行目标方法
*     2）、CglibAopProxy.intercept()；
      *     1）、得到目标方法的拦截器链（增强器包装成拦截器MethodInterceptor）
      *     2）、利用拦截器的链式机制，依次进入每一个拦截器进行执行；
      *     3）、效果：
            *     正常执行：环绕通知开始-》前置通知-》目标方法-》环绕通知结束-》后置通知-》返回通知-》结束
            *     出现异常：环绕通知开始-》前置通知-》目标方法-》环绕通知结束-》后置通知-》异常通知-》结束
</code></pre>
</li>
</ul>
<h2 id="记录一次AOP不生效的排查心路"><a href="#记录一次AOP不生效的排查心路" class="headerlink" title="记录一次AOP不生效的排查心路"></a>记录一次AOP不生效的排查心路</h2><p>结论先行：</p>
<ul>
<li>AOP生效的条件就是，当调用<code>目标类</code>的<code>目标方法</code>的时候，实际上是由<code>目标类的代理对象</code>调用<code>目标方法</code>的，切面会生效</li>
<li>在一个类内部方法调用的时候，切面是不生效的。</li>
</ul>
<h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>要给客户展示出各个维度的指标数据，计算的方法都是一样的，只是源数据的结构不一样，所以</p>
<ul>
<li>计算的方法统一抽象到抽象父类中</li>
<li>不同的指标针对不同的源数据，处理成统一结构，然后调用父类中的计算方法统一返回</li>
<li>很显然，这是策略模式</li>
</ul>
<p>假设我们有指标A，指标B要展示给客户；</p>
<p>因为在测试环境数据不好造，所以我想到了使用AOP进行MOCK</p>
<p>具体的代码见下面</p>
<h3 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h3><h4 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h4><img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223144223033.png" alt="image-20221223144223033" style="zoom:80%;" />

<h4 id="业务代码"><a href="#业务代码" class="headerlink" title="业务代码"></a>业务代码</h4><h5 id="抽象父类：AbstractIndicatorStrategy"><a href="#抽象父类：AbstractIndicatorStrategy" class="headerlink" title="抽象父类：AbstractIndicatorStrategy"></a>抽象父类：AbstractIndicatorStrategy</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractIndicatorStrategy</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">calculate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> data<span class="token operator">+</span><span class="token string">" = 666"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="策略类A：IndicatorAStrategyImpl"><a href="#策略类A：IndicatorAStrategyImpl" class="headerlink" title="策略类A：IndicatorAStrategyImpl"></a>策略类A：IndicatorAStrategyImpl</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndicatorAStrategyImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractIndicatorStrategy</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_A"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"indicator_a_data"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="策略类B：IndicatorBStrategyImpl"><a href="#策略类B：IndicatorBStrategyImpl" class="headerlink" title="策略类B：IndicatorBStrategyImpl"></a>策略类B：IndicatorBStrategyImpl</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndicatorBStrategyImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractIndicatorStrategy</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_B"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"indicator_b_data"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="策略管理类：IndicatorStrategyManager"><a href="#策略管理类：IndicatorStrategyManager" class="headerlink" title="策略管理类：IndicatorStrategyManager"></a>策略管理类：IndicatorStrategyManager</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndicatorStrategyManager</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractIndicatorStrategy</span><span class="token punctuation">></span></span> maps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> strategyCode<span class="token punctuation">,</span> <span class="token class-name">AbstractIndicatorStrategy</span> metricStrategy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        maps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>strategyCode<span class="token punctuation">,</span> metricStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AbstractIndicatorStrategy</span> <span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span> strategyCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> maps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strategyCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//测试策略A</span>
<span class="token class-name">String</span> indicatorAResult <span class="token operator">=</span> <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//测试策略B</span>
<span class="token class-name">String</span> indicatorBResult <span class="token operator">=</span> <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>以上是业务部分的相关代码，那么AOP是在哪里使用的呢，看下面</p>
<h4 id="AOP代码"><a href="#AOP代码" class="headerlink" title="AOP代码"></a>AOP代码</h4><p>上面提到到，我希望通过切面的方式，mock掉<code>calculate</code>这个方法</p>
<p>所以我创建了一个切面类；添加了<code>@Aspect</code>注解，并且在springboot的启动类上添加了<code>@EnableAspectJAutoProxy</code>注解</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MockAspect</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"$&#123;remote.mock.indicator:CLOSE&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mockOpen<span class="token punctuation">;</span>

    <span class="token comment">/**
     * mock calculate
     */</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* com.sf.fw.nas.manager.strategy.base.AbstractIndicatorStrategy.calculate(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 计算指标
     */</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"calculate()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">aroundCalculate</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"OPEN"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mockOpen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> data <span class="token operator">+</span> <span class="token string">" = mock_data"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span><span class="token string">"com.xxx.remote"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.xxx.mapper"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">DruidDataSourceAutoConfigure</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppApplication</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">SpringApplication</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">AppApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		app<span class="token punctuation">.</span><span class="token function">setBannerMode</span><span class="token punctuation">(</span><span class="token class-name">Banner<span class="token punctuation">.</span>Mode</span><span class="token punctuation">.</span><span class="token constant">OFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		app<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="不生效的场景"><a href="#不生效的场景" class="headerlink" title="不生效的场景"></a>不生效的场景</h3><p>最后我们运行代码，发现，我们的切面，压根没有进来</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223143934745.png" alt="image-20221223143934745" style="zoom:80%;" />





<h3 id="排查思路"><a href="#排查思路" class="headerlink" title="排查思路"></a>排查思路</h3><h4 id="第一次排查：解决了切面没有切对方法的问题（其实不是）"><a href="#第一次排查：解决了切面没有切对方法的问题（其实不是）" class="headerlink" title="第一次排查：解决了切面没有切对方法的问题（其实不是）"></a>第一次排查：解决了切面没有切对方法的问题（其实不是）</h4><p>在这一次的排查过程中，我以为是因为我的切面切得是抽象父类的方法，但是我实际调用的是策略子类，方法可能切不到。</p>
<p>所以我修改了一下切面的 execution 表达式；</p>
<p>由原来的：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* com.sf.fw.nas.manager.strategy.base.AbstractIndicatorStrategy.calculate(..))"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>改成了：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* com.sf.fw.nas.manager.strategy.*.*.calculate(..))"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>含义是：切在<code>com.sf.fw.nas.manager.strategy</code>包和所有子包里的任意类的<code>calculate</code>方法的执行</p>
<p>如果看不懂这个表达式的，可以看看：<a href="#execution%E8%A1%A8%E8%BE%BE%E5%BC%8F">execution表达式</a></p>
<p>结论：</p>
<p>切面依旧没有生效。所以说：不是这个问题导致的。</p>
<p>题外话：其实不是 这个问题，最终经过所有的排查思路之后，找到问题并解决之后，发现，即使切的是父类的方法，还是能进去切面的。 </p>
<h4 id="第二次排查：解决了调用类不是代理类的问题（关键）"><a href="#第二次排查：解决了调用类不是代理类的问题（关键）" class="headerlink" title="第二次排查：解决了调用类不是代理类的问题（关键）"></a>第二次排查：解决了调用类不是代理类的问题（关键）</h4><p>然后我又复习了一遍，AOP到底是什么原理。 <a href="#AOP%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B%E5%A4%A7%E8%87%B4%E5%88%86%E6%9E%90">AOP源码流程大致分析</a></p>
<p>了解到：</p>
<p>AOP的实现原理，其实就是动态代理，spring会对切面切到的目标类，生成代理类。</p>
<p>然后执行目标类的目标方法的时候，其实是由代理类来执行的。</p>
<p>这就是AOP的原理。</p>
<p>了解了上面的步骤之后，我们来验证一下，看看调用目标方法的类是不是代理类呢？</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223150216763.png" alt="image-20221223150216763" style="zoom:80%;" />



<p>果不其然，调用目标方法的类，竟然不是代理类；这样AOP肯定是不会生效的。</p>
<p>那么问题来了？</p>
<p>为什么不是代理类呢？</p>
<ul>
<li>是我的切面配置有错误吗？<code>@Aspect</code>和@<code>EnableAspectJAutoProxy</code> 这两注解没生效吗？</li>
<li>还是其他的配置有问题呢？</li>
<li>还是别的什么问题呢？</li>
</ul>
<p>我现在有点迷。</p>
<p>于是我又复习了一下AOP的原理，我要看一下，这个代理类是怎么生成的？为什么我的类不是代理类。<a href="#Calculator%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E5%85%B7%E4%BD%93%E6%98%AF%E6%80%8E%E4%B9%88%E7%94%9F%E6%88%90%E7%9A%84%EF%BC%9F">Calculator代理对象具体是怎么生成的？</a></p>
<p>经过复习，了解到，在spring中，java类分为几种：</p>
<ul>
<li>有BeanPostProcessor，是一个很重要的概念，用来实现spring的很多强大的功能</li>
<li>有普通的类：这里所说的普通的类包括：切面类，Config类，业务类，其实都算是普通类</li>
</ul>
<p>那么这些类是怎么生成的？</p>
<ul>
<li>在spring的refresh方法中，有两个方法叫做：<ul>
<li>registerBeanPostProcessors：这个是用来注册 BeanPostProcessor 的</li>
<li>finishBeanFactoryInitialization：这个就是用来创建生成普通类的。</li>
</ul>
</li>
<li>所以我们的代理对象，正常应该在 finishBeanFactoryInitialization 这个方法中被生成。</li>
</ul>
<p>然后我们继续了解 finishBeanFactoryInitialization 这个方法</p>
<ul>
<li>preInstantiateSingletons：开始实例化单例bean，调用 getBean</li>
<li>getBean：获取bean，调用 doGetBean</li>
<li>doGetBean：获取bean，会先从缓存拿，拿不到就调用：createBean</li>
<li>createBean：创建bean，调用 doCreateBean</li>
<li>doCreateBean：开始真正的创建bean，会调用：createBeanInstance，populateBean，initializeBean</li>
<li>createBeanInstance 创建bean，populateBean 给bean赋值，initializeBean 初始化bean， 会调用 applyBeanPostProcessorsAfterInitialization</li>
<li>applyBeanPostProcessorsAfterInitialization：应用BeanPostProcessor增强bean</li>
<li>postProcessAfterInitialization：会找到很多BeanPostProcessor，循环调用BeanPostProcessor的这个方法进行增强</li>
<li>AbstractAutoProxyCreator：AbstractAutoProxyCreator是AOP用来增强类的，进入到这个类的postProcessAfterInitialization方法中，会调用：wrapIfNecessary</li>
<li>wrapIfNecessary：开始对类进行代理</li>
<li>createProxy：真正的创建代理类</li>
</ul>
<p>好了，了解了以上的流程之后，我们进入到spring的源码中，打上断点，验证：我们的类到底有没有生成代理类？</p>
<p>打上断点，开始验证：</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223152614060.png" alt="image-20221223152614060" style="zoom:80%;" />



<p>然后发现，断点进来了，而且生成了代理类，说明配置是没有问题的。</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223152838510.png" alt="image-20221223152838510" style="zoom:80%;" />



<p>既然配置没有问题，那就说明我们的代码有问题。</p>
<p>代理类生成了，但是我们没有获取到代理类，然后我们思考，获取策略类的时候，是从<code>IndicatorStrategyManager</code>中获取的。</p>
<p>也就是说，从<code>IndicatorStrategyManager</code>中获取的类不是代理类。那么为什么呢？</p>
<p>这个时候去看我们的代码，发现我们在往<code>IndicatorStrategyManager</code>注册bean的时候，用的是下面这种方式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_A"</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们往策略管理类中注册的是<code>this</code></p>
<ul>
<li>this 是什么，this是当前这个bean，不是从spring容器中拿到的bean</li>
<li>所以，它当然不是 代理对象啦。</li>
</ul>
<p>既然找到了问题，就好解决了。我们把 this 改成 从spring容器中获取bean</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndicatorAStrategyImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractIndicatorStrategy</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_A"</span><span class="token punctuation">,</span>
            <span class="token class-name">ApplicationContextProvider</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">IndicatorAStrategyImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"indicator_a_data"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中使用到的<code>ApplicationContextProvider</code>这个类是自己写的一个工具类。代码如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextProvider</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 上下文对象实例
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ApplicationContextProvider</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取applicationContext
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> applicationContext<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 通过class获取Bean.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 通过name,以及Clazz返回指定的Bean
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>好了，至此，我们在测试一波：</p>
<p>喜大普奔，现在我们获取到的对象就是我们的代理类啦。</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223154857074.png" alt="image-20221223154857074" style="zoom:80%;" />

<p>但是很不幸的是，切面仍然没有生效。</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223155053663.png" alt="image-20221223155053663" style="zoom:80%;" />



<p>我又迷惑了，为什么呢？ 接着往下看</p>
<h4 id="第三次排查：找到了cglib内部调用的问题（未解决）"><a href="#第三次排查：找到了cglib内部调用的问题（未解决）" class="headerlink" title="第三次排查：找到了cglib内部调用的问题（未解决）"></a>第三次排查：找到了cglib内部调用的问题（未解决）</h4><p>到这里，我已经有点晕了，为什么我的AOP还是不生效呢？</p>
<p>再次回想：AOP生效的条件就是，当调用<code>目标类</code>的<code>目标方法</code>的时候，实际上是由<code>目标类的代理对象</code>调用<code>目标方法</code>的。</p>
<p>这句话里面有几个关键词：</p>
<ul>
<li>目标类：当然了，就是我们的策略类A（IndicatorAStrategyImpl）和B（IndicatorBStrategyImpl）这两个东东啦。</li>
<li>目标方法：当然啦，目标方法是我们希望被切面切到的<code>calculate</code>方法啦</li>
<li>目标类的代理对象：当然啦，是我们之前看到的 <code>IndicatorAStrategyImpl$$EnhancerBySpringCGLIB$$c1fb478</code> 这个东东啦</li>
<li>调用目标方法：就是调用 <code>calculate</code>方法。</li>
</ul>
<p>好，重复一遍最后一句：调用目标方法：就是调用 <code>calculate</code>方法。</p>
<p>那么我们看看代码，我们的代理类调用的是谁？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> indicatorAResult <span class="token operator">=</span> <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> indicatorBResult <span class="token operator">=</span> <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>是的，没错，我们的代理类调用的是<code>process</code>方法，不是<code>calculate</code>方法。</p>
<p>那么接下来，就有两个问题了</p>
<ul>
<li>直接用代理类调用calculate方法，AOP真的会生效吗？我已经有点怀疑自己了。</li>
<li>为什么代理类调用process方法，然后process方法调用目标方法calculate的时候，切面不生效呢？</li>
</ul>
<p><strong>直接用代理类调用calculate方法，AOP真的会生效吗</strong></p>
<p>我们调整一下代码：把调用process的方法改成调用calculate</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> indicatorAResult <span class="token operator">=</span> <span class="token class-name">IndicatorStrategyManager</span><span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token string">"INDICATOR_A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//String indicatorAResult = IndicatorStrategyManager.getStrategy("INDICATOR_A").process();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>发现：切面生效了。</p>
<img src="【spring】spring注解AOP开发和源码解读及实践.assets/image-20221223160347614.png" alt="image-20221223160347614" style="zoom:80%;" />



<p><strong>为什么代理类调用process方法，然后process方法调用目标方法calculate的时候，切面不生效呢？</strong></p>
<p>因为当代理类调用了<code>process</code>方法之后，就已经进入了<code>process</code>方法内部了；</p>
<p>在<code>process</code>方法内部调用<code>calculate</code>，其实相当于：<code>this.calculate</code>的调用方式；</p>
<p>又是<code>this</code>，所以它就已经不是代理类了，所以切面自然也不会生效。</p>
<h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><ul>
<li><p>感谢尚硅谷《spring源码分析》视频教程:<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av32102436">https://www.bilibili.com/video/av32102436</a></p>
</li>
<li><p>感谢《Spring AOP 源码解析》一文：<a target="_blank" rel="noopener" href="https://javadoop.com/post/spring-aop-source">https://javadoop.com/post/spring-aop-source</a></p>
</li>
</ul>
<hr>
<p>spring-aop和aspectJ的关系</p>
<p>ImportBeanDefinitionRegistrar的作用</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a><a class="post-meta__tags" href="/tags/AOP/">AOP</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#spring%E6%B3%A8%E8%A7%A3AOP%E5%BC%80%E5%8F%91%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%8F%8A%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.</span> <span class="toc-text">spring注解AOP开发和源码解读及实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">AOP的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#execution%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">execution表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.2.</span> <span class="toc-text">基于注解的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5aop%E6%89%80%E5%BF%85%E9%A1%BB%E7%9A%84%E6%9C%80%E5%B0%8Fmaven%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">导入aop所必须的最小maven依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%B1%BB"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">实现业务逻辑类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%85%B7%E4%BD%93%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%87%E9%9D%A2%E7%B1%BB"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">实现具体的日志切面类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%88%87%E9%9D%A2%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3%EF%BC%8C%E6%A0%87%E6%B3%A8%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">对切面类的方法添加注解，标注执行时机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%8A%E8%AF%89spring%E5%93%AA%E4%B8%AA%E7%B1%BB%E6%98%AF%E5%88%87%E9%9D%A2%E7%B1%BB"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">告诉spring哪个类是切面类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%88%87%E9%9D%A2%E7%B1%BB%E5%92%8C%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%B1%BB%E7%BA%B3%E5%85%A5spirng%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">将切面类和业务逻辑类纳入spirng管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84aop%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">开启基于注解的aop模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E4%B8%80%E6%AD%A5%EF%BC%8C%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%B1%BB%EF%BC%8C%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.2.8.</span> <span class="toc-text">最后一步，编写测试类，进行测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EXML%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">基于XML的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%95%A5"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP%E7%9A%84%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">AOP的源码流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EnableAspectJAutoProxy-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%8C%E5%B9%B2%E5%95%A5%E7%94%A8%E7%9A%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">@EnableAspectJAutoProxy 是什么，干啥用的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E7%9A%84%E4%B8%9A%E5%8A%A1%E7%B1%BB-MainConfig-LogAspect-Calculator-%E6%98%AF%E6%80%8E%E4%B9%88%E5%88%9B%E5%BB%BA%E7%9A%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">具体的业务类(MainConfig, LogAspect, Calculator)是怎么创建的</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MainConfig"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">MainConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LogAspect"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">LogAspect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Calculator"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">Calculator</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calculator%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E5%85%B7%E4%BD%93%E6%98%AF%E6%80%8E%E4%B9%88%E7%94%9F%E6%88%90%E7%9A%84%EF%BC%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">Calculator代理对象具体是怎么生成的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%EF%BC%8C%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E6%98%AF%E6%80%8E%E4%B9%88%E6%89%A7%E8%A1%8C%E7%9A%84%EF%BC%9F"><span class="toc-number">1.2.4.</span> <span class="toc-text">调用目标方法，代理对象是怎么执行的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E4%B9%8B%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">1.2.5.</span> <span class="toc-text">目标方法执行之拦截器链的获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E4%B9%8B%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.6.</span> <span class="toc-text">目标方法执行之拦截器链的执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.7.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1AOP%E4%B8%8D%E7%94%9F%E6%95%88%E7%9A%84%E6%8E%92%E6%9F%A5%E5%BF%83%E8%B7%AF"><span class="toc-number">1.3.</span> <span class="toc-text">记录一次AOP不生效的排查心路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.1.</span> <span class="toc-text">业务场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">代码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">结构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">业务代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E7%88%B6%E7%B1%BB%EF%BC%9AAbstractIndicatorStrategy"><span class="toc-number">1.3.2.2.1.</span> <span class="toc-text">抽象父类：AbstractIndicatorStrategy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E7%B1%BBA%EF%BC%9AIndicatorAStrategyImpl"><span class="toc-number">1.3.2.2.2.</span> <span class="toc-text">策略类A：IndicatorAStrategyImpl</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E7%B1%BBB%EF%BC%9AIndicatorBStrategyImpl"><span class="toc-number">1.3.2.2.3.</span> <span class="toc-text">策略类B：IndicatorBStrategyImpl</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E7%AE%A1%E7%90%86%E7%B1%BB%EF%BC%9AIndicatorStrategyManager"><span class="toc-number">1.3.2.2.4.</span> <span class="toc-text">策略管理类：IndicatorStrategyManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.3.2.2.5.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">AOP代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E7%94%9F%E6%95%88%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.3.</span> <span class="toc-text">不生效的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text">排查思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%8E%92%E6%9F%A5%EF%BC%9A%E8%A7%A3%E5%86%B3%E4%BA%86%E5%88%87%E9%9D%A2%E6%B2%A1%E6%9C%89%E5%88%87%E5%AF%B9%E6%96%B9%E6%B3%95%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E5%85%B6%E5%AE%9E%E4%B8%8D%E6%98%AF%EF%BC%89"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">第一次排查：解决了切面没有切对方法的问题（其实不是）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%8E%92%E6%9F%A5%EF%BC%9A%E8%A7%A3%E5%86%B3%E4%BA%86%E8%B0%83%E7%94%A8%E7%B1%BB%E4%B8%8D%E6%98%AF%E4%BB%A3%E7%90%86%E7%B1%BB%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">第二次排查：解决了调用类不是代理类的问题（关键）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AC%A1%E6%8E%92%E6%9F%A5%EF%BC%9A%E6%89%BE%E5%88%B0%E4%BA%86cglib%E5%86%85%E9%83%A8%E8%B0%83%E7%94%A8%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E6%9C%AA%E8%A7%A3%E5%86%B3%EF%BC%89"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">第三次排查：找到了cglib内部调用的问题（未解决）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%B4%E8%B0%A2"><span class="toc-number">1.4.</span> <span class="toc-text">致谢</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By zs</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>