<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>mysql的锁从入门到入土 | 张三碎碎念</title><meta name="author" content="zs"><meta name="copyright" content="zs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="mysql的锁 根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表锁和行锁三类。 写在前面共享锁和独占锁（排它锁）共享锁：Shared Locks，简称S锁 独占锁（排它锁）：Exclusive Locks简称X锁 意向共享锁与意向独占锁意向共享锁：Intention Shared Lock，简称IS锁。作用是：当一个事务准备给一条记录加S锁的时候，会先给这条记录所在的表加一个IS锁 意向">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql的锁从入门到入土">
<meta property="og:url" content="https://zspcer.gitee.io/note/JAVA/%E6%95%B0%E6%8D%AE%E5%BA%93/MYSQL/mysql%E7%9A%84%E9%94%81%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/index.html">
<meta property="og:site_name" content="张三碎碎念">
<meta property="og:description" content="mysql的锁 根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表锁和行锁三类。 写在前面共享锁和独占锁（排它锁）共享锁：Shared Locks，简称S锁 独占锁（排它锁）：Exclusive Locks简称X锁 意向共享锁与意向独占锁意向共享锁：Intention Shared Lock，简称IS锁。作用是：当一个事务准备给一条记录加S锁的时候，会先给这条记录所在的表加一个IS锁 意向">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/10/31/MYRpjluEf2rbNvQ.jpg">
<meta property="article:published_time" content="2022-11-17T14:18:32.000Z">
<meta property="article:modified_time" content="2022-12-30T09:46:23.211Z">
<meta property="article:author" content="zs">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="锁">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/10/31/MYRpjluEf2rbNvQ.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zspcer.gitee.io/note/JAVA/%E6%95%B0%E6%8D%AE%E5%BA%93/MYSQL/mysql%E7%9A%84%E9%94%81%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mysql的锁从入门到入土',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-30 09:46:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="张三碎碎念" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">54</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">85</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/alist/"><i class="fa-fw fas fa-folder"></i><span> 网盘</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/10/31/MYRpjluEf2rbNvQ.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">张三碎碎念</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/alist/"><i class="fa-fw fas fa-folder"></i><span> 网盘</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mysql的锁从入门到入土</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-17T14:18:32.000Z" title="发表于 2022-11-17 14:18:32">2022-11-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-30T09:46:23.211Z" title="更新于 2022-12-30 09:46:23">2022-12-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/">JAVA</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA/%E6%95%B0%E6%8D%AE%E5%BA%93/MYSQL/">MYSQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="mysql的锁从入门到入土"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="mysql的锁"><a href="#mysql的锁" class="headerlink" title="mysql的锁"></a>mysql的锁</h1><hr>
<p>根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表锁和行锁三类。</p>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><h3 id="共享锁和独占锁（排它锁）"><a href="#共享锁和独占锁（排它锁）" class="headerlink" title="共享锁和独占锁（排它锁）"></a>共享锁和独占锁（排它锁）</h3><p>共享锁：<code>Shared Locks</code>，简称<code>S锁</code></p>
<p>独占锁（排它锁）：<code>Exclusive Locks</code>简称<code>X锁</code></p>
<h3 id="意向共享锁与意向独占锁"><a href="#意向共享锁与意向独占锁" class="headerlink" title="意向共享锁与意向独占锁"></a>意向共享锁与意向独占锁</h3><p>意向共享锁：<code>Intention Shared Lock</code>，简称<code>IS锁</code>。作用是：当一个事务准备给一条记录加<code>S锁</code>的时候，会先给这条记录所在的表加一个<code>IS锁</code></p>
<p>意向独占锁：<code>Intention Exclusive Lock</code>，简称<code>IX锁</code>。作用是：当一个事务准备在一条记录上加<code>X锁</code>的时候，会先给这条记录所在的表加一个<code>IX锁</code></p>
<h3 id="读锁和写锁"><a href="#读锁和写锁" class="headerlink" title="读锁和写锁"></a>读锁和写锁</h3><p>写锁是排它锁（也叫独占锁），意味着其他线程不能读也不能写，当前线程可读写；</p>
<p>读锁是共享锁，意味着其他线程只能读不能写，本线程也不能写；</p>
<p>全局锁只有读锁。</p>
<p>表锁有读锁和写锁。</p>
<p>MDL锁有读锁和写锁。</p>
<h3 id="当前读和快照读"><a href="#当前读和快照读" class="headerlink" title="当前读和快照读"></a>当前读和快照读</h3><p>在mysql的默认隔离级别RR下</p>
<p>快照读：一般情况下select * from ….where …  是快照读，不会加锁，有MVCC支持</p>
<p>当前读： <code>for update</code>,<code>lock in share mode</code>,<code>update</code>,<code>delete</code>都属于当前读，会加锁</p>
<ul>
<li>lock in share mode ： 加的是共享锁（s锁）</li>
<li>for update ： 加的是独占锁（排他锁 &#x2F; x锁）</li>
<li>update：加的是独占锁（排他锁 &#x2F; x锁），update 的加锁语义和 for update 是一致的</li>
<li>delete：加的是独占锁（排他锁 &#x2F; x锁），delete的加锁语义和 for update 是一致的</li>
</ul>
<h2 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h2><h3 id="什么是全局锁"><a href="#什么是全局锁" class="headerlink" title="什么是全局锁"></a>什么是全局锁</h3><p>顾名思义，全局锁就是对整个数据库实例加锁。</p>
<p>全局锁只有一个读锁。</p>
<h3 id="何时打开-x2F-关闭全局锁（FTWRL）"><a href="#何时打开-x2F-关闭全局锁（FTWRL）" class="headerlink" title="何时打开 &#x2F; 关闭全局锁（FTWRL）"></a>何时打开 &#x2F; 关闭全局锁（FTWRL）</h3><p>打开</p>
<ul>
<li>只能手动打开，命令是 <code>Flush tables with read lock (FTWRL)</code>。</li>
<li>打开全局锁之后，整个数据库处于只读状态，可以查询。</li>
<li>之后以下语句会被阻塞：DML（数据的增删改，可以查询）、DDL（包括建表、修改表结构等）和更新类事务的提交语句。</li>
</ul>
<p>关闭</p>
<ul>
<li>unlock tables 可以解除</li>
<li>client 断开的时候自动释放</li>
</ul>
<h3 id="全局锁使用场景（全库逻辑备份）"><a href="#全局锁使用场景（全库逻辑备份）" class="headerlink" title="全局锁使用场景（全库逻辑备份）"></a>全局锁使用场景（全库逻辑备份）</h3><p>全局锁的典型使用场景是，做全库逻辑备份。也就是把整库每个表都 select 出来存成文本。</p>
<h4 id="全库逻辑备份"><a href="#全库逻辑备份" class="headerlink" title="全库逻辑备份"></a>全库逻辑备份</h4><p>为了避免备份过程中出现数据不一致的情况，所以，在备份的时候需要保证数据一致性。</p>
<h4 id="怎么保证备份时数据一致性"><a href="#怎么保证备份时数据一致性" class="headerlink" title="怎么保证备份时数据一致性"></a>怎么保证备份时数据一致性</h4><p>全局锁就是保证数据一致性的方法之一，但是全局锁也有很多缺点：</p>
<ul>
<li>在主库上备份，备份的过程中，整个库处于只读状态，业务停止</li>
<li>在备库上备份，会导致同步过来的<code>binlog</code>无法执行，主备延迟</li>
</ul>
<p>那么，使用一致性视图<code>readview</code>也是一个办法，而且不会阻止数据库的更新，但是需要满足两个条件</p>
<ul>
<li>需要引擎支持MVCC</li>
<li>需要数据库隔离级别是RR（readview在RR级别下是第一个查询时开启，直到事务结束，都在一个readview下； 但是RC界别下是每一个查询都会开启readview，这样的话，在备份的时候，仍然是数据不一致的。）</li>
<li>MySQL官方自带的逻辑备份工具是 mysqldump。当使用<code>–single-transaction</code> 参数的时候，就是使用这种方式</li>
</ul>
<p>那么，使用<code>set global readonly=true</code>呢？确实 readonly 方式也可以让全库进入只读状态，但不建议，主要有两个原因：</p>
<ul>
<li>在有些系统中，readonly 的值会被用来做其他逻辑，比如用来判断一个库是主库还是备库。</li>
<li>在异常处理机制上有差异：使用 FTWRL 命令之后，如果client异常断开，那么 MySQL 会自动释放这个全局锁，整库恢复正常。而将整个库设置为 readonly 之后，如果client发生异常，则数据库就会一直保持 readonly 状态，这样会导致整个库长时间处于不可写状态，风险较高</li>
</ul>
<h2 id="表锁（表锁-MDL锁）"><a href="#表锁（表锁-MDL锁）" class="headerlink" title="表锁（表锁+MDL锁）"></a>表锁（表锁+MDL锁）</h2><p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)</p>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><h4 id="什么是表锁"><a href="#什么是表锁" class="headerlink" title="什么是表锁"></a>什么是表锁</h4><p>顾名思义，表锁就是对某张表加锁。</p>
<p>全局锁只有一个读锁，而表锁是有：读锁，和写锁的。</p>
<h4 id="何时打开-x2F-关闭表锁"><a href="#何时打开-x2F-关闭表锁" class="headerlink" title="何时打开&#x2F;关闭表锁"></a>何时打开&#x2F;关闭表锁</h4><p>打开</p>
<ul>
<li>手动打开，表锁的语法是<code> lock tables … read/write</code></li>
</ul>
<p>关闭</p>
<ul>
<li>unlock tables可以解除</li>
<li>client 断开的时候自动释放</li>
</ul>
<h4 id="表锁的读锁和写锁"><a href="#表锁的读锁和写锁" class="headerlink" title="表锁的读锁和写锁"></a>表锁的读锁和写锁</h4><p>全局锁只有一个读锁，而表锁是有：读锁，和写锁的。</p>
<p>lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</p>
<p>举个例子, 如果在某个线程 A 中执行 lock tables t1 read, t2 write; 这个语句之后：</p>
<ul>
<li>其他线程写 t1、读写 t2 的语句都会被阻塞。</li>
<li>同时，线程 A 在执行 unlock tables 之前，也只能执行读 t1、读写 t2 的操作。连写 t1 都不允许，自然也不能访问其他表。</li>
</ul>
<h4 id="表锁的使用场景"><a href="#表锁的使用场景" class="headerlink" title="表锁的使用场景"></a>表锁的使用场景</h4><p>在还没有出现更细粒度的锁的时候，表锁是最常用的处理并发的方式。</p>
<p>而对于 InnoDB 这种支持行锁的引擎，一般不用 lock tables 命令来控制并发，毕竟锁住整个表的影响面还是太大。</p>
<h3 id="元数据锁（meta-data-lock，MDL"><a href="#元数据锁（meta-data-lock，MDL" class="headerlink" title="元数据锁（meta data lock，MDL)"></a>元数据锁（meta data lock，MDL)</h3><h4 id="什么是元数据锁"><a href="#什么是元数据锁" class="headerlink" title="什么是元数据锁"></a>什么是元数据锁</h4><p>MySQL 5.5 版本中引入了 MDL</p>
<p>执行DML时，加 MDL 读锁</p>
<p>执行DDL时，加 MDL 写锁</p>
<h4 id="怎么打开-x2F-关闭元数据锁"><a href="#怎么打开-x2F-关闭元数据锁" class="headerlink" title="怎么打开&#x2F;关闭元数据锁"></a>怎么打开&#x2F;关闭元数据锁</h4><p>MDL 不需要显式使用，在访问一个表的时候会被自动加上</p>
<p>当对表做DML操作的时候，加 MDL 读锁</p>
<p>当对表做DDL操作的时候，加 MDL 写锁</p>
<h4 id="MDL的使用场景"><a href="#MDL的使用场景" class="headerlink" title="MDL的使用场景"></a>MDL的使用场景</h4><h5 id="保证读写的正确性"><a href="#保证读写的正确性" class="headerlink" title="保证读写的正确性"></a>保证读写的正确性</h5><p>MDL 的作用是，保证读写的正确性</p>
<p>你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一个字段，那么查询线程拿到的结果跟表结构对不上，肯定是不行的。</p>
<h5 id="ONLINE-DDL的实现原理"><a href="#ONLINE-DDL的实现原理" class="headerlink" title="ONLINE DDL的实现原理"></a>ONLINE DDL的实现原理</h5><ol>
<li>获取对应要操作表的 MDL写锁</li>
<li>MDL写锁 降级成 MDL读锁</li>
<li>真正做DDL操作</li>
<li>MDL读锁 升级成 MDL写锁</li>
<li>释放MDL锁</li>
</ol>
<p>第一步获取写锁之后，降级为读锁，此时DML可以正常执行（DML需要的是读锁），但是DDL执行不了（DDL需要的是写锁），这样就支持了online ddl</p>
<h4 id="MDL锁的死锁场景"><a href="#MDL锁的死锁场景" class="headerlink" title="MDL锁的死锁场景"></a>MDL锁的死锁场景</h4><h5 id="如何安全的给小表加索引"><a href="#如何安全的给小表加索引" class="headerlink" title="如何安全的给小表加索引"></a>如何安全的给小表加索引</h5><p>给一个小表加个字段，导致整个库挂了</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
<th>session D</th>
</tr>
</thead>
<tbody><tr>
<td>begin<br/>select * from t limit 1;</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>select * from t limit 1;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>alter table t add f int;<br><font color='red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>select * from t limit 1;<br/><font color='red'>blocked</font></td>
</tr>
</tbody></table>
<p>sessionA：需要MDL读锁，可以正常执行</p>
<p>sessionB：需要MDL读锁，因为读锁是共享锁，可以正常执行</p>
<p>sessionC：需要MDL写锁，因为sessionA和sessionB还没有提交，MDL读锁还没有释放，所以MDL写锁申请不了，会等待</p>
<p>sessionD：需要MDL读锁，因为sessionC在阻塞，所以sessionD也阻塞了</p>
<p>此时整张表处于不可读写状态，如果这个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</p>
<p><strong>事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放。</strong>(<a href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E9%94%81%E5%8D%8F%E8%AE%AE">两阶段锁协议</a>，后面会说)</p>
<p>怎么安全的给小表加字段</p>
<ul>
<li>解决大事务，事务不提交，就会一直占着 MDL 锁</li>
</ul>
<p>如果你要变更的表是一个热点表，虽然数据量不大，但是上面的请求很频繁，而你不得不加个字段，你该怎么做呢？</p>
<ul>
<li>在 alter table 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。</li>
</ul>
<h2 id="行锁与死锁"><a href="#行锁与死锁" class="headerlink" title="行锁与死锁"></a>行锁与死锁</h2><p>MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。</p>
<p>不支持行锁意味着并发控制只能使用表锁，对于这种引擎的表，同一张表上任何时刻只能有一个更新在执行，这就会影响到业务并发度。</p>
<p>InnoDB 是支持行锁的，这也是 MyISAM 被 InnoDB 替代的重要原因之一。</p>
<h3 id="什么是行锁"><a href="#什么是行锁" class="headerlink" title="什么是行锁"></a>什么是行锁</h3><p>顾名思义，行锁就是针对数据表中行记录的锁。</p>
<p>这很好理解，比如事务 A 更新了一行，而这时候事务 B 也要更新同一行，则必须等事务 A 的操作完成后才能进行更新。</p>
<h3 id="两阶段锁协议"><a href="#两阶段锁协议" class="headerlink" title="两阶段锁协议"></a>两阶段锁协议</h3><p>在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是<strong>两阶段锁协议</strong>。</p>
<p>事务中，行锁是在语句执行时才加上的（[案例十：IN 语句加锁（动态加锁）](#案例十：IN 语句加锁（动态加锁）)），不是事务开始就加上，但释放是统一在事务结束时才释放。</p>
<p>根据这个特性，对于高并发的行记录的操作语句就可以尽可能的安排到最后面，以减少锁等待的时间，提高并发性能</p>
<h3 id="何时加-x2F-释放行锁"><a href="#何时加-x2F-释放行锁" class="headerlink" title="何时加 &#x2F; 释放行锁"></a>何时加 &#x2F; 释放行锁</h3><p>事实上，在事务执行过程中，行锁不会单独加上，因为加锁的最小粒度是 next-key lock（[next-key lock](#next-key lock)）</p>
<p>具体是怎么加的，可以参考：<a href="#%E5%8A%A0%E9%94%81/%E9%87%8A%E6%94%BE%E9%94%81/%E6%9F%A5%E7%9C%8B%E9%94%81%E8%A7%84%E5%88%99">加锁&#x2F;释放锁&#x2F;查看锁规则</a></p>
<p>但是呢，我们可以简单的理解：在事务中，行锁是在语句执行时才加上的（[案例十：IN 语句加锁（动态加锁）](#案例十：IN 语句加锁（动态加锁）)），如果语句执行的过程中扫描到了行，会给这个行加行锁。</p>
<p>释放是统一在事务结束时才释放</p>
<h3 id="什么是死锁"><a href="#什么是死锁" class="headerlink" title="什么是死锁"></a>什么是死锁</h3><table>
<thead>
<tr>
<th>session A</th>
<th>事务 B</th>
</tr>
</thead>
<tbody><tr>
<td>begin<br/>update t set k&#x3D;1 where id &#x3D;1;</td>
<td>begin;</td>
</tr>
<tr>
<td></td>
<td>update t set k&#x3D;2 where id &#x3D;2;</td>
</tr>
<tr>
<td>update t set k&#x3D;3 where id &#x3D; 2;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set k&#x3D;4 where id &#x3D; 1;</td>
</tr>
</tbody></table>
<p>这时候，事务 A 在等待事务 B 释放 id&#x3D;2 的行锁，而事务 B 在等待事务 A 释放 id&#x3D;1 的行锁。 事务 A 和事务 B 在互相等待对方的资源释放，就是进入了死锁状态。</p>
<h3 id="出现死锁怎么办"><a href="#出现死锁怎么办" class="headerlink" title="出现死锁怎么办"></a>出现死锁怎么办</h3><p>当出现死锁以后，有两种策略：</p>
<ul>
<li>死锁等待：直接进入等待，直到超时。这个超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置。</li>
<li>死锁检测（推荐）：发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 <code>innodb_deadlock_detect</code> 设置为 on，表示开启这个逻辑。</li>
</ul>
<h4 id="死锁等待"><a href="#死锁等待" class="headerlink" title="死锁等待"></a>死锁等待</h4><p>在 InnoDB 中，<code>innodb_lock_wait_timeout</code> 的默认值是 50s</p>
<p>意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过 50s 才会超时退出，然后其他线程才有可能继续执行。</p>
<ul>
<li>设置比较大的值：对于在线服务来说，这个等待时间往往是无法接受的</li>
<li>设置比较小的值：虽然死锁可以很快解开，但是容易出现误杀，比如正常的锁等待，也会导致线程退出</li>
</ul>
<h4 id="死锁检测（推荐）"><a href="#死锁检测（推荐）" class="headerlink" title="死锁检测（推荐）"></a>死锁检测（推荐）</h4><p><strong>开启死锁检测</strong>：<code>innodb_deadlock_detect</code>设置为<code>on</code>，默认值就是<code>on</code></p>
<p><strong>死锁检测是怎么检测的</strong>：每当一个事务被锁的时候，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待（也就是死锁）。</p>
<p><strong>死锁检测的例子</strong>：新来的线程F，被锁了后就要检查锁住F的线程（假设为D）是否被锁，如果没有被锁，则没有死锁，如果被锁了，还要查看锁住线程D的是谁，如果是F，那么肯定死锁了，如果不是F（假设为B），那么就要继续判断锁住线程B的是谁，一直走直到发现线程没有被锁（无死锁）或者被F锁住（死锁）才会终止。</p>
<p><strong>死锁检测的代价</strong></p>
<p>举个例子：1000个线程并发更新同一行，发生了锁等待，这个时候需要检测是否发生了死锁？</p>
<p>那么死锁检测操作就是 100 万（1000 * 1000）这个量级的。虽然最终检测的结果是没有死锁，但是这期间要消耗大量的 CPU 资源。</p>
<p>因此，你就会看到 CPU 利用率很高，但是每秒却执行不了几个事务。</p>
<h3 id="行锁的死锁场景"><a href="#行锁的死锁场景" class="headerlink" title="行锁的死锁场景"></a>行锁的死锁场景</h3><h4 id="热点行更新的性能问题"><a href="#热点行更新的性能问题" class="headerlink" title="热点行更新的性能问题"></a>热点行更新的性能问题</h4><p>热点行更新问题，就是大量的并发线程，更新同一行记录的问题，会由于并发量太大，可能导致死锁的产生，触发死锁检测，耗费大量cpu</p>
<p><strong>解决方案</strong></p>
<ul>
<li>如果你能确保这个业务一定不会出现死锁，可以临时把死锁检测关掉</li>
<li>控制并发度：死锁检测的成本高，所以控制并发度，就可以减少死锁检测的性能消耗，同时还能减少死锁的产生</li>
<li>将热点行更新问题拆分为更新多行（具体可以从业务角度考虑）</li>
</ul>
<h2 id="间隙锁（幻读）"><a href="#间隙锁（幻读）" class="headerlink" title="间隙锁（幻读）"></a>间隙锁（幻读）</h2><p>通过幻读的产生，来了解一下间隙锁</p>
<h3 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h3><h4 id="什么是幻读"><a href="#什么是幻读" class="headerlink" title="什么是幻读"></a>什么是幻读</h4><p>结论先行：幻读的产生前提</p>
<ul>
<li>只有在<strong>当前读</strong>的情况下才可能产生（<a href="#%E5%BD%93%E5%89%8D%E8%AF%BB%E5%92%8C%E5%BF%AB%E7%85%A7%E8%AF%BB">当前读和快照读</a>），所以下面的演示，查询语句使用了 <code>for update</code></li>
<li>只有 <code>insert</code> 的记录才是幻读，update的不是</li>
</ul>
<h4 id="幻读的产生"><a href="#幻读的产生" class="headerlink" title="幻读的产生"></a>幻读的产生</h4><p>以下的测试是在InnoDB的默认隔离级别RR下</p>
<p>准备一张表和数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个表除了主键 id 外，还有一个普通索引 c，d是普通列没有索引，初始化语句在表中插入了 6 行数据。</p>
<p>下面这个这个场景，只是假设，是为了引入幻读，然后引出后面要说的<code>间隙锁</code>。</p>
<p>这个场景实际上不会产生的，因为有<code>间隙锁</code>的存在。</p>
<p>这里假设<code>间隙锁</code>不存在</p>
<table>
<thead>
<tr>
<th></th>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>begin;<br/>select * from t where d &#x3D; 5 for update;<br/>结果：(5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>begin;<br/>update t set d&#x3D;5 where id &#x3D;0;<br/>commit;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d &#x3D; 5 for update;<br/>结果：(0,0,5),(5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>begin;<br/>insert into t values(1,1,5);<br/>commit;</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d &#x3D; 5 for update;<br/>结果：(0,0,5),(1,1,5),(5,5,5)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>在 session A 中执行了三次一模一样的查询，由于这些查询语句使用了 for update ，所以都是当前读，并且加上了 x 锁。</p>
<ul>
<li>第一次查询：结果：(5,5,5)，没问题</li>
<li>第二次查询：结果：(0,0,5),(5,5,5)，因为是当前读，所以可以读到 session B 更新后的记录。（但是这不是幻读）</li>
<li>第三次查询：结果：(0,0,5),(1,1,5),(5,5,5)，因为是当前读，所以可以读到 session C 插入的记录。（是幻读）</li>
</ul>
<p>通过上面的结果看，因为使用了当前读，能查出来这些数据，是没有问题的。</p>
<p>但是真的没有问题吗？如果你觉得上面的步骤，没有问题，那么你就有问题了，接着往下看：看看幻读的问题</p>
<h4 id="幻读的问题"><a href="#幻读的问题" class="headerlink" title="幻读的问题"></a>幻读的问题</h4><h5 id="幻读破坏语义"><a href="#幻读破坏语义" class="headerlink" title="幻读破坏语义"></a>幻读破坏语义</h5><p>回过头来，我们来看这个查询语句：<code>select * from t where d = 5 for update;</code>，这个查询语句是什么意思？</p>
<ul>
<li>查询 d&#x3D;5的记录，并且加上了一个x锁；</li>
</ul>
<p>注意：加的是一个x锁，按照常理考虑，对所有d&#x3D;5的记录，都应该有个x锁，既然有了x锁，那么针对d&#x3D;5的记录，就不能再操作了？</p>
<p>那么 session B 的更新（update t set d&#x3D;5 where id &#x3D;0;），和 session C 的插入（insert into t values(1,1,5);），都变化了 d&#x3D;5 的记录，这是怎么回事呢？</p>
<p>这是因为：</p>
<ul>
<li>在第一次执行查询的时候，只给 id&#x3D;5 这一行记录加上了锁。所以 session B 可以更新 id&#x3D;0 这一条记录。但是，这样就破坏了第一次查询语句要锁住所有 d&#x3D;5 的行的加锁声明。</li>
<li>session C 也是一样的道理，对 id&#x3D;1 这一行的插入，也是破坏了要锁住所有 d&#x3D;5 的行的加锁声明。</li>
</ul>
<p>这就是破坏了语义。</p>
<h5 id="幻读导致数据不一致"><a href="#幻读导致数据不一致" class="headerlink" title="幻读导致数据不一致"></a>幻读导致数据不一致</h5><p>我们所说的数据一致性，不止是数据库内部数据状态在此刻的一致性，还包含了数据和日志在逻辑上的一致性。</p>
<p>思考下面这个问题，我们执行这个查询语句：<code>select * from t where d = 5 for update;</code></p>
<p>其中字段 d 上是没有索引的，因此这条查询语句会做全表扫描。</p>
<p>那么，其他被扫描到的，但是不满足条件的记录，会不会被加锁呢？</p>
<h6 id="假设只锁d-x3D-5其他记录不加锁"><a href="#假设只锁d-x3D-5其他记录不加锁" class="headerlink" title="假设只锁d&#x3D;5其他记录不加锁"></a>假设只锁d&#x3D;5其他记录不加锁</h6><p>考虑下面这个场景（当然这个场景也是假设的）</p>
<p>先把数据准备一下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th></th>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>begin<br/>select * from t where d&#x3D;5 for update;<br>update t set d &#x3D; 100 where d &#x3D; 5;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>begin;<br/>update t set d&#x3D;5 where id &#x3D;0;<br/>update t set c&#x3D;5 where id &#x3D;0;<br/>commit;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d &#x3D; 5 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>begin;<br/>insert into t values(1,1,5);<br/>update t set c&#x3D;5 where id&#x3D;1;<br/>commit;</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d &#x3D; 5 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>通过上面的一波执行，看一下数据库的最终结果是什么样的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">之前：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
之后：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样看，这些数据也没啥问题，但是我们再来看看这时候 binlog 里面的内容。</p>
<ul>
<li>session B 的事务先提交，binlog先记录：update t set d&#x3D;5 where id&#x3D;0; update t set c&#x3D;5 where id&#x3D;0;</li>
<li>然后是 session C 的事务提交了，binlog记录：insert into t values(1,1,5); update t set c&#x3D;5 where id&#x3D;1;</li>
<li>最后是 session A 的事务提交了，binlog记录：update t set d &#x3D; 100 where d &#x3D; 5;</li>
<li>汇总之后，就是下面这样：</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">//session B</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> d<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">update</span> t <span class="token keyword">set</span> c<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//session C</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> c<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//session A</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> d<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> d<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后备库执行上面的binlog之后，结果是什么样的呢？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">之前：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
之后：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>到这里，比较一下，你就发现了问题</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">主库：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span>
备库：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这个问题很严重，是不行的。</p>
<p>所以我们认为，只锁d&#x3D;5其他记录不加锁，这个假设不合理，要改。</p>
<p>那怎么改呢？我们把扫描过程中碰到的行，也都加上x锁，再来看看执行效果。</p>
<h6 id="假设给所有扫描到的记录都加锁"><a href="#假设给所有扫描到的记录都加锁" class="headerlink" title="假设给所有扫描到的记录都加锁"></a>假设给所有扫描到的记录都加锁</h6><p>把扫描过程中碰到的行，也都加上写锁，再来看看执行效果。</p>
<p>考虑下面这个场景（当然这个场景也是假设的）</p>
<p>先把数据准备一下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th></th>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>begin<br/>select * from t where d&#x3D;5 for update;<br>update t set d &#x3D; 100 where d &#x3D; 5;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>begin;<br/>update t set d&#x3D;5 where id &#x3D;0;<br/><font color='red'>阻塞blocked</font><br/>update t set c&#x3D;5 where id &#x3D;0;<br/>commit;</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>select * from t where d &#x3D; 5 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td></td>
<td>begin;<br/>insert into t values(1,1,5);<br/>update t set c&#x3D;5 where id&#x3D;1;<br/>commit;</td>
</tr>
<tr>
<td>T5</td>
<td>select * from t where d &#x3D; 5 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>commit;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td></td>
<td>session A释放锁之后，继续执行</td>
<td></td>
</tr>
</tbody></table>
<p>由于 session A 把所有的行都加了写锁，所以 session B 在执行第一个 update 语句的时候就被锁住了。需要等到 T6 时刻 session A 提交以后，session B 才能继续执行。</p>
<p>通过上面的一波执行，看一下数据库的最终结果是什么样的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">之前：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
之后：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样看，这些数据也没啥问题，但是我们再来看看这时候 binlog 里面的内容。</p>
<ul>
<li>session B 被阻塞了，所以session C是先提交的，binlog先记录：insert into t values(1,1,5);update t set c&#x3D;5 where id&#x3D;1;</li>
<li>然后session A执行完了，binlog记录：update t set d &#x3D; 100 where d &#x3D; 5;</li>
<li>最后是session B执行完了，binlog记录：update t set d&#x3D;5 where id &#x3D;0; update t set c&#x3D;5 where id &#x3D;0;</li>
<li>汇总之后，就是下面这样：</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">//session C</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">update</span> t <span class="token keyword">set</span> c<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token comment">//session A</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> d<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> d<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">//session B</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> d<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/*(0,0,5)*/</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> c<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/*(0,5,5)*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后备库执行上面的binlog之后，结果是什么样的呢？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">之前：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
之后：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>到这里，比较一下，你就发现了问题</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">主库：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span>
备库：<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>虽然 session B的更新的问题解决了，但是 session C 插入的那一条记录，还是不对。这个问题也很严重。</p>
<p>那么为什么呢？我都对所有的记录，都加了锁，为什么还是不行呢？</p>
<ul>
<li>因为我们在加锁的时候，session C还没有执行的，而等 session C执行完之后，session A已经加锁完毕了</li>
<li>这就导致了 id &#x3D; 1 这一样记录，没有加上锁。</li>
</ul>
<p>也就是说，即使把所有的记录都加上锁，还是阻止不了新插入的记录，</p>
<h3 id="间隙锁（InnoDB解决幻读）"><a href="#间隙锁（InnoDB解决幻读）" class="headerlink" title="间隙锁（InnoDB解决幻读）"></a>间隙锁（InnoDB解决幻读）</h3><p>由于行锁只能锁住行，当我们向两条记录中间新插入记录的时候，会导致幻读的产生。</p>
<p>对于新插入记录这个动作，要更新的是记录之间的“间隙”。</p>
<p>因此，为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)。</p>
<h4 id="什么是间隙锁（Gap-Lock）"><a href="#什么是间隙锁（Gap-Lock）" class="headerlink" title="什么是间隙锁（Gap Lock）"></a>什么是间隙锁（Gap Lock）</h4><p>顾名思义，间隙锁，锁的就是两个值之间的空隙。比如下面这个表 t，初始化插入了 6 个记录，这就产生了 7 个间隙。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们插入了 6 个记录，就产生了 7 个间隙</p>
<ul>
<li>(-∞,0)</li>
<li>(0,5)</li>
<li>(5,10)</li>
<li>(10,15)</li>
<li>(15,20)</li>
<li>(25,+∞)</li>
</ul>
<p>这样，当执行 <code>select * from t where d=5 for update</code> 的时候，因为扫描全表；</p>
<p>就不止是给数据库中已有的 6 个记录加上了行锁</p>
<p>还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。</p>
<h4 id="何时加-x2F-释放间隙锁"><a href="#何时加-x2F-释放间隙锁" class="headerlink" title="何时加 &#x2F; 释放间隙锁"></a>何时加 &#x2F; 释放间隙锁</h4><p>间隙锁是在RR隔离级别下才会生效的。</p>
<p>如果不想使用间隙锁：可以将隔离级别设置成RC，但是同样的，需要解决可能出现的数据和日志不一致问题，需要把 binlog 格式设置为 row</p>
<p>事实上，在事务执行过程中，间隙锁不会单独加上，因为加锁的最小粒度是 next-key lock（[next-key lock](#next-key lock)）</p>
<p>具体是怎么加的，可以参考：<a href="#%E5%8A%A0%E9%94%81/%E9%87%8A%E6%94%BE%E9%94%81/%E6%9F%A5%E7%9C%8B%E9%94%81%E8%A7%84%E5%88%99">加锁&#x2F;释放锁&#x2F;查看锁规则</a></p>
<p>但是呢，我们可以简单的理解：在事务中，间隙锁是在语句执行时才加上的（[案例十：IN 语句加锁（动态加锁）](#案例十：IN 语句加锁（动态加锁）)）</p>
<p>释放是统一在事务结束时才释放</p>
<h4 id="间隙锁和行锁的互斥关系"><a href="#间隙锁和行锁的互斥关系" class="headerlink" title="间隙锁和行锁的互斥关系"></a>间隙锁和行锁的互斥关系</h4><p>间隙锁与间隙锁之间，不存在任何冲突。</p>
<p>间隙锁与行锁之间，不存在任何冲突。</p>
<p>跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。间隙锁之间都不存在冲突关系。</p>
<h4 id="面试：RR隔离级别能解决幻读吗"><a href="#面试：RR隔离级别能解决幻读吗" class="headerlink" title="面试：RR隔离级别能解决幻读吗"></a>面试：RR隔离级别能解决幻读吗</h4><p>先说结论：能解决，但不能完全解决。</p>
<p>在快照读的情况下：</p>
<ul>
<li><p>RR隔离级别下，事务开启的时候，就会启动一个readview，是可以解决脏读、不可重复读以及幻读问题的。</p>
</li>
<li><p>RC隔离级别下，都是当前读，没有快照读，因此无法解决不可重复读以及幻读问题。</p>
</li>
</ul>
<p>在当前读的情况下：</p>
<ul>
<li><p>RR隔离级别下，由于有行锁和间隙锁的存在，当前读也是可以解决脏读、不可重复读以及幻读问题的</p>
</li>
<li><p>RC隔离级别下，只有行锁，没有间隙锁，因此无法解决不可重复读以及幻读问题。</p>
</li>
</ul>
<p>那么，为什么说RR隔离级别下没有完全解决幻读问题呢？</p>
<ul>
<li>事务1 先快照读，事务2新增了一条数据并提交事务，事务1再当前读。</li>
<li>事务1 先快照读，事务2新增了一条数据并提交事务，事务1对事务2提交的数据进行了修改，事务1再次快照读。</li>
</ul>
<p>情况1不用说了吧，很好理解。对于情况2， 事务1的更新操作不属于快照读，因此事务1的更新操作是可以生效的，而当前数据会记录最新修改的记录，最新修改的记录为当前事务自己，所以是能看到的。</p>
<h3 id="next-key-lock"><a href="#next-key-lock" class="headerlink" title="next-key lock"></a>next-key lock</h3><h4 id="什么是next-key-lock"><a href="#什么是next-key-lock" class="headerlink" title="什么是next-key lock"></a>什么是next-key lock</h4><p>间隙锁 和 行锁 合称： next-key lock，每个 next-key lock 是前开后闭区间。</p>
<p>比如下面这张表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们插入了 6 个记录，如果用 select * from t for update 要把整个表所有记录锁起来。</p>
<p>此时产生了：6个行锁，7个间隙锁；7个next-key lock</p>
<p>7个next-key lock 分别是 </p>
<ul>
<li>(-∞,0]</li>
<li>(0,5]</li>
<li>(5,10]</li>
<li>(10,15]</li>
<li>(15,20]</li>
<li>(20, 25]</li>
<li>(25, +supremum]     <ul>
<li>这个 <code>supremum </code>是啥？</li>
<li>这是因为 +∞是开区间。所以 InnoDB 给每个索引加了一个不存在的最大值 supremum，这样才符合我们前面说的“都是前开后闭区间”</li>
</ul>
</li>
</ul>
<h4 id="何时加-x2F-释放next-key-lock"><a href="#何时加-x2F-释放next-key-lock" class="headerlink" title="何时加 &#x2F; 释放next-key lock"></a>何时加 &#x2F; 释放next-key lock</h4><p>在事务执行过程中，加锁的最小粒度是 next-key lock（[next-key lock](#next-key lock)），具体是怎么加的，可以参考：<a href="#%E5%8A%A0%E9%94%81/%E9%87%8A%E6%94%BE%E9%94%81/%E6%9F%A5%E7%9C%8B%E9%94%81%E8%A7%84%E5%88%99">加锁&#x2F;释放锁&#x2F;查看锁规则</a></p>
<p>释放是统一在事务结束时才释放</p>
<h3 id="间隙锁的死锁场景"><a href="#间隙锁的死锁场景" class="headerlink" title="间隙锁的死锁场景"></a>间隙锁的死锁场景</h3><p>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。</p>
<p>场景：任意锁住一行，如果这一行不存在的话就插入，如果存在这一行就更新它的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">
<span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看下面这个场景：</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select * from t where id &#x3D; 9 for update;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>begin<br/>select * from t where id &#x3D; 9 for update;</td>
</tr>
<tr>
<td></td>
<td>insert into t values(9,9,9);<br/><font color='red'>blocked</font></td>
</tr>
<tr>
<td>insert into t values(9,9,9);<br/><font color='red'>ERROR 1231 (40001) : Deadlock found</font></td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>session A 执行 select … for update 语句，由于 id&#x3D;9 这一行并不存在，因此会加上间隙锁 (5,10);</li>
<li>session B 执行 select … for update 语句，同样会加上间隙锁 (5,10)，间隙锁之间不会冲突，因此这个语句可以执行成功；</li>
<li>session B 试图插入一行 (9,9,9)，被 session A 的间隙锁挡住了，只好进入等待；</li>
<li>session A 试图插入一行 (9,9,9)，被 session B 的间隙锁挡住了。</li>
<li>至此，两个 session 进入互相等待状态，形成死锁。</li>
</ul>
<p>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。</p>
<p>间隙锁是在RR隔离级别下才会生效的。</p>
<p>如果不想使用间隙锁：可以将隔离级别设置成RC，但是同样的，需要解决可能出现的数据和日志不一致问题，需要把 binlog 格式设置为 row（使用statement容易出现数据不一致）</p>
<h3 id="题外话：隔离级别RC-ROW"><a href="#题外话：隔离级别RC-ROW" class="headerlink" title="题外话：隔离级别RC+ROW"></a>题外话：隔离级别RC+ROW</h3><p>mysql 默认的隔离级别是RR，但是一般在大公司内部的数据库，都是使用RC格式，并且statement格式都是：ROW，这是为什么呢？</p>
<p>比如我司用的就是：RC+ROW</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%isolation%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------+----------------+</span>
<span class="token operator">|</span> Variable_name         <span class="token operator">|</span> <span class="token keyword">Value</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+----------------+</span>
<span class="token operator">|</span> transaction_isolation <span class="token operator">|</span> <span class="token keyword">READ</span><span class="token operator">-</span><span class="token keyword">COMMITTED</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+----------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%binlog_format%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> binlog_format <span class="token operator">|</span> <span class="token keyword">ROW</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>为什么要使用 RC+ROW呢？</p>
<p>结论先行：为了提升并发和降低死锁产生的概率；同时保证数据的一致性；</p>
<ul>
<li>前面说到，间隙锁的存在会导致锁的范围变大，就更容易导致死锁的产生，比如上面的场景；</li>
<li>而间隙锁是只有在 RR  隔离级别下，才会有的。</li>
<li>所以为了避免使用间隙锁而导致的问题，可以把隔离级别设置成：RC</li>
<li>另外，binlog的格式使用 ROW，是因为默认使用的STATEMENT由于记录的是sql原文，有可能导致主从数据不一致。</li>
</ul>
<p>有的朋友发现他们公司就使用的是RC+ROW 的组合。他曾问他们公司的 DBA 说，你为什么要这么配置。DBA 直接答复说，因为大家都这么用呀。</p>
<p>但其实我想说的是，配置是否合理，跟<strong>业务场景</strong>有关，需要具体问题具体分析。但是，如果 DBA 认为之所以这么用的原因是“大家都这么用”，那就有问题了，或者说，迟早会出问题。</p>
<h4 id="问：什么场景，需要RR来保证？"><a href="#问：什么场景，需要RR来保证？" class="headerlink" title="问：什么场景，需要RR来保证？"></a>问：什么场景，需要RR来保证？</h4><ul>
<li>一般要求数据一致性的时候，比如备份，比如数据核对校验的场景，金融行业场景。</li>
</ul>
<h4 id="问：大家都用RC，可是逻辑备份的时候，mysqldump-为什么要把备份线程设置成RR呢？"><a href="#问：大家都用RC，可是逻辑备份的时候，mysqldump-为什么要把备份线程设置成RR呢？" class="headerlink" title="问：大家都用RC，可是逻辑备份的时候，mysqldump 为什么要把备份线程设置成RR呢？"></a>问：大家都用RC，可是逻辑备份的时候，mysqldump 为什么要把备份线程设置成RR呢？</h4><ul>
<li>通过一致性视图保证备份时数据的一致性</li>
<li>同时备份的时候不阻塞数据库的DDL</li>
</ul>
<h4 id="问：在备份期间，备份线程用的是RR，而业务线程用的是RC。同时存在会不会有问题？"><a href="#问：在备份期间，备份线程用的是RR，而业务线程用的是RC。同时存在会不会有问题？" class="headerlink" title="问：在备份期间，备份线程用的是RR，而业务线程用的是RC。同时存在会不会有问题？"></a>问：在备份期间，备份线程用的是RR，而业务线程用的是RC。同时存在会不会有问题？</h4><ul>
<li>没问题</li>
<li>RR是备份线程单独开启的，只在当前线程内生效</li>
<li>而且由于MVCC的支持，在事务开始的时候，就已经开始记录undolog了</li>
<li>有了回滚段，就能保证备份的时候的数据一致性。</li>
</ul>
<h4 id="问：这两个不同的隔离级别现象有什么不一样的？"><a href="#问：这两个不同的隔离级别现象有什么不一样的？" class="headerlink" title="问：这两个不同的隔离级别现象有什么不一样的？"></a>问：这两个不同的隔离级别现象有什么不一样的？</h4><ul>
<li>xxx</li>
</ul>
<h4 id="问：关于我们的业务，“用RC就够了”这个结论是怎么得到的？"><a href="#问：关于我们的业务，“用RC就够了”这个结论是怎么得到的？" class="headerlink" title="问：关于我们的业务，“用RC就够了”这个结论是怎么得到的？"></a>问：关于我们的业务，“用RC就够了”这个结论是怎么得到的？</h4><ul>
<li>xxx</li>
</ul>
<p>如果业务开发和运维团队这些问题都没有弄清楚，那么“没问题”这个结论，本身就是有问题的。</p>
<h2 id="加锁-x2F-释放锁-x2F-查看锁规则"><a href="#加锁-x2F-释放锁-x2F-查看锁规则" class="headerlink" title="加锁&#x2F;释放锁&#x2F;查看锁规则"></a>加锁&#x2F;释放锁&#x2F;查看锁规则</h2><p>上面只是介绍了锁，但是什么时候加锁（加锁规则），加了什么锁（查看），什么时候释放（释放锁），我们都还不知道。</p>
<p>适用版本：5.x 系列 &lt;&#x3D;5.7.24，8.0 系列 &lt;&#x3D;8.0.13</p>
<p>隔离级别（谈到加锁，必先谈隔离级别）：因为间隙锁在RR隔离级别下才有效，所以下面的加锁规则都是在RR隔离级别下</p>
<h3 id="锁是加在哪儿的"><a href="#锁是加在哪儿的" class="headerlink" title="锁是加在哪儿的"></a>锁是加在哪儿的</h3><p>锁就是加在索引上的，这是 InnoDB 的一个基础设定</p>
<p>InnoDB基础设定：锁加在索引上。 如果没有索引，锁加在主键上，主键是天然的唯一索引。</p>
<h3 id="怎么加锁的（加锁规则）"><a href="#怎么加锁的（加锁规则）" class="headerlink" title="怎么加锁的（加锁规则）"></a>怎么加锁的（加锁规则）</h3><h4 id="两个原则，两个优化，一个BUG"><a href="#两个原则，两个优化，一个BUG" class="headerlink" title="两个原则，两个优化，一个BUG"></a>两个原则，两个优化，一个BUG</h4><p>我总结的加锁规则里面，包含了两个“原则”、两个“优化”和一个“bug”。</p>
<ul>
<li>原则一：加锁的基本单位是 <code>next-key lock</code></li>
<li>原则二：查找过程中访问到对象才会加锁</li>
<li>优化一：索引上的等值查询，给<strong>唯一索引</strong>加锁的时候，next-key lock 退化为 行锁</li>
<li>优化二：索引上的等值查询，向右遍历且最后一个值不满足等值条件的时候，next-key lock 退化为 间隙锁</li>
<li>BUG一：<strong>唯一索引</strong>上的范围查询，会访问到不满足查询条件的第一个值为止。</li>
</ul>
<h4 id="案例一：主键索引等值查询"><a href="#案例一：主键索引等值查询" class="headerlink" title="案例一：主键索引等值查询"></a>案例一：主键索引等值查询</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>只给出现象，试着分析一下现象产生的原因</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>update t set d &#x3D; d + 1 where id &#x3D; 7;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values (8,8,8);<br/><font color = 'red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d &#x3D; d + 1 where id &#x3D; 10;<br/><font color = 'gree'>ok</font></td>
</tr>
</tbody></table>
<p>关键词：update语句，主键索引，主键记录不存在</p>
<ul>
<li>主键记录这一行存在的时候是行锁（优化一），这一行不存在，那就是间隙锁啦。</li>
</ul>
<h4 id="案例二：普通索引等值查询（覆盖索引的优化）"><a href="#案例二：普通索引等值查询（覆盖索引的优化）" class="headerlink" title="案例二：普通索引等值查询（覆盖索引的优化）"></a>案例二：普通索引等值查询（覆盖索引的优化）</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select id from t where c &#x3D; 5 lock in share mode;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d &#x3D; d + 1 where id &#x3D; 5;<br/><font color = 'gree'>ok</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values (7,7,7);<br/><font color = 'red'>blocked</font></td>
</tr>
</tbody></table>
<ul>
<li>关键词：lock in share mode，只查id是覆盖索引，c是普通索引</li>
<li>因为用到了覆盖索引，所以不会锁主键索引；</li>
<li>c是普通索引，而且是&#x3D;5的查询，锁  ( 0 , 5 ] </li>
<li>c是普通索引，还要继续向右查询，锁 (5,10] , 退化成  (5,10)，所以7插不进去</li>
</ul>
<p><strong>覆盖索引的优化</strong></p>
<p>数据行加读锁，如果查询字段使用了覆盖索引，访问到的对象只有普通索引，并没有访问到主键索引，则不会锁主键索引。</p>
<p>如果没有使用覆盖索引，且当前查询是for update ,update 和 delete 都是当前读，则会回表查询，访问到主键索引，这样主键索引也会加锁。</p>
<ul>
<li>lock in share mode 只锁覆盖索引</li>
<li>for update 就不一样了。 执行 for update 时，系统会认为你接下来要更新数据，因此会顺便给主键索引上满足条件的行加上行锁。</li>
</ul>
<h4 id="案例三：主键索引范围查询"><a href="#案例三：主键索引范围查询" class="headerlink" title="案例三：主键索引范围查询"></a>案例三：主键索引范围查询</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>对于主键查询，考虑下面两个语句，是一样的吗？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">
mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id<span class="token operator">>=</span><span class="token number">10</span> <span class="token operator">and</span> id<span class="token operator">&lt;</span><span class="token number">11</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>它们的查询结果是一样的，等价，但是不完全等价。</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select * from t where id&gt;&#x3D;10 and id&lt;11 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values (8,8,8);<br/><font color = 'gree'>ok</font><br/>insert into t values (13,13,13);<br/><font color = 'red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d &#x3D; d + 1 where id &#x3D; 15;<br/><font color = 'red'>blocked</font></td>
</tr>
</tbody></table>
<ul>
<li>关键词：主键索引，范围查询， for update</li>
<li>因为是 &gt;&#x3D; 10，访问到了10，所以是：( 5, 10 ] , 对10来说，是等值查询，退化成 锁10的行锁。</li>
<li>因为是范围查询，继续向右找，找到15，锁 ( 10 , 15 ] 这里不会退化，因为这是范围查询，不是等值查询，只有等值查询才会退化。 （但是在后续的版本中，8.0.19版本锁定区域已经是（10，15））</li>
</ul>
<h4 id="案例五：唯一索引范围查询（BUG）"><a href="#案例五：唯一索引范围查询（BUG）" class="headerlink" title="案例五：唯一索引范围查询（BUG）"></a>案例五：唯一索引范围查询（BUG）</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select * from t where id &gt; 10 and id &lt;&#x3D; 15 for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d &#x3D; d + 1 where id &#x3D; 20;<br/><font color = 'red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values (16,16,16);<br/><font color = 'red'>blocked</font></td>
</tr>
</tbody></table>
<ul>
<li>id &gt; 10，就不会访问到 10</li>
<li>id &lt;&#x3D; 15 , 访问到了 15，所以 锁 ( 10 , 15 ] ，因为bug的存在，会继续向右查找一个记录， 锁 ( 15, 20 ] </li>
<li>8.0.25，这个bug已经被修复，但是只修复了主键（主键也是唯一索引），唯一索引还没有修复</li>
</ul>
<h4 id="案例六：普通索引等值查询"><a href="#案例六：普通索引等值查询" class="headerlink" title="案例六：普通索引等值查询"></a>案例六：普通索引等值查询</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>delete from t where c &#x3D; 10;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values (12,12,12);<br/><font color = 'red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>update t set d &#x3D; d + 1 where c &#x3D; 15;<br/><font color = 'gree'>ok</font></td>
</tr>
</tbody></table>
<p>要想搞明白这个，需要先知道索引是有序的，所以上面这些数据，实际上索引的顺序是（普通索引的叶子节点存的是主键值）：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">字段c：	<span class="token number">0</span>	<span class="token number">5</span>	<span class="token number">10</span>	<span class="token number">10</span>	<span class="token number">15</span>	<span class="token number">20</span>	<span class="token number">25</span>
主键：		<span class="token number">0</span>	<span class="token number">5</span>	<span class="token number">10</span>	<span class="token number">30</span>	<span class="token number">15</span>	<span class="token number">20</span>	<span class="token number">25</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<ul>
<li>关键词：等值查询，普通索引，delete语句</li>
<li>delete 语句：加锁语义和 for update 是一样的，和update也是一样的。</li>
<li>c &#x3D; 10 , 且 c是普通索引，遍历到第一个 c &#x3D; 10，锁 ( 5 5,      10 10 ] </li>
<li>索引上的等值查询，会向右遍历，遍历到第二个 c&#x3D;10，锁 ( 5 5,      10 30 ] </li>
<li>索引上的等值查询，会向右遍历，遍历到c&#x3D;15，此时锁： ( 5 5,      15 15 ] ， 不满足查询条件，退化成间隙锁：锁 ( 5 5,      15 15 )</li>
<li>所以最终锁的范围就是：  ( 5 5,      15 15 )</li>
</ul>
<h4 id="案例七：limit-语句加锁"><a href="#案例七：limit-语句加锁" class="headerlink" title="案例七：limit 语句加锁"></a>案例七：limit 语句加锁</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>delete from t where c &#x3D; 10 limit 2;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values (12,12,12);<br/><font color = 'gree'>ok</font></td>
</tr>
</tbody></table>
<ul>
<li>关键词：等值查询，普通索引，delete语句，有limit</li>
<li>delete 语句：加锁语义和 for update 是一样的，和update也是一样的。</li>
<li>c &#x3D; 10 , 且 c是普通索引，遍历到第一个 c &#x3D; 10，锁 ( 5 5,      10 10 ] </li>
<li>索引上的等值查询，会向右遍历，遍历到第二个 c&#x3D;10，锁 ( 5 5,      10 30 ] ，此时满足了limit的条件，不在向后遍历</li>
<li>所以最终锁的范围就是：  ( 5 5,      10 30 ]</li>
</ul>
<h4 id="案例八：一个死锁的例子（验证next-key-lock-x3D-间隙锁-行锁）"><a href="#案例八：一个死锁的例子（验证next-key-lock-x3D-间隙锁-行锁）" class="headerlink" title="案例八：一个死锁的例子（验证next-key lock &#x3D;间隙锁+行锁）"></a>案例八：一个死锁的例子（验证next-key lock &#x3D;间隙锁+行锁）</h4><table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select id from t where c &#x3D; 10 lock in share mode;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d &#x3D; d + 1 where c &#x3D; 10;<br/><font color = 'red'>blocked</font></td>
</tr>
<tr>
<td>insert into t values(8,8,8);</td>
<td></td>
</tr>
<tr>
<td></td>
<td><font color = 'red'>ERROR 1213(40001):Deadlock found when trying to get lock;try restaring transaction</font></td>
</tr>
</tbody></table>
<ul>
<li>关键词：c有普通索引，覆盖索引查询，等值查询，lock in share mode当前读</li>
<li>session A 的 select 语句会加锁： ( 5 , 10 ]  和 ( 10 , 15 )</li>
<li>session B 的 update 语句也要在索引 c 上加  ( 5 , 10 ] ，进入锁等待；</li>
<li>session A 的 insert 语句需要再插入 (8,8,8) 这一行，被 session B 的间隙锁锁住。由于出现了死锁，InnoDB 让 session B 回滚。</li>
</ul>
<p>那么问题来了，<strong>session B 的 next-key lock 不是还没申请成功吗？</strong></p>
<p>其实是这样的，session B 的“加 next-key lock(5,10] ”操作，实际上分成了两步，先是加 (5,10) 的间隙锁，加锁成功（间隙锁与间隙锁之间没有加锁冲突）；然后加 c&#x3D;10 的行锁，这时候才被锁住的。</p>
<p>也就是说，我们在分析加锁规则的时候可以用 next-key lock 来分析。但是要知道，具体执行的时候，是要分成间隙锁和行锁两段来执行的。</p>
<h4 id="案例九：范围查询ORDER-BY排序加锁"><a href="#案例九：范围查询ORDER-BY排序加锁" class="headerlink" title="案例九：范围查询ORDER BY排序加锁"></a>案例九：范围查询ORDER BY排序加锁</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
<th>session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select * from t where c &gt;&#x3D; 15 and c &lt;&#x3D; 20 order by c desc for update;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>insert into t values (11,11,11);<br/><font color = 'red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>insert into t values (6,6,6);<br/><font color = 'red'>blocked</font></td>
</tr>
</tbody></table>
<p>题外话：</p>
<p>下面俩sql有啥区别？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c <span class="token operator">>=</span> <span class="token number">15</span> <span class="token operator">and</span> c <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c <span class="token keyword">desc</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> c <span class="token operator">>=</span> <span class="token number">15</span> <span class="token operator">and</span> c <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c <span class="token keyword">desc</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>在上面语句中，没有区别；但是在下面的语句中会有区别</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> id <span class="token keyword">from</span> t <span class="token keyword">where</span> c <span class="token operator">>=</span> <span class="token number">15</span> <span class="token operator">and</span> c <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c <span class="token keyword">desc</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> id <span class="token keyword">from</span> t <span class="token keyword">where</span> c <span class="token operator">>=</span> <span class="token number">15</span> <span class="token operator">and</span> c <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token keyword">order</span> <span class="token keyword">by</span> c <span class="token keyword">desc</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>当使用覆盖索引的时候：</li>
<li>for update 会对主键索引也加锁。</li>
<li>lock in share mode 不会对主键加锁。</li>
<li>这是 <a href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%EF%BC%9A%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E7%AD%89%E5%80%BC%E6%9F%A5%E8%AF%A2%EF%BC%88%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%89">覆盖索引的优化</a>。</li>
</ul>
<p>回过来，接着看这个思考题</p>
<ul>
<li>关键词：for update，范围查询，用到了普通索引，没有用覆盖索引</li>
<li>由于有 order by c desc，所以索引c的扫描顺序是： 25-&gt;20-&gt;15-&gt;10-&gt;5-&gt;0</li>
<li>当遍历到 c &#x3D; 20 时，满足查询条件，锁 ( 15 , 20 ]</li>
<li>然后 c 不是唯一索引，所以还会继续向右扫描，直到遇到 25,又加一个 next-key lock (20,25]，不过 25 不满足条件，退化为间隙锁(20,25)。</li>
<li>继续遍历下一个 c &#x3D; 15，满足查询条件，锁 ( 10 , 15 ]</li>
<li>继续遍历下一个 c &#x3D; 10，不满足查询条件，锁 ( 5 , 10 ]</li>
<li>因为 c 不是唯一索引，也不会用到 “两个优化” 原则，所以在索引c上最终锁的范围就是： ( 10 , 25 ]</li>
<li>因为是for update，会对扫描到的行也加锁。锁：c&#x3D;20、c&#x3D;15、c&#x3D;10 这三行加三个行锁。</li>
<li>最终锁的范围就是：（ 5，25），</li>
</ul>
<h4 id="案例十：IN-语句加锁（动态加锁）"><a href="#案例十：IN-语句加锁（动态加锁）" class="headerlink" title="案例十：IN 语句加锁（动态加锁）"></a>案例十：IN 语句加锁（动态加锁）</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select id from t where c in(5,20,10) lock in share mode;</td>
</tr>
</tbody></table>
<ul>
<li>关键词：in语句，覆盖索引</li>
<li>in 语句的查询，mysql默认会对 in  中的数据，进行升序排序。</li>
<li>所以这个语句其实是：<code>begin;&lt;br/&gt;select id from t where c in(5,10,20) lock in share mode;</code></li>
<li>查找c&#x3D;5的时候，加锁 ( 0 , 5 ]，因为c不是唯一索引，继续向右遍历，锁 ( 5, 10 ]，退化成 ( 5 , 10 )</li>
<li>查找c&#x3D;10的时候，加锁 ( 5, 10 ]，因为c不是唯一索引，继续向右遍历，锁 ( 10, 15 ]，退化成 ( 10 , 15 )</li>
<li>查找c&#x3D;20的时候，加锁 ( 15, 20 ]，因为c不是唯一索引，继续向右遍历，锁 ( 20, 25 ]，退化成 ( 20 , 25 )</li>
<li>所以最终范围是：( 0 , 5 ]   ( 5, 10 ]   ( 10 , 15 )    ( 15, 20 ]   ( 20 , 25 )  </li>
<li>简单的说就是：( 0 ，25 ) 中去掉 15 的行锁</li>
</ul>
<p><strong>动态加锁</strong></p>
<p>你可能会说，这个加锁范围，不就是从 (5,25) 中去掉 c&#x3D;15 的行锁吗？为什么这么麻烦地分段说呢？</p>
<p>因为我要跟你强调这个过程：这些锁是“在执行过程中一个一个加的”，而不是一次性加上去的。</p>
<p>这就是动态加锁。执行到哪里，就加锁加到哪里。</p>
<h4 id="案例十一：一个死锁的例子（验证动态加锁）"><a href="#案例十一：一个死锁的例子（验证动态加锁）" class="headerlink" title="案例十一：一个死锁的例子（验证动态加锁）"></a>案例十一：一个死锁的例子（验证动态加锁）</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 准备表和数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select id from t where c in(5,20,10) lock in share mode;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>select id from t where c in(5,20,10) order by c desc for update;</td>
</tr>
</tbody></table>
<p>现象：当上面两个语句并发执行的时候，会导致死锁，分析为什么？</p>
<ul>
<li>关键词：in 语句，order by 语句，覆盖索引</li>
<li>session A上的语句，in 语句的查询，mysql默认会对 in  中的数据，进行升序排序。</li>
<li>所以sessionA上的语句，等价于：<code>select id from t where c in(5,10,20) lock in share mode;</code></li>
<li>而sessionB上的语句，由于指定了排序，in 中的数据顺序会按照执行的排序进行排。</li>
<li>所以sessionB上的语句，等价于：<code>select id from t where c in(20,10,5) order by c desc for update;</code></li>
<li>由于是<strong>动态加锁</strong>：sessionA上的加锁顺序是：( 0 , 5 ]   ( 5, 10 ]   ( 10 , 15 )    ( 15, 20 ]   ( 20 , 25 )  </li>
<li>由于是<strong>动态加锁</strong>：sessionB上的加锁顺序是：( 20 , 25 )   ( 15, 20 ]   ( 10 , 15 )    ( 5, 10 ]    ( 0 , 5 ]</li>
<li>也就是说，这两条语句要加锁相同的资源，但是加锁顺序相反。当这两条语句并发执行的时候，就可能出现<strong>死锁</strong>。</li>
</ul>
<p>所以：</p>
<ul>
<li>由于锁是一个个加的（动态加锁），要避免死锁，对同一组资源，要按照尽量相同的顺序访问。</li>
<li>在发生死锁的时刻，innodb会选择回滚成本更小（占用资源最少）的语句进行回滚： for update 语句占有的资源比 lock in share mode 要多</li>
</ul>
<h3 id="释放锁"><a href="#释放锁" class="headerlink" title="释放锁"></a>释放锁</h3><p>RR隔离级别遵守两阶段锁协议，所有加锁的资源，都是在事务提交或者回滚的时候才释放的。</p>
<p>1、间隙锁只发生于RR隔离级别下</p>
<p>2、RR隔离级别下遵守两阶段提交，事务结束才释放锁 </p>
<p>3、RC隔离级别 没有间隙锁</p>
<p>4、RC隔离级别 语句执行完就释放“不满足条件的行”的行锁，而不是在事务结束的时候才释放</p>
<h3 id="查看锁"><a href="#查看锁" class="headerlink" title="查看锁"></a>查看锁</h3><p>在<code>information_scheme</code>库中有两张表</p>
<ul>
<li><p><code>innodb_locks</code>：该表中会记录一些锁信息：</p>
<ul>
<li>如果一个事务想要获取某个锁但未获取到，该锁信息将被记录。</li>
<li>如果一个事务因为获取到了某个锁，但是这个锁阻塞了别的事务的话，该锁信息会被记录。</li>
<li>正常获取锁释放锁，没有阻塞的情况，在这张表中，不会被记录。</li>
</ul>
</li>
<li><p><code>innodb_lock_waits</code>：表明当前系统中因为等待哪些锁而让事务进入阻塞状态。</p>
</li>
</ul>
<p>还可以使用<code>SHOW ENGINE INNODB STATUS</code>中有两个部分：</p>
<ul>
<li><code>TRANSACTIONS</code>这一部分表示当前系统中，每个事务加了哪些锁。</li>
<li><code>LATEST DETECTED DEADLOCK</code>这一部分是表示当系统中出现死锁的时候，记录的最后一次死锁的信息</li>
</ul>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>在上面介绍其他锁的时候，穿插着介绍了很多死锁的场景，这里汇总一下</p>
<h3 id="什么是死锁-1"><a href="#什么是死锁-1" class="headerlink" title="什么是死锁"></a>什么是死锁</h3><ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81">什么是死锁</a></li>
</ul>
<h3 id="出现死锁怎么办-1"><a href="#出现死锁怎么办-1" class="headerlink" title="出现死锁怎么办"></a>出现死锁怎么办</h3><ul>
<li><a href="#%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81%E6%80%8E%E4%B9%88%E5%8A%9E">出现死锁怎么办</a></li>
</ul>
<h4 id="死锁等待-1"><a href="#死锁等待-1" class="headerlink" title="死锁等待"></a>死锁等待</h4><ul>
<li><a href="#%E6%AD%BB%E9%94%81%E7%AD%89%E5%BE%85">死锁等待</a></li>
</ul>
<h4 id="死锁检测"><a href="#死锁检测" class="headerlink" title="死锁检测"></a>死锁检测</h4><ul>
<li><a href="#%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89">死锁检测（推荐）</a></li>
</ul>
<h3 id="死锁的出现场景"><a href="#死锁的出现场景" class="headerlink" title="死锁的出现场景"></a>死锁的出现场景</h3><h4 id="MDL锁的死锁场景-1"><a href="#MDL锁的死锁场景-1" class="headerlink" title="MDL锁的死锁场景"></a>MDL锁的死锁场景</h4><ul>
<li><a href="#MDL%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF">MDL锁的死锁场景</a><ul>
<li>如何安全的给小表加索引</li>
</ul>
</li>
</ul>
<h4 id="行锁的死锁场景-1"><a href="#行锁的死锁场景-1" class="headerlink" title="行锁的死锁场景"></a>行锁的死锁场景</h4><ul>
<li><a href="#%E8%A1%8C%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF">行锁的死锁场景</a><ul>
<li>热点行更新的性能问题</li>
</ul>
</li>
</ul>
<h4 id="间隙锁的死锁场景-1"><a href="#间隙锁的死锁场景-1" class="headerlink" title="间隙锁的死锁场景"></a>间隙锁的死锁场景</h4><ul>
<li><a href="#%E9%97%B4%E9%9A%99%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF">间隙锁的死锁场景</a><ul>
<li>任意锁住一行，如果这一行不存在的话就插入，如果存在这一行就更新它的数据</li>
</ul>
</li>
</ul>
<h4 id="next-key-lock-的死锁场景"><a href="#next-key-lock-的死锁场景" class="headerlink" title="next-key lock 的死锁场景"></a>next-key lock 的死锁场景</h4><ul>
<li>[案例八：一个死锁的例子（验证next-key lock &#x3D;间隙锁+行锁）](#案例八：一个死锁的例子（验证next-key lock &#x3D;间隙锁+行锁）)<ul>
<li>加锁的粒度是next-key lock，但是实际上间隙锁和行锁是分开执行的</li>
</ul>
</li>
</ul>
<h3 id="怎么查看死锁"><a href="#怎么查看死锁" class="headerlink" title="怎么查看死锁"></a>怎么查看死锁</h3><p>通过一个简单的死锁，来分析死锁现场</p>
<p>准备数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>按照下面的步骤语句</p>
<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>update t set d &#x3D; 55 where c &#x3D; 5;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>begin<br/>update t set d &#x3D; 1010 where c &#x3D; 10;</td>
</tr>
<tr>
<td>update t set d &#x3D; 101010 where c &#x3D; 10;<br/><font color='red'>blocked</font></td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set d &#x3D; 555 where c &#x3D; 5;<br/><font color='red'>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</font></td>
</tr>
<tr>
<td><font color='gree'>Query OK</font></td>
<td></td>
</tr>
</tbody></table>
<p>执行命令：<code>show engine innodb status;</code>,会返回好多好多信息。</p>
<p>其中有一段是：LATEST DETECTED DEADLOCK，表示的就是：记录的最后一次死锁信息（innoDB只会记录最后一次的死锁信息）。</p>
<p>摘录如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">------------------------</span>
LATEST DETECTED DEADLOCK
<span class="token comment">------------------------</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">20</span>:<span class="token number">57</span>:<span class="token number">44</span> <span class="token number">0x216c</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">TRANSACTION</span>:
<span class="token keyword">TRANSACTION</span> <span class="token number">1829</span><span class="token punctuation">,</span> ACTIVE <span class="token number">63</span> sec <span class="token keyword">starting</span> <span class="token keyword">index</span> <span class="token keyword">read</span>
mysql <span class="token keyword">tables</span> <span class="token operator">in</span> <span class="token keyword">use</span> <span class="token number">1</span><span class="token punctuation">,</span> locked <span class="token number">1</span>
<span class="token keyword">LOCK</span> WAIT <span class="token number">5</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> undo log entries <span class="token number">1</span>
MySQL thread id <span class="token number">11</span><span class="token punctuation">,</span> OS thread handle <span class="token number">22644</span><span class="token punctuation">,</span> query id <span class="token number">21</span> localhost ::<span class="token number">1</span> root updating
<span class="token keyword">update</span> t <span class="token keyword">set</span> d <span class="token operator">=</span> <span class="token number">101010</span> <span class="token keyword">where</span> c <span class="token operator">=</span> <span class="token number">10</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> HOLDS THE <span class="token keyword">LOCK</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span>:
RECORD LOCKS space id <span class="token number">7</span> page <span class="token keyword">no</span> <span class="token number">5</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> c <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>xx<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">1829</span> lock_mode X
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000005</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000005</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>


<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> WAITING <span class="token keyword">FOR</span> THIS <span class="token keyword">LOCK</span> <span class="token keyword">TO</span> BE GRANTED:
RECORD LOCKS space id <span class="token number">7</span> page <span class="token keyword">no</span> <span class="token number">5</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> c <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>xx<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">1829</span> lock_mode X waiting
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>a<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>a<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>


<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">TRANSACTION</span>:
<span class="token keyword">TRANSACTION</span> <span class="token number">1830</span><span class="token punctuation">,</span> ACTIVE <span class="token number">28</span> sec <span class="token keyword">starting</span> <span class="token keyword">index</span> <span class="token keyword">read</span>
mysql <span class="token keyword">tables</span> <span class="token operator">in</span> <span class="token keyword">use</span> <span class="token number">1</span><span class="token punctuation">,</span> locked <span class="token number">1</span>
<span class="token keyword">LOCK</span> WAIT <span class="token number">5</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> undo log entries <span class="token number">1</span>
MySQL thread id <span class="token number">12</span><span class="token punctuation">,</span> OS thread handle <span class="token number">14380</span><span class="token punctuation">,</span> query id <span class="token number">22</span> localhost ::<span class="token number">1</span> root updating
<span class="token keyword">update</span> t <span class="token keyword">set</span> d <span class="token operator">=</span> <span class="token number">555</span> <span class="token keyword">where</span> c <span class="token operator">=</span> <span class="token number">5</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> HOLDS THE <span class="token keyword">LOCK</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span>:
RECORD LOCKS space id <span class="token number">7</span> page <span class="token keyword">no</span> <span class="token number">5</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> c <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>xx<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">1830</span> lock_mode X
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>a<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>a<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>


<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> WAITING <span class="token keyword">FOR</span> THIS <span class="token keyword">LOCK</span> <span class="token keyword">TO</span> BE GRANTED:
RECORD LOCKS space id <span class="token number">7</span> page <span class="token keyword">no</span> <span class="token number">5</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> c <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>xx<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">1830</span> lock_mode X waiting
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000005</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000005</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> WE ROLL BACK <span class="token keyword">TRANSACTION</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>我们来看看其中的关键信息：</p>
<p>这个结果分成三部分</p>
<ul>
<li>(1) TRANSACTION，是第一个事务的信息</li>
<li>(2) TRANSACTION，是第二个事务的信息</li>
<li>WE ROLL BACK TRANSACTION (2)，是最终的处理结果，表示回滚了第二个事务。</li>
</ul>
<p>其他可以读取到的信息，这里就不在一一展示了。</p>
<h2 id="锁等待（间隙锁范围变大）"><a href="#锁等待（间隙锁范围变大）" class="headerlink" title="锁等待（间隙锁范围变大）"></a>锁等待（间隙锁范围变大）</h2><h3 id="什么是锁等待"><a href="#什么是锁等待" class="headerlink" title="什么是锁等待"></a>什么是锁等待</h3><p>通俗的说，就是语句A的执行需要锁，但是锁此时被语句B持有，所以，语句A想要正常执行，就需要等待语句B释放锁；</p>
<h3 id="锁等待的出现场景"><a href="#锁等待的出现场景" class="headerlink" title="锁等待的出现场景"></a>锁等待的出现场景</h3><h4 id="delete语句导致的锁等待场景"><a href="#delete语句导致的锁等待场景" class="headerlink" title="delete语句导致的锁等待场景"></a>delete语句导致的锁等待场景</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select * from t where id &gt; 10 and id &lt;&#x3D; 15 for update;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>delete from t where id &#x3D; 10;<br/><font color='gree'>ok</font></td>
</tr>
<tr>
<td></td>
<td>insert into t values (10,10,10);<br/><font color='red'>blocked</font></td>
</tr>
</tbody></table>
<ul>
<li>session A的语句锁的范围是：（ 10，15 ] （ 15， 20 ）</li>
<li>session B 执行delelte，因为10没有被锁，所以可以删掉。</li>
<li>那么执行sessionB执行insert 10的时候，为什么发生了锁等待，导致阻塞呢？</li>
<li>要想知道为什么，我们就要查看锁的信息，分析为什么产生锁等待。<ul>
<li>结论先贴出来：session A 原本锁的范围是：（ 10，15 ] （ 15， 20 ），当 session B 的delete语句执行之后，锁的范围自动变成了：（ 5，15 ] （ 15， 20 ）</li>
</ul>
</li>
</ul>
<h4 id="update语句导致的锁等待场景"><a href="#update语句导致的锁等待场景" class="headerlink" title="update语句导致的锁等待场景"></a>update语句导致的锁等待场景</h4><p>案例数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<table>
<thead>
<tr>
<th>session A</th>
<th>session B</th>
</tr>
</thead>
<tbody><tr>
<td>begin;<br/>select c from t where c &gt; 5 lock in share mode;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>update t set c &#x3D; 1 where c &#x3D; 5;<br/><font color='gree'>ok</font></td>
</tr>
<tr>
<td></td>
<td>update t set c &#x3D; 5 where c &#x3D; 1;<br/><font color='red'>blocked</font></td>
</tr>
</tbody></table>
<ul>
<li>session A 的语句是覆盖索引，锁的范围是：索引c上的 (5,10]、(10,15]、(15,20]、(20,25]和 (25,supremum]</li>
<li>session B 的一个更新语句，可以分为两步<ul>
<li>插入 c &#x3D; 1， id&#x3D;5 的记录： c&#x3D;1没有被锁，可以执行</li>
<li>删除 c &#x3D; 5，id&#x3D;5 的记录：c&#x3D;5没有被锁，可以执行</li>
</ul>
</li>
<li>这个语句执行完之后，锁的范围会发生变化：(1,10]、(10,15]、(15,20]、(20,25]和 (25,supremum]</li>
<li>session B的第二个更新语句，可以分为两步<ul>
<li>插入  c&#x3D;5，id&#x3D;5 的记录：因为c&#x3D;5已经被锁了，所以阻塞了。</li>
<li>插入 c&#x3D;1，id&#x3D;5 的记录：</li>
</ul>
</li>
</ul>
<h3 id="怎么查看锁等待"><a href="#怎么查看锁等待" class="headerlink" title="怎么查看锁等待"></a>怎么查看锁等待</h3><p>执行命令：<code>show engine innodb status;</code>,会返回好多好多信息。</p>
<p>其中有一段是：TRANSACTIONS，里面包含了锁信息，我们可以通过分析这部分，得到为什么产生锁等待。</p>
<p>摘录如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">------------</span>
<span class="token keyword">TRANSACTIONS</span>
<span class="token comment">------------</span>
Trx id counter <span class="token number">1871</span>
<span class="token keyword">Purge</span> done <span class="token keyword">for</span> trx's n:o <span class="token operator">&lt;</span> <span class="token number">1870</span> undo n:o <span class="token operator">&lt;</span> <span class="token number">0</span> state: running but idle
History list length <span class="token number">0</span>
LIST <span class="token keyword">OF</span> <span class="token keyword">TRANSACTIONS</span> <span class="token keyword">FOR</span> EACH <span class="token keyword">SESSION</span>:
<span class="token comment">---TRANSACTION 283993830666896, not started</span>
<span class="token number">0</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">---TRANSACTION 283993830664568, not started</span>
<span class="token number">0</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">---TRANSACTION 283993830663792, not started</span>
<span class="token number">0</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">---TRANSACTION 1870, ACTIVE 9 sec inserting</span>
mysql <span class="token keyword">tables</span> <span class="token operator">in</span> <span class="token keyword">use</span> <span class="token number">1</span><span class="token punctuation">,</span> locked <span class="token number">1</span>
<span class="token keyword">LOCK</span> WAIT <span class="token number">2</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">12</span><span class="token punctuation">,</span> OS thread handle <span class="token number">14380</span><span class="token punctuation">,</span> query id <span class="token number">79</span> localhost ::<span class="token number">1</span> root <span class="token keyword">update</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">------- TRX HAS BEEN WAITING 9 SEC FOR THIS LOCK TO BE GRANTED:</span>
RECORD LOCKS space id <span class="token number">8</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>xx<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">1870</span> lock_mode X locks gap before rec <span class="token keyword">insert</span> intention waiting
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">5</span> PHYSICAL RECORD: n_fields <span class="token number">5</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>f<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000073</span>a<span class="token punctuation">;</span> <span class="token keyword">asc</span>      :<span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000860137</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token number">7</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>f<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">8000000</span>f<span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token comment">------------------</span>
<span class="token comment">---TRANSACTION 1866, ACTIVE 54 sec</span>
<span class="token number">2</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1128</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">11</span><span class="token punctuation">,</span> OS thread handle <span class="token number">22644</span><span class="token punctuation">,</span> query id <span class="token number">74</span> localhost ::<span class="token number">1</span> root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>在死锁日志里：</p>
<ul>
<li><p>lock_mode X waiting：表示next-key lock； </p>
</li>
<li><p>lock_mode X locks rec but not gap：是只有行锁； </p>
</li>
<li><p>locks gap before rec：是只有间隙锁；</p>
</li>
</ul>
<p>通过分析以上日志：</p>
<ul>
<li>我们知道，由于 delete 操作把 id&#x3D;10 这一行删掉了，原来的两个间隙 (5,10)、(10,15）变成了一个 (5,15)。</li>
<li>也就是说：<ul>
<li>session A 原本锁的范围是：（ 10，15 ] （ 15， 20 ）</li>
<li>当 session B 的delete语句执行之后，锁的范围自动变成了：（ 5，15 ] （ 15， 20 ）</li>
</ul>
</li>
<li>这也就是：为什么 session B 的insert语句无法插入的原因了。</li>
</ul>
<h2 id="主键自增锁"><a href="#主键自增锁" class="headerlink" title="主键自增锁"></a>主键自增锁</h2><h3 id="什么是主键的自增锁"><a href="#什么是主键的自增锁" class="headerlink" title="什么是主键的自增锁"></a>什么是主键的自增锁</h3><p>我们知道主键是连续自增的，主键自增的实现逻辑是：</p>
<ul>
<li>每个表会有一个自增id（可以通过<code>show create table xx</code>语句查看，<code>AUTO_INCREMENT</code>表示的就是自增id）</li>
<li>每个 insert 语句都会获取自增id作为自己的主键id，然后会把 自增id+1 在写到 <code>AUTO_INCREMENT</code>中</li>
<li>接下来真正执行insert语句</li>
</ul>
<p>那么问题来了，如果是一个并发的 insert 语句，是有可能获取到相同的 自增id的，这样就会导致 insert 语句执行失败（主键冲突）。</p>
<p>所以 mysql 为了避免两个事务申请到相同的自增 id，肯定要加锁，然后顺序申请。</p>
<p>这里所加的锁，就是 主键自增锁。</p>
<p>自增 id 锁并不是一个事务锁，而是<strong>每次申请完就马上释放</strong>，以便允许别的事务再申请</p>
<h3 id="主键自增锁的发展历史"><a href="#主键自增锁的发展历史" class="headerlink" title="主键自增锁的发展历史"></a>主键自增锁的发展历史</h3><p>MySQL 5.0 ：自增锁的范围是语句级别。也就是说，如果一个语句申请了一个表自增锁，这个锁会等语句执行结束以后才释放。显然，这样设计会影响并发度。</p>
<p>MySQL 5.1.22 ：引入了一个新策略，新增参数<code> innodb_autoinc_lock_mode</code>，默认值是 1。</p>
<ul>
<li>设置为0：表示采用之前 MySQL 5.0 版本的策略，即语句执行结束后才释放锁；</li>
<li>设置为1：<ul>
<li>普通 insert 语句，自增锁在申请之后就马上释放</li>
<li>类似 insert … select 这样的批量插入数据的语句，自增锁还是要等语句结束后才被释放；</li>
</ul>
</li>
<li>设置为2：所有的申请自增主键的动作都是申请后就释放锁</li>
<li>在公司中，这个参数被设置为：2 ，配合binlog_format&#x3D;ROW可以解决数据一致性的问题</li>
</ul>
<h3 id="insert语句的锁"><a href="#insert语句的锁" class="headerlink" title="insert语句的锁"></a>insert语句的锁</h3><h4 id="insert-into-…-values-…"><a href="#insert-into-…-values-…" class="headerlink" title="insert into … values( … )"></a>insert into … values( … )</h4><h4 id="insert-into-…-select-…"><a href="#insert-into-…-select-…" class="headerlink" title="insert into … select …"></a>insert into … select …</h4><p>生产环境中，尽量不要使用，如果必须使用，一定要在后面的select中，加上where条件。</p>
<p>因为这个语句在执行过程中，会对所有扫描到的记录加锁。</p>
<p>这些被加锁的记录，在这个语句执行完之前，是执行不了的。</p>
<h4 id="insert-into-…-on-duplicate-key-update-…"><a href="#insert-into-…-on-duplicate-key-update-…" class="headerlink" title="insert into … on duplicate key update …"></a>insert into … on duplicate key update …</h4><p>插入一条记录，如果主键冲突了，则执行更新。</p>
<h2 id="残留的问题"><a href="#残留的问题" class="headerlink" title="残留的问题"></a>残留的问题</h2><p>insert语句中有很多的锁，比如：插入意向锁，本文没有细化；后续补充。。</p>
<p>锁的内存结构，一个锁加上的时候，在内存中，是一个怎样的存在。。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql</a><a class="post-meta__tags" href="/tags/%E9%94%81/">锁</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql%E7%9A%84%E9%94%81"><span class="toc-number">1.</span> <span class="toc-text">mysql的锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81%E5%92%8C%E7%8B%AC%E5%8D%A0%E9%94%81%EF%BC%88%E6%8E%92%E5%AE%83%E9%94%81%EF%BC%89"><span class="toc-number">1.1.1.</span> <span class="toc-text">共享锁和独占锁（排它锁）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%8F%E5%90%91%E5%85%B1%E4%BA%AB%E9%94%81%E4%B8%8E%E6%84%8F%E5%90%91%E7%8B%AC%E5%8D%A0%E9%94%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">意向共享锁与意向独占锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E9%94%81%E5%92%8C%E5%86%99%E9%94%81"><span class="toc-number">1.1.3.</span> <span class="toc-text">读锁和写锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E5%89%8D%E8%AF%BB%E5%92%8C%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="toc-number">1.1.4.</span> <span class="toc-text">当前读和快照读</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%94%81"><span class="toc-number">1.2.</span> <span class="toc-text">全局锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%85%A8%E5%B1%80%E9%94%81"><span class="toc-number">1.2.1.</span> <span class="toc-text">什么是全局锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E6%89%93%E5%BC%80-x2F-%E5%85%B3%E9%97%AD%E5%85%A8%E5%B1%80%E9%94%81%EF%BC%88FTWRL%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">何时打开 &#x2F; 关闭全局锁（FTWRL）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%94%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%88%E5%85%A8%E5%BA%93%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%EF%BC%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">全局锁使用场景（全库逻辑备份）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%BA%93%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">全库逻辑备份</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E5%A4%87%E4%BB%BD%E6%97%B6%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">怎么保证备份时数据一致性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E9%94%81%EF%BC%88%E8%A1%A8%E9%94%81-MDL%E9%94%81%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">表锁（表锁+MDL锁）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E9%94%81"><span class="toc-number">1.3.1.</span> <span class="toc-text">表锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%A1%A8%E9%94%81"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">什么是表锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E6%89%93%E5%BC%80-x2F-%E5%85%B3%E9%97%AD%E8%A1%A8%E9%94%81"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">何时打开&#x2F;关闭表锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E9%94%81%E7%9A%84%E8%AF%BB%E9%94%81%E5%92%8C%E5%86%99%E9%94%81"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">表锁的读锁和写锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">表锁的使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81%EF%BC%88meta-data-lock%EF%BC%8CMDL"><span class="toc-number">1.3.2.</span> <span class="toc-text">元数据锁（meta data lock，MDL)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">什么是元数据锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E6%89%93%E5%BC%80-x2F-%E5%85%B3%E9%97%AD%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">怎么打开&#x2F;关闭元数据锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDL%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">MDL的使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E8%AF%BB%E5%86%99%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%80%A7"><span class="toc-number">1.3.2.3.1.</span> <span class="toc-text">保证读写的正确性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ONLINE-DDL%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.2.3.2.</span> <span class="toc-text">ONLINE DDL的实现原理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDL%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">MDL锁的死锁场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%89%E5%85%A8%E7%9A%84%E7%BB%99%E5%B0%8F%E8%A1%A8%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.2.4.1.</span> <span class="toc-text">如何安全的给小表加索引</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E9%94%81%E4%B8%8E%E6%AD%BB%E9%94%81"><span class="toc-number">1.4.</span> <span class="toc-text">行锁与死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%A1%8C%E9%94%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">什么是行锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E9%94%81%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">两阶段锁协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E5%8A%A0-x2F-%E9%87%8A%E6%94%BE%E8%A1%8C%E9%94%81"><span class="toc-number">1.4.3.</span> <span class="toc-text">何时加 &#x2F; 释放行锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">什么是死锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="toc-number">1.4.5.</span> <span class="toc-text">出现死锁怎么办</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%AD%89%E5%BE%85"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">死锁等待</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">死锁检测（推荐）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%8C%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF"><span class="toc-number">1.4.6.</span> <span class="toc-text">行锁的死锁场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A1%8C%E6%9B%B4%E6%96%B0%E7%9A%84%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">热点行更新的性能问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%88%E5%B9%BB%E8%AF%BB%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">间隙锁（幻读）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BB%E8%AF%BB"><span class="toc-number">1.5.1.</span> <span class="toc-text">幻读</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%BB%E8%AF%BB"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">什么是幻读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%BB%E8%AF%BB%E7%9A%84%E4%BA%A7%E7%94%9F"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">幻读的产生</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%BB%E8%AF%BB%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">幻读的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%BB%E8%AF%BB%E7%A0%B4%E5%9D%8F%E8%AF%AD%E4%B9%89"><span class="toc-number">1.5.1.3.1.</span> <span class="toc-text">幻读破坏语义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%BB%E8%AF%BB%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="toc-number">1.5.1.3.2.</span> <span class="toc-text">幻读导致数据不一致</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%81%87%E8%AE%BE%E5%8F%AA%E9%94%81d-x3D-5%E5%85%B6%E4%BB%96%E8%AE%B0%E5%BD%95%E4%B8%8D%E5%8A%A0%E9%94%81"><span class="toc-number">1.5.1.3.2.1.</span> <span class="toc-text">假设只锁d&#x3D;5其他记录不加锁</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%81%87%E8%AE%BE%E7%BB%99%E6%89%80%E6%9C%89%E6%89%AB%E6%8F%8F%E5%88%B0%E7%9A%84%E8%AE%B0%E5%BD%95%E9%83%BD%E5%8A%A0%E9%94%81"><span class="toc-number">1.5.1.3.2.2.</span> <span class="toc-text">假设给所有扫描到的记录都加锁</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%88InnoDB%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB%EF%BC%89"><span class="toc-number">1.5.2.</span> <span class="toc-text">间隙锁（InnoDB解决幻读）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%88Gap-Lock%EF%BC%89"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">什么是间隙锁（Gap Lock）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E5%8A%A0-x2F-%E9%87%8A%E6%94%BE%E9%97%B4%E9%9A%99%E9%94%81"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">何时加 &#x2F; 释放间隙锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%E5%92%8C%E8%A1%8C%E9%94%81%E7%9A%84%E4%BA%92%E6%96%A5%E5%85%B3%E7%B3%BB"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">间隙锁和行锁的互斥关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%EF%BC%9ARR%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E8%83%BD%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB%E5%90%97"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">面试：RR隔离级别能解决幻读吗</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#next-key-lock"><span class="toc-number">1.5.3.</span> <span class="toc-text">next-key lock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFnext-key-lock"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">什么是next-key lock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E5%8A%A0-x2F-%E9%87%8A%E6%94%BEnext-key-lock"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">何时加 &#x2F; 释放next-key lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF"><span class="toc-number">1.5.4.</span> <span class="toc-text">间隙锁的死锁场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E5%A4%96%E8%AF%9D%EF%BC%9A%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%ABRC-ROW"><span class="toc-number">1.5.5.</span> <span class="toc-text">题外话：隔离级别RC+ROW</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E4%BB%80%E4%B9%88%E5%9C%BA%E6%99%AF%EF%BC%8C%E9%9C%80%E8%A6%81RR%E6%9D%A5%E4%BF%9D%E8%AF%81%EF%BC%9F"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">问：什么场景，需要RR来保证？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E5%A4%A7%E5%AE%B6%E9%83%BD%E7%94%A8RC%EF%BC%8C%E5%8F%AF%E6%98%AF%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8Cmysqldump-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%8A%8A%E5%A4%87%E4%BB%BD%E7%BA%BF%E7%A8%8B%E8%AE%BE%E7%BD%AE%E6%88%90RR%E5%91%A2%EF%BC%9F"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">问：大家都用RC，可是逻辑备份的时候，mysqldump 为什么要把备份线程设置成RR呢？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E5%9C%A8%E5%A4%87%E4%BB%BD%E6%9C%9F%E9%97%B4%EF%BC%8C%E5%A4%87%E4%BB%BD%E7%BA%BF%E7%A8%8B%E7%94%A8%E7%9A%84%E6%98%AFRR%EF%BC%8C%E8%80%8C%E4%B8%9A%E5%8A%A1%E7%BA%BF%E7%A8%8B%E7%94%A8%E7%9A%84%E6%98%AFRC%E3%80%82%E5%90%8C%E6%97%B6%E5%AD%98%E5%9C%A8%E4%BC%9A%E4%B8%8D%E4%BC%9A%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">问：在备份期间，备份线程用的是RR，而业务线程用的是RC。同时存在会不会有问题？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E8%BF%99%E4%B8%A4%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E7%8E%B0%E8%B1%A1%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84%EF%BC%9F"><span class="toc-number">1.5.5.4.</span> <span class="toc-text">问：这两个不同的隔离级别现象有什么不一样的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E5%85%B3%E4%BA%8E%E6%88%91%E4%BB%AC%E7%9A%84%E4%B8%9A%E5%8A%A1%EF%BC%8C%E2%80%9C%E7%94%A8RC%E5%B0%B1%E5%A4%9F%E4%BA%86%E2%80%9D%E8%BF%99%E4%B8%AA%E7%BB%93%E8%AE%BA%E6%98%AF%E6%80%8E%E4%B9%88%E5%BE%97%E5%88%B0%E7%9A%84%EF%BC%9F"><span class="toc-number">1.5.5.5.</span> <span class="toc-text">问：关于我们的业务，“用RC就够了”这个结论是怎么得到的？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E9%94%81-x2F-%E9%87%8A%E6%94%BE%E9%94%81-x2F-%E6%9F%A5%E7%9C%8B%E9%94%81%E8%A7%84%E5%88%99"><span class="toc-number">1.6.</span> <span class="toc-text">加锁&#x2F;释放锁&#x2F;查看锁规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E6%98%AF%E5%8A%A0%E5%9C%A8%E5%93%AA%E5%84%BF%E7%9A%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">锁是加在哪儿的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E5%8A%A0%E9%94%81%E7%9A%84%EF%BC%88%E5%8A%A0%E9%94%81%E8%A7%84%E5%88%99%EF%BC%89"><span class="toc-number">1.6.2.</span> <span class="toc-text">怎么加锁的（加锁规则）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E5%8E%9F%E5%88%99%EF%BC%8C%E4%B8%A4%E4%B8%AA%E4%BC%98%E5%8C%96%EF%BC%8C%E4%B8%80%E4%B8%AABUG"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">两个原则，两个优化，一个BUG</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%EF%BC%9A%E4%B8%BB%E9%94%AE%E7%B4%A2%E5%BC%95%E7%AD%89%E5%80%BC%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">案例一：主键索引等值查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%EF%BC%9A%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E7%AD%89%E5%80%BC%E6%9F%A5%E8%AF%A2%EF%BC%88%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%89"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">案例二：普通索引等值查询（覆盖索引的优化）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%EF%BC%9A%E4%B8%BB%E9%94%AE%E7%B4%A2%E5%BC%95%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">案例三：主键索引范围查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%94%EF%BC%9A%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%EF%BC%88BUG%EF%BC%89"><span class="toc-number">1.6.2.5.</span> <span class="toc-text">案例五：唯一索引范围查询（BUG）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%85%AD%EF%BC%9A%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E7%AD%89%E5%80%BC%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.6.2.6.</span> <span class="toc-text">案例六：普通索引等值查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%83%EF%BC%9Alimit-%E8%AF%AD%E5%8F%A5%E5%8A%A0%E9%94%81"><span class="toc-number">1.6.2.7.</span> <span class="toc-text">案例七：limit 语句加锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%85%AB%EF%BC%9A%E4%B8%80%E4%B8%AA%E6%AD%BB%E9%94%81%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%88%E9%AA%8C%E8%AF%81next-key-lock-x3D-%E9%97%B4%E9%9A%99%E9%94%81-%E8%A1%8C%E9%94%81%EF%BC%89"><span class="toc-number">1.6.2.8.</span> <span class="toc-text">案例八：一个死锁的例子（验证next-key lock &#x3D;间隙锁+行锁）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B9%9D%EF%BC%9A%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2ORDER-BY%E6%8E%92%E5%BA%8F%E5%8A%A0%E9%94%81"><span class="toc-number">1.6.2.9.</span> <span class="toc-text">案例九：范围查询ORDER BY排序加锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%8D%81%EF%BC%9AIN-%E8%AF%AD%E5%8F%A5%E5%8A%A0%E9%94%81%EF%BC%88%E5%8A%A8%E6%80%81%E5%8A%A0%E9%94%81%EF%BC%89"><span class="toc-number">1.6.2.10.</span> <span class="toc-text">案例十：IN 语句加锁（动态加锁）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%8D%81%E4%B8%80%EF%BC%9A%E4%B8%80%E4%B8%AA%E6%AD%BB%E9%94%81%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%88%E9%AA%8C%E8%AF%81%E5%8A%A8%E6%80%81%E5%8A%A0%E9%94%81%EF%BC%89"><span class="toc-number">1.6.2.11.</span> <span class="toc-text">案例十一：一个死锁的例子（验证动态加锁）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E9%94%81"><span class="toc-number">1.6.3.</span> <span class="toc-text">释放锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%94%81"><span class="toc-number">1.6.4.</span> <span class="toc-text">查看锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-number">1.7.</span> <span class="toc-text">死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81-1"><span class="toc-number">1.7.1.</span> <span class="toc-text">什么是死锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81%E6%80%8E%E4%B9%88%E5%8A%9E-1"><span class="toc-number">1.7.2.</span> <span class="toc-text">出现死锁怎么办</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%AD%89%E5%BE%85-1"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">死锁等待</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">死锁检测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E7%9A%84%E5%87%BA%E7%8E%B0%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.3.</span> <span class="toc-text">死锁的出现场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MDL%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">MDL锁的死锁场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">行锁的死锁场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">间隙锁的死锁场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#next-key-lock-%E7%9A%84%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.3.4.</span> <span class="toc-text">next-key lock 的死锁场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E6%9F%A5%E7%9C%8B%E6%AD%BB%E9%94%81"><span class="toc-number">1.7.4.</span> <span class="toc-text">怎么查看死锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81%E7%AD%89%E5%BE%85%EF%BC%88%E9%97%B4%E9%9A%99%E9%94%81%E8%8C%83%E5%9B%B4%E5%8F%98%E5%A4%A7%EF%BC%89"><span class="toc-number">1.8.</span> <span class="toc-text">锁等待（间隙锁范围变大）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%94%81%E7%AD%89%E5%BE%85"><span class="toc-number">1.8.1.</span> <span class="toc-text">什么是锁等待</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E7%AD%89%E5%BE%85%E7%9A%84%E5%87%BA%E7%8E%B0%E5%9C%BA%E6%99%AF"><span class="toc-number">1.8.2.</span> <span class="toc-text">锁等待的出现场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#delete%E8%AF%AD%E5%8F%A5%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%81%E7%AD%89%E5%BE%85%E5%9C%BA%E6%99%AF"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">delete语句导致的锁等待场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#update%E8%AF%AD%E5%8F%A5%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%81%E7%AD%89%E5%BE%85%E5%9C%BA%E6%99%AF"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">update语句导致的锁等待场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E6%9F%A5%E7%9C%8B%E9%94%81%E7%AD%89%E5%BE%85"><span class="toc-number">1.8.3.</span> <span class="toc-text">怎么查看锁等待</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E8%87%AA%E5%A2%9E%E9%94%81"><span class="toc-number">1.9.</span> <span class="toc-text">主键自增锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%BB%E9%94%AE%E7%9A%84%E8%87%AA%E5%A2%9E%E9%94%81"><span class="toc-number">1.9.1.</span> <span class="toc-text">什么是主键的自增锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E8%87%AA%E5%A2%9E%E9%94%81%E7%9A%84%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2"><span class="toc-number">1.9.2.</span> <span class="toc-text">主键自增锁的发展历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#insert%E8%AF%AD%E5%8F%A5%E7%9A%84%E9%94%81"><span class="toc-number">1.9.3.</span> <span class="toc-text">insert语句的锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#insert-into-%E2%80%A6-values-%E2%80%A6"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">insert into … values( … )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#insert-into-%E2%80%A6-select-%E2%80%A6"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">insert into … select …</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#insert-into-%E2%80%A6-on-duplicate-key-update-%E2%80%A6"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">insert into … on duplicate key update …</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AE%8B%E7%95%99%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.</span> <span class="toc-text">残留的问题</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By zs</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>